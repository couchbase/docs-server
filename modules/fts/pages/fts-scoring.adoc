[#scoring]
== Scoring

Search result scoring occurs at a query time. The result of the search request is ordered by *score* (relevance), with the descending sort order unless explicitly set not to do so.

For more details on tf-idf, refer xref:fts-scoring-tf-idf-how-it-works.adoc[tf-idf]

Couchbase uses a slightly modified version of the standard *tf-idf*  algorithm. This deviation is to normalize the score and is based on *tf-idf* algorithm.

By selecting the `explain score` option within the search request, you can obtain the explanation of how the score was calculated for a result alongside it.

[#fts_explain_scoring_option_enabled]
image::fts-td-idf-explain-scoring-enabled.png[,460,align=left]

Search query scores all the qualified documents for relevance and applies relevant filters. 

In a search request, you can set `score` to `none` to disable scoring by. See xref:fts-scoring-score-none.adoc[Score:none]

== Example

The following sample query response shows the *score* field for each document retrieved for the query request:

----
  "hits": [
    {
      "index": "DemoIndex_76059e8b3887351c_4c1c5584",
      "id": "hotel_10064",
      "score": 10.033205341869529,
      "sort": [
        "_score"
      ],
      "fields": {
        "_$c": "hotel"
      }
    },
    {
      "index": "DemoIndex_76059e8b3887351c_4c1c5584",
      "id": "hotel_10063",
      "score": 10.033205341869529,
      "sort": [
        "_score"
      ],
      "fields": {
        "_$c": "hotel"
      }
    }
  ],
  "total_hits": 2,
  "max_score": 10.033205341869529,
  "took": 284614211,
  "facets": null
}
----

== tf-idf

[abstract]
`tf-idf`, a short form of *term frequency-inverse document frequency*, is a numerical statistical value that is used to reflect how important a word is to a document in collection or scope. 

`tf-idf` is used as a weighting factor in a search for information retrieval and text mining. The `tf–idf` value increases proportionally to the number of times a word appears in the document, and it is offset by the number of documents in the collection or scope that contains the word.

Search engines often use the variations of `tf-idf` weighting scheme as a tool in scoring and ranking a document's relevance for a given query.

When bleve scores a document, it sums a set of sub scores to reach the final score. The scores across different searches are not directly comparable as the search query is also an input factor to the scoring function.

The more conjuncts/disjuncts/sub clauses in a query can influence the scoring. Also, the score of a particular search result is not absolute, which means you can only use the score as a comparison to the highest score from the same search result. 

FTS does not provide any predefined range for valid scores.

Below is the summary of the scoring function in the Search service:

Given a document that has a field f over which a given match query q is applied, then the scoreFn for that document is defined as:

[source,json]
----
scoreFn(q, f) = coord(q, f) * SUM(tw(t0, q, f), tw(t1, q, f), tw(t2, q, f)..., tw(tn, q, f))
where ti := term in q
coord(q, f) = nFoundTokens(q, f)/nTokens(q)
tw(ti, q, f) = queryWeight(q, f, ti) * fieldWeight(f, ti)
queryWeight(q, ti) = w(ti) * queryNorm(q)
w(ti) = boost(ti) * idf(ti)
queryNorm(q) = 1 / SQROOT(SUM(SQ(w(t0)),...,SQ(w(tn))))
fieldWeight(f, ti) = SQROOT(FREQ(ti, f))*idf(f, ti)*fieldNorm(f)
fieldNorm(f) = 1 / SQROOT(nTokens(f))
idf(f, ti) = 1 + LN(|Docs| / (1 + FREQ(ti, FIELDNAME(f), Docs)))
Docs = a set of all indexed documents
----

Where SQROOT, SUM, and LN denote standard mathematical functions. Auxiliary functions are:

* *coord(q, f)*  — is a dampening factor defined as a ratio of query tokens that are found in the given field and the total number of tokens in a query.
* *tw(ti, q, f)*  — *ti* ’s term weight is the product of  *ti* ’s query weight and ti’s field weight.
* *queryWeight(q, ti)*  —  *ti* ’s query weight (wrt to  *q* ) is the product of its https://en.wikipedia.org/wiki/Tf%E2%80%93idf[inverse document frequency] (see  *idf*  below) and its http://www.blevesearch.com/docs/Query-String-Query/[boosting factor].
* *queryNorm(q)*  — is used to normalize each query term’s contribution. It uses the https://en.wikipedia.org/wiki/Norm_(mathematics)#Euclidean_norm[Euclidean distance] as the normalization factor.
* *fieldWeight(f, ti)*  — is a normalized product of  *ti* ’s idf and the square root of its frequency.
* *FREQ(ti, f)*  — is the frequency of  *ti*  in the given field  *f* .
* *fieldNorm(f)*  — normalizes each (in  *f* ) term’s contribution to the score. The normalization factor is the square root of the number of distinct terms in  *f.*  (Note that  *f* ’s terms may and may not be part of  *q.* )
* *idf(f, ti)*  — a dampening factor that favors terms that have a high frequency in a small set of fields but not across the whole indexed (document) set.
* *FREQ(ti, FIELDNAME(f), Docs)*  —frequency of  *ti*  across all documents’ fields that have the same ID/Name as  *f* .

Bleve's tf-idf scoring variant differs from the standard  *textbook*  functions (see http://nlp.stanford.edu/IR-book/html/htmledition/queries-as-vectors-1.html[Intro to Information Retrieval]):  mainly in these points.

1. Term frequency is augmented with the square root function.
2. The idf function is “ *inverse document frequency smooth* ” (due to the (1+) factor). Note that it is present in both the query weight and the field weight.
3. The normalization factors are different for the field weight (a variant of the  *byte size*  normalization) and the query weight ( *Euclidean* ).
4. The coordination factor, which is often not present by default, can have an impact on scores for small queries.

In Couchbase application, you get an option to explore the score computations during any search in FTS.

[#fts_explain_scoring_option]
image::fts-td-idf-explain-scoring.png[,320,align=left]

On the Search page, you can search for a term in any index. The search result displays the search records along with the option *Explain Scoring* to view the score deriving details for search hits and which are determined by using the `tf-idf` algorithm.

[#fts_explain_scoring_option_enabled]
image::fts-td-idf-explain-scoring-enabled.png[,460,align=left]

== Score:none

You can disable the scoring by setting `score` to `none` in the search request. This is recommended in a situation where scoring (document relevancy) is not needed by the application.

NOTE: Using `"score": "none"` is expected to boost query performance in certain situations. 

== Example

----
{
  "query": {
      "match": "California",
      "field": "state"
  },
  "score": "none",
  "size": 100
}
----

== Scoring Tips and Recommendations

For a select term, FTS calculates the relevancy score. So, the documents having a higher relevancy score automatically appear at the top in the result. 

It is often observed that users are using Full-Text Search for the exact match queries with a bit of fuzziness or other search-specific capabilities like geo. 

Text relevancy score does not matter when the user is looking for exact or more targeted searches with many predicates or when the dataset size is small.

In such a case, FTS unnecessarily uses more resources in calculating the relevancy score. Users can, however, optimize the query performance by skipping the scoring. Users may skip the scoring by passing a “score”: “none” option in the search request. 

== Example
{
 
 "query": {},
 "score": "none",
 "size": 10,
 "from": 0

}

This improves the search query performance significantly in many cases, especially for composite queries with many child search clauses.