= Upgrade a Full-Capacity, Online Cluster

:description: A cluster can be upgraded while still online; and maintained at full capacity.
//:page-aliases: install:upgrade-strategy-for-features
:tabs:

[abstract]
{description}

[#online-upgrade-with-full-capacity]
== Understanding Full-Capacity Upgrade

The context and overall requirements for upgrading a live cluster by means of the introduction of one or more additional nodes are described in xref:install:upgrade-strategies.adoc[Upgrade-Procedure Selection]: this fully explains the node-by-node upgrade of the cluster, using _swap rebalance_ to minimize overhead.
It also explains how, if additional nodes are available, the procedure can be completed with cluster performing at full capacity, during the upgrade.

The precise steps for this procedure are detailed on this page, below.
A full understanding of the information in xref:install:upgrade-strategies.adoc[Upgrade-Procedure Selection] should be acquired, before proceeding.

[#perform-upgrade-with-full-capacity]
== Perform a Full-Capacity Upgrade

The following procedure assumes that:

* The cluster to be upgraded must continue to serve data throughout the cluster-upgrade process.

* A single, additional node is available; to act as a _swap_ node.
The node _either_ has not previously run Couchbase Server, _or_ has run a version that can, with all its configuration files and other data, be overwritten: therefore, the latest version of Couchbase Server will be installed on the node.
(Prior to installation, if necessary, remove any old configuration files from `/opt/couchbase`, using the command `rm -r /opt/couchbase`.)

* During the cluster-upgrade process, _swap_ nodes and _upgraded_ nodes will be introduced to the cluster by the _node-addition_ procedure; while _failed over spare nodes_ and _nodes to be upgraded_ will be withdrawn from the cluster by means of the _node removal_ and _swap rebalance_ procedures.
+
For information on node-addition, see xref:learn:clusters-and-availability/nodes.adoc#clusters[Clusters].
For information on node-removal, see xref:learn:clusters-and-availability/removal.adoc[Removal].
For information on _swap rebalance_, see xref:install:upgrade-strategies.adoc#swap-rebalance[Swap Rebalance].

* Nodes will be upgraded _one at a time_.

Proceed as follows:

. Install the latest version of Couchbase Server on the spare node.
For instructions, see xref:install:install-intro.adoc[Install]; and follow steps 1, 2, and 3.

. Back up all cluster-data.
This can be performed either with xref:backup-restore:enterprise-backup-restore.adoc[cbbackupmgr] or with the xref:learn:services-and-indexes/services/backup-service.adoc[Backup Service]; and should be a _full_ (rather than an incremental) backup.
+
For example, to use `cbbackupmgr` to configure an archive and repository for the backup, a command of the following form should be entered:
+
[source,bash]
----
cbbackupmgr config --archive ${ABS_PATH_TO_ARCHIVE} --repo ${REPO_NAME}
----
+
Here, `ABS_PATH_TO_ARCHIVE` is an absolute path to a filesystem location that will serve as the archive within which the backed up data will reside.
The `REPO_NAME` is the name of the repository that will be associated with the location.
+
Once the archive and repository have been created, a command such as the following performs a full backup:
+
[source,bash]
----
cbbackupmgr backup --archive ${ABS_PATH_TO_ARCHIVE} --repo ${REPO_NAME} \
--cluster ${CLUSTER_ADDRESS} --username ${USERNAME} --password ${PASSWORD} \
--full-backup
----
+
Here, the `CLUSTER_ADDRESS` is the IP address or domain name of the cluster that is being backed up.
The `full-backup` flag ensures that the backup is indeed a _full_ backup.
+
For the equivalent procedure as performed by the Backup Service, see xref:manage:manage-backup-and-restore/manage-backup-and-restore.adoc#run-an-immediate-backup[Run an Immediate Backup].

. _Add_ the upgraded spare node to the cluster, and _remove_ a node that is currently part of the cluster.
+
For an overview of node-removal, see xref:learn:clusters-and-availability/removal.adoc[Removal]; and for practical examples of performing removal, see xref:manage:manage-nodes/remove-node-and-rebalance.adoc[Remove a Node and Rebalance].
For an overview of node-addition, see xref:learn:clusters-and-availability/nodes.adoc#clusters[Clusters]; and for practical examples of node-addition, see xref:manage:manage-nodes/add-node-and-rebalance.adoc[Add a Node and Rebalance].
+
Note that in this case, no rebalance should be performed until both the addition and the removal are complete.
+
During node-addition, the added node should be given the same configuration as the node to be removed: this ensures that when the subsequent rebalance occurs, Couchbase Server implements it as a _swap rebalance_; which results in the most efficient rebalance.
For example, if the node to be removed is running the Data Service, the node to be added should be configured to run the Data Service; and if the node to be removed is running the Search Service, the node to be added should be configured to run the Search Service.
If multiple services are running on the node to be removed, the same services should be configured to run on the added node.

. Disable the `couchbase-server.service` service, on the node that has been removed.
Enter the following command:
+
----
systemctl stop couchbase-server.service
----
+
This _stops_ the service; and so allows it to be restarted after reboot.

. Back up the configuration files for the removed node.
On a Linux system, these files are to be found in `/opt/couchbase/var/lib/couchbase/config`.
Ideally, these should be backed up onto a different machine.
The command takes the following form:
+
----
cp -r /opt/couchbase/var/lib/couchbase/config ${PATH_TO_A_SAFE_LOCATION}/${NODE_IP}_config_files
----

. Uninstall `couchbase-server` and its dependencies from the removed node.
Enter the command that is appropriate for the platform.
Note that the following examples remove _Enterprise Edition_ of Couchbase Server: to remove _Community Edition_, specify `couchbase-server-community` (instead of `couchbase-server`).
+
[{tabs}]
====
RedHat & Centos::
+
--

----
yum autoremove couchbase-server
----

--

Ubuntu & Debian::
+
--

----
apt autoremove --purge couchbase-server
----

--
====

. Manually remove files from `/opt/couchbase`.
This folder contains configuration files for the previous server-version; which need to be overwritten by configuration files for the new version.
If the administrator has manually included in this folder any files that were not provided by Couchbase Server, and need to be retained, these should be individually identified and backed up with with xref:backup-restore:enterprise-backup-restore.adoc[cbbackupmgr] or with the xref:learn:services-and-indexes/services/backup-service.adoc[Backup Service].
+
Note that, based on settings made for this node when it was originally added or joined to the cluster, `/opt/couchbase` may also have contained _user data_, in the form of xref:learn:buckets-memory-and-storage/vbuckets.adoc[vBuckets]: however, since this node has been rebalanced out of the cluster, user data has been automatically copied off this node onto nodes that still remain in the cluster, as appropriate; and therefore, on this node, the folder `/opt/couchbase` now contains no user-data that needs to be manually backed up.
+
Enter the following command:
+
----
rm -r /opt/couchbase
----

. Install Couchbase Server.
Follow the per platform instructions provided in xref:install:install-intro.adoc[Install].

. Put automated Couchbase-Server updates for the node on _hold_.
This ensures that no further upgrade can occur to this node until the next time the administrator manually performs the process.
+
[{tabs}]
====

RedHat & Centos::
+
--
For Couchbase Server Enterprise Edition, add the following to the file `/etc/yum/yum.conf`:

----
exclude=couchbase-server
----

(For Couchbase Server Community edition, specify `couchbase-server-community`, instead of `couchbase-server`).

--

Ubuntu & Debian::
+
For Couchbase Server Enterprise Edition, run the following command:
+
----
apt-mark hold couchbase-server
----
+
(For Couchbase Server Community edition, specify `couchbase-server-community`, instead of `couchbase-server`).

--
====

. _Add_ the newly upgraded node back into the cluster, and _remove_ the previously added spare node.
+
For an overview of node-removal, see xref:learn:clusters-and-availability/removal.adoc[Removal]; and for practical examples of performing removal, see xref:manage:manage-nodes/remove-node-and-rebalance.adoc.
For an overview of node-addition, see xref:learn:clusters-and-availability/nodes.adoc#clusters[Clusters]; and for practical examples of node-addition, see xref:manage:manage-nodes/add-node-and-rebalance.adoc[Add a Node and Rebalance].
+
Note that in this case, no rebalance should be performed until both the addition and the removal are complete.
When the rebalance is performed, it is performed by Couchbase Server as a _swap rebalance_; confining rebalance activities only to the two nodes affected, and therefore heightening efficiency.

. _Add_ the spare node back into the cluster, and remove a non-upgraded node that is currently part of the cluster.
During the configuration routine, give the node that is being added the same configuration as that of the node that is to be removed.
For example, if the node to be removed is running the Data Service, configure the node to be added to run the Data Service.
When addition and removal are complete, perform a rebalance.
Couchbase Server will perform the rebalance as a _swap rebalance_, and so maximize the efficiency of the rebalance process.
+
All previous configuration and other data on the added spare node are deleted by the process of addition.

. Upgrade the newly removed node as previously.
Continue to upgrade nodes in this way until the cluster is fully upgraded.
