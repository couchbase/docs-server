= Couchbase Server Quickstart - Upsert and Lookup via Ottoman 2.6 & NodeJS SDK 2.6
:imagesdir: ../assets/images
:sourcedir: ../examples

[abstract]
Before we get started with Ottoman, we need to ensure you have Couchbase up and running with a data bucket  and a few indexes in place so that we can do basic queries. Using SQL syntax and the Couchbase Query Workbench, we will take care of creating those indexes, you don't need to know much about them for the quickstart, just know that we need them so that after we create and upsert a few documents we can turn around and look them up with the query API in Ottoman. 

== Prerequisites: Three Steps required to Query our Bucket

1. Setup Couchbase Server 6.5 and ensure it is running.

2. Create an empty bucket named "default".

3. Add a primary and adaptive index for our default bucket.

If you still need to perform these tasks please use one of the following:

* xref:quickstart-docker-image-manual-cb65-for-ottoman.adoc[5-minute Couchbase Docker Container Configuration]

== Step 1: Create The Ottoman NodeJS Project

In this exercise, we will be working with the Ottoman ODM (Object Document Mapper) in conjunction with the link:https://docs.couchbase.com/nodejs-sdk/2.6/start-using-sdk.html[NodeJS SDK v2.6]. Currently, Ottoman can use Couchbase NodeJS SDK vesion 2.6, but does not yet support the latest version 3 the SDK with added support for collections. 

NOTE: you can get to the Couchbase Server Web UI at anytime by visiting link:localhost:8091[http://localhost:8091]. 

WIth Couchbase Server up and running we can create our project directory for our NodeJS application that will be using Couchbase SDK and Ottoman.

```sh
mkdir first-query-ottoman && cd $_ && npm init -y && npm install couchbase ottoman && touch server.js && code .
```

This command has setup a project directory and enabled npm, installed couchbase and ottoman as well as created a `server.js` file and finally opened up our VS Code editor to the project root. 

Let's open that `server.js` file, this is where we'll be adding our code.

Taking each code sample below, we will add each new block of code done after one another.

== Connecting to a Couchbase Bucket

Create a connection to our Couchbase Server running in Docker. Your password may be different, just swap out yours if it is different.

```js
var ottoman = require('ottoman')
var couchbase = require('couchbase')

var cluster = new couchbase.Cluster('localhost:8091')

cluster.authenticate('Administrator', 'password')
ottoman.bucket = cluster.openBucket('default')
```

== Creating an Ottoman Model

Create a model for our `User` document. It will get auto-created and stored in our already created `default` bucket in Couchbase. Once our model is setup, we can add a few initial documents to populate our bucket.

```js
var User = ottoman.model('User', {
  firstName: 'string',
  lastName: 'string',
  email: 'string',
  lyric: 'string'
})
```

This is a very simple model with only a four fields, but we are starting simple on purpose. Just know that Ottoman supports many other types like `boolean`, integer`, and `Date` and a model can also help you setup indexes similar to the ones we setup manuallyin our database. but for now, we are going to not let Ottoman handle our indexes as we already have ones that will work just fine for this simple quickstart. 

== Create New User Documents

Here we are defining a few documents that we want to persist to our bucket, notice we are using the same document that we defined in our model.

```js
var user_perry = new User({
  firstName: 'Perry',
  lastName: 'Mason',
  email: 'perry.mason@acme.com',
  lyric: 'Who can we get on the case?',
})
var user_tom = new User({
  firstName: 'Major',
  lastName: 'Tom',
  email: 'major.tom@acme.com',
  lyric: 'Send me up a drink',
})
var user_jerry = new User({
  firstName: 'Jerry',
  lastName: 'Wasaracecardriver',
  email: 'jerry.wasaracecardriver@acme.com',
  lyric: 'el sob number one',
})
```

== Persist Documents to Our Bucket

Call Ottoman's `save()` method on each of these objects which will add them to our database so long as no errors occur.

```js
user_perry.save((err) => {
  if (err) throw err
  console.info(`success: user ${user_perry.firstName} added!`)
})
user_tom.save((err) => {
  if (err) throw err
  console.info(`success: user ${user_tom.firstName} added!`)
})
user_jerry.save((err) => {
  if (err) throw err
  console.info(`success: user ${user_jerry.firstName} added!`)
})
```

With the `save()` method added, let's run our app. You should get one success message in the console and no errors.

== Our First Query

When we use Ottoman, and create a model, then persist documents to the database using the `save()` method, we can then use a `find()` method like below in conjunction with the Adaptive Index that was creatd during our database setup.

```js
User.find({ lastName: 'Tom' }, { consistency: ottoman.Consistency.LOCAL },
   (err, items) => {
    if (err) throw err
    console.log('Finding Tom and Jerry: ', JSON.stringify(items))
  }
)
```

The first two arguments to the `find()` method are our filter and options, let's look at it a little bit differently:

```js
var filters = { 
  lastName: 'Tom'
}

var options = {
  consistency: ottoman.Consistency.LOCAL
}

User.find(filters, options,
   (err, items) => {
    if (err) throw err
    console.log('Found Tom and Jerry: ', JSON.stringify(items))
  }
)
```

NOTE: If we had a lot more data and we were expecting hundreds of records to be returned, we could page the results with our options to get the second page (pagination), like this:

```js
var options = {
  limit: 10,
  skip: 10
  consistency: ottoman.Consistency.LOCAL
}
```

== Summary

We have created models in Ottoman, defined some documents, and persited them to the database. We then subsequently looked them up using the built in `find()` method which used the Ottoman Query API for Couchbase. We have not yet touched on indexes other than the fact that we created two of them during the docker and indexes section of the quickstart.

NOTE: If those indexes were not present, if we had not set them up or let Ottoman do it for us (an option we did not explore yet) we would get an error when running our application upon query:

```sh
"errors": [
  {
    "code": 4000,
    "msg": "No index available on keyspace default that matches your query. Use CREATE INDEX or CREATE PRIMARY INDEX to create an index, or check that your expected index is online."
  }
]
```

== Exercise Complete

Congratuations!  You have substantially engaged with the world's most powerful JSON document database using the most advanced SQL++ query technology. Know that our query language N1QL was run under the hood to but we did not have to write any N1QL yet. That's pretty powerful, Ottoman did all the heavy lifting for us!