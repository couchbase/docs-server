= Couchbase Quickstart
:imagesdir: ../assets/images

This section enables you to quickly get started with Couchbase. It is assumed that you have familiarity with relational databases and NoSQL/document databases.

In this quickstart, you will learn how to:

*	Create a cluster and load a sample bucket
*	Use the Python SDK to perform basic CRUD and additional operations.

== Start the Couchbase Server

Start Couchbase Server from the terminal using the command:

----
open /Applications/Couchbase\ Server.app
----

This enables you to use Couchbase Server as a non-sudo, non-root user.

== Create a Cluster

You can create a Couchbase cluster using the `node-init` command and associated settings commands.

----
couchbase-cli node-init
    --cluster your-cluster-name
    --username your-username
    --password your-password
----

Ensure you replace the following with your specific information:

*	`your-cluster-name`: The name for your cluster.
*	`your-username`: The username to log into your cluster.
*	`your-password`: The password to log into your cluster.

== Load a Sample Bucket
Couchbase includes a number of sample buckets that you can use to experiment with. Throughout this quickstart, we use the _beer-sample_ bucket, which must be installed.

Follow the steps below to install the _beer-sample_ bucket:

1. Access the Web console using the URL `http://localhost:8091` using a supported web browser. The initial sample Couchbase Server administrator user credentials are:
*	**Username**: Administrator
*	**Password**: password
2. Navigate to the **Settings** screen in the Couchbase Web Console.
3. Click **Sample Buckets**.
4. Locate the **beer-sample** bucket, and enable its checkbox.

image::sampleBuckets.png[,720,align=left]

[start=5]
5. Click **Load Sample** Data.
6. Navigate to the **Buckets** screen in the Couchbase Web Console and verify that a row has been added for beer-sample:

image::beerSampleBucketRow.png[,720,align=left]

== Access a Bucket using Python

The following sample Python application shows how to access the beer-sample bucket using the Python SDK.

1. Copy and paste the following code into a file called `connect.py`:

[source,python]
----
# these modules are used to access and authenticate with your database cluster:
from couchbase.cluster import Cluster
from couchbase.cluster import PasswordAuthenticator

# specify the database to access:
cluster = Cluster('couchbase://localhost')

# to connect to a Couchbase bucket, you must use Couchbase Role-Based Access Control (RBAC).
# an authenticator containing a username and password must be defined and passed to the
# cluster.
authenticator = PasswordAuthenticator('Administrator', 'Administrator')

# pass the authentication credentials to the cluster
cluster.authenticate(authenticator)

# following a successful authentication, a bucket can be opened.
# access a bucket in that cluster
bucket = cluster.open_bucket('beer-sample')
----

[start=2]
2. Navigate to your `connect.py` file using the `cd` command.
3. Execute the following command to run the application: `python connect.py`.
4. Retain this document for the remainder of this quickstart. This script will serve as the base for CRUD and additional operations in this section.

== Implement Python CRUD operations

=== Create

Documents are created using the `Bucket.insert()` and `Bucket.insert_multi()` methods. A bucket must exist on the Couchbase Server before documents can be added to it.

1. To insert a single document, append the following Python script to your base `connect.py` file.

[source,python]
----
beerDocument = {"abv": 4.2,
      "brewery_id": "21st_amendment_brewery_cafe",
      "category": "America Ale",
      "description": "Traditional Style Ale",
      "ibu": 0,
      "name": "A new Test Beer",
      "srm": 0,
      "style": "Special Bitter",
      "type": "beer",
      "upc": 0
    }


rv = bucket.insert('newDoc', beerDocument)
print rv
----

* The `beerDocument` is defined as a series of JSON key-value pairs.
* The `newdoc` is the name of the document you want to create.

[start=2]
2. Execute `python connect.py` to run the application.
3. Running this script will show the result returning the document you inserted, `newDoc` as the key.

----
OperationResult<RC=0x0, Key=u'newDoc', CAS=0x707339a4125aaa13>
----

=== Read

The method for retrieving documents is `get()`, `get_in()` and `retrieve_in()`.

1. To select a specific document from a bucket based on the key that it was associated with when it was inserted, append the following Python script to your base `connect.py` file. The following example selects an existing document from the _beer-sample_ bucket that is associated with the key `newDoc`:

[source,python]
----
rv = bucket.get('newDoc')
print(rv.value)
----

[start=2]
2. Execute `python connect.py` to run the application.
3. The `get()` method will return a `Result` object containing the results of the specified document:

[source,jsonDocument]
----
{u'brewery_id': u'21st_amendment_brewery_cafe', u'category': u'America Ale', u'style': u'Special Bitter', u'description': u'Traditional Style Ale', u'upc': 0, u'srm': 0, u'abv': 5.2, u'type': u'beer', u'ibu': 0, u'name': u'Test Beer'}
----

=== Update

Documents may be updated using the `Bucket.upsert()`, `Bucket.insert()`, and `Bucket.replace()`, and `Bucket.mutate_in()` methods.

1. To replace an existing document, append the following Python script to your base `connect.py` file. The following example replaces an existing document in the _beer-sample_ bucket associated with the key `newDoc`. If the document doesn’t exist, Couchbase will not perform a replacement operation.

[source,python]
----
beerDocument2 = {"abv": 5.2,
      "brewery_id": "21st_amendment_brewery_cafe",
      "category": "American Ale",
      "description": "A Traditional Style Ale",
      "ibu": 0,
      "name": "Test2 Beer",
      "srm": 0,
      "style": "Special Bitter",
      "type": "beer",
      "upc": 0
    }

rv = bucket.replace('newDoc', beerDocument2)
print(rv)
----

[start=2]
2. Execute `python connect.py` to run the application.
3. The `replace()` method will return a `Result` object containing the results of the operation:

----
OperationResult<rc=0x0, key=u'mybeer2', cas=0x15ea328ad26d0000, tracing_context=0, tracing_output={'c': '00000000000041a7/0000000010d63af1', 'b': 'beer-sample', 'i': 1144108930L, 'l': '127.0.0.1:64717', 's': 'kv:Unknown', 'r': 'localhost:11210', 't': 2500000L}>
----

=== Delete

1. To remove a single existing document,  append the following Python script to your base `connect.py` file. The following example removes an existing document in the beer-sample bucket, associated with the key `newDoc`:

[source,python]
----
rv = bucket.remove('newDoc')
print(rv)
----

[start=2]
2. Execute `python connect.py` to run the application.
3. The `remove()` method will return a `Result` object containing the results of the operation:

----
OperationResult<rc=0x0, key=u'mybeer', cas=0x15ea33fd37d80000, tracing_context=0, tracing_output={'c': '00000000000041a7/0000000010d63af1', 'b': 'beer-sample', 'i': 1144108930L, 'l': '127.0.0.1:51450', 's': 'kv:Unknown', 'r': 'localhost:11210', 't': 2500000L}>
----

== Implement Additional Operations using Python

=== First Secondary Lookup

Couchbase provides _primary_ https://docs.couchbase.com/server/4.5/indexes/indexing-overview.html[index] capabilities that, as with other databases, dictate how the underlying data is organized based on the primary key. In addition to primary indexes, you can also create _secondary_ indexes that enable fast lookups for specific https://docs.couchbase.com/server/4.5/getting-started/first-n1ql-query.html[N1QL] queries, without impacting the organization of the data.

1. To create a secondary index,  append the following Python script to your base `connect.py` file. The following example shows how to create a secondary index on brewery documents in the _beer-sample_ bucket, that have a geographical latitude of less than 40:

[source,python]
----
# create the secondary index
rv=bucket.n1ql_query('CREATE INDEX breweryIndex ON `beer-sample`(geo.lat) WHERE geo.lat < -40 USING GSI WITH {"nodes": ["127.0.0.1:8091"]}')

print(rv)
----

**Note**: The query includes the `USING GSI WITH` clause, specifying the domain where the database is hosted, for which to create the secondary index. In this example, the Python script is being executed on the local host, so its local IP address, along with Couchbase’s default port (8091), are specified.

[start=2]
2. Execute `python connect.py` to run the application.
3. The `remove_multi()` method will indicate the creation of the index:

----
<couchbase.n1ql.N1QLRequest object at 0x10ee08f50>
----

Any subsequent queries, such as the following, that search for breweries with a latitude of less than 40, will execute faster because of the secondary index:

[source,python]
----
for row in bucket.n1ql_query('SELECT * FROM `beer-sample` WHERE geo.lat < -40'):
   print(row)
----


=== First JOIN

A https://docs.couchbase.com/server/6.5/n1ql/n1ql-language-reference/join.html[join] combines two or more source objects.

1. To run a join statement, append the following Python script to your base `connect.py` file. The following Python example shows how to perform this join using an N1QL query in Python. In this example, the join lists all beers in the _beer-sample_ bucket that are manufactured by the brewery “21st Amendment Brewery Cafe”:

[source,python]
----
# execute the query to perform a join
for row in bucket.n1ql_query('SELECT br.name brewery, b.name name, b.style style FROM `beer-sample` b JOIN `beer-sample` br ON KEYS b.brewery_id WHERE br.name = "21st Amendment Brewery Cafe" order by style'):
   print(row)
----

[start=2]
2. Execute `python connect.py` to run the application.
3. The output lists the beer styles, along with their brewery names, which have been joined. The output is also ordered alphabetically due to the inclusion of the order by `style` clause:

[source,jsonDocument]
----
{u'style': u'American-Style Amber/Red Ale', u'brewery': u'21st Amendment Brewery Cafe', u'name': u'North Star Red'}
{u'style': u'American-Style India Pale Ale', u'brewery': u'21st Amendment Brewery Cafe', u'name': u'21A IPA'}
{u'style': u'American-Style Pale Ale', u'brewery': u'21st Amendment Brewery Cafe', u'name': u'Amendment Pale Ale'}
{u'style': u'American-Style Stout', u'brewery': u'21st Amendment Brewery Cafe', u'name': u'563 Stout'}
----

=== First Full Text Search

The Couchbase Web Console provides the ability to perform searches for documents based on arbitrary text strings built around specific search indexes. The results returned include the JSON for the documents found, which you can directly modify via the web console. This _Full Text Search_ feature can be useful during development, to quickly locate and update documents without having to write more complex queries.

**Note**: Before continuing, ensure you have loaded the beer-sample bucket.

1. Access the Web console using the URL `http://localhost:8091` using a supported web browser.
2. Click on the **Search** tab in the navigation bar on the left-hand side to access the **Full Text Search** screen.

image::searchTab.png[,720,align=left]

Before you can execute text searches, you must first create a full text index to enable those searches on a bucket.

[start=3]
3. Click **Add Index** towards the right-hand side. The **Add Index** screen appears:

image::addIndexScreen.png[,720,align=left]

[start=4]
4. Enter a unique name (e.g., `beer-sample-index`) for the index into the **Name** field at the upper-left and select **beer-sample** from the **Bucket** dropdown.
5. Click **Create Index** to save your index. Couchbase will start building the index and display the build progress. When the build completes, the screen will display a new row for text searches on the newly-created index:

image::newIndex.png[,720,align=left]

**Note**: The index can be used from the Full Text Search Screen, via the Couchbase https://docs.couchbase.com/server/current/rest-api/rest-endpoints-all.html[REST API], and via the Couchbase https://docs.couchbase.com/server/6.5/sdk/overview.html[SDK’s].

Now you can perform a text search.

[start=6]
6. On the **Full Text Search** screen, enter a term into the search field and click **Search**. The search results include the list of document ID’s found by the search.

image::searchingText.png[,720,align=left]

7. Click on any of the document ID’s in the list to display the JSON for that document:

image::jsonDocument.png[,720,align=left]

=== First Transaction

Todo -awaiting info about transaction exceptions

For more information on managing a Couchbase Server, creating clusters and buckets, and the types of operations you can perform, please see the Getting Started Guide below.

=== First Sub Document Operation

JSON documents are hierarchical, meaning they can contain child documents known as _sub documents_.

For example, in the _beer-sample_ bucket, a *brewery* document contains a geo sub document that describes the location of the brewery:

[source,jsonDocument]
----
{
  "address": ["636 East Main Street"],
  "city": "Louisville",
  "code": "40202",
  "country": "United States",
  "description": "Bluegrass Brewing Co is proud to ...",
  "geo": {
    "accuracy": "ROOFTOP",
    "lat": 38.2546,
    "lon": -85.7401
  },
  "name": "BBC Brewing Co., LLC",
  ...
}
----

Couchbase includes sub document APIs that allow you to directly access sub documents. These APIs reduce the amount of data transferred, since only the sub document needs to be transmitted.

1. To find the geo sub object for a brewery named _bbc_brewing_co_llc_ use of the `https://docs.couchbase.com/sdk-api/couchbase-python-client-2.2.4/api/couchbase.html#couchbase.bucket.Bucket.lookup_in[lookup_in()]` method:

**Note**: You must `import couchbase.subdocument` to use the sub document APIs.

[source,python]
----
from couchbase.cluster import Cluster
from couchbase.cluster import PasswordAuthenticator

# include this to use the sub document APIs
import couchbase.subdocument as SD

# connect to and authenticate with the Couchbase cluster running on the local host
cluster = Cluster('couchbase://localhost')
authenticator = PasswordAuthenticator('Administrator', 'Administrator')
cluster.authenticate(authenticator)

bucket = cluster.open_bucket('beer-sample')

rv = bucket.lookup_in('bbc_brewing_co_llc', SD.get('geo'))
print(rv[0])
----

[start=2]
2. The output displays the fields of the brewery’s geo object:

----
{u'lat': 38.2546, u'lon': -85.7401, u'accuracy': u'ROOFTOP'}
----

=== First Bulk Data Operation

https://docs.couchbase.com/python-sdk/2.0/bulk-operations.html[Bulk operations] allow you to perform multiple operations via a single API call, which can increase performance.

1. To insert or update multiple brewery documents in the _beer-sample_ bucket, use the `https://docs.couchbase.com/sdk-api/couchbase-python-client-2.2.4/api/couchbase.html#couchbase.bucket.Bucket.upsert_multi[upsert_multi()]` method:

[source,python]
----
from couchbase.cluster import Cluster
from couchbase.cluster import PasswordAuthenticator

# connect to and authenticate with the Couchbase cluster running on the local host
cluster = Cluster('couchbase://localhost')
authenticator = PasswordAuthenticator('Administrator', 'Administrator')
cluster.authenticate(authenticator)
bucket = cluster.open_bucket('beer-sample')

rvs = bucket.upsert_multi({
    '21st_amendment_brewery_cafe': '{ "address": ["563 Second Street2"], }',
    'abbaye_de_maredsous': '{ "address": ["Rue de Maredsous, 12"], }'
})
print(rvs)
----

[start=2]
2. The output lists the results of the operation. In this example, multiple documents were updated:

----
{u'21st_amendment_brewery_cafe': OperationResult<rc=0x0, key=u'21st_amendment_brewery_cafe', cas=0x15eca62da1810000, tracing_context=0, tracing_output={'c': '00000000000041a7/0000000010d63af1', 'b': 'beer-sample', 'i': 1144108930L, 'l': '127.0.0.1:65248', 's': 'kv:Unknown', 'r': 'localhost:11210', 't': 2500000L}>, u'abbaye_de_maredsous': OperationResult<rc=0x0, key=u'abbaye_de_maredsous', cas=0x15eca62da1830000, tracing_context=0, tracing_output={'c': '00000000000041a7/0000000010d63af1', 'b': 'beer-sample', 'i': 101027544L, 'l': '127.0.0.1:65248', 's': 'kv:Unknown', 'r': 'localhost:11210', 't': 2500000L}>}
----

_For more information on managing a Couchbase Server, creating clusters and buckets, and the types of operations you can perform, please see the Getting Started Guide._
