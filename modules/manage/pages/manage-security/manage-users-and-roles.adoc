= Manage Users and Roles
:page-aliases: security:security-rbac-user-management,security:security-rbac-for-admins-and-apps

[abstract]
Couchbase RBAC allows defined _users_ to be assigned roles, which permit access to resources.

[#creating-and-managing-users]
== Creating and Managing Users

The administrator who initially performs installation and configuration of Couchbase Server is granted the role of _Full Administrator_, with read-write access to the entire system.
Once basic system-configuration has been completed, the Full Administrator is free to add other users to the system, and assign them roles; thereby specifying their access-privileges.

As Full Administrator, to add _users_ (each of which might be either an _administrator_ or an _application_) to Couchbase Server, use xref:manage:manage-security/manage-users-and-roles.adoc#manage-users-with-the-ui[Couchbase Web Console], the xref:manage:manage-security/manage-users-and-roles.adoc#manage-users-with-the-cli[CLI], or the xref:manage:manage-security/manage-users-and-roles.adoc#manage-users-with-the-rest-api[REST API].
Examples are provided below, for each.

[#manage-users-with-the-ui]
== Manage Users with the UI

Access the [.ui]*Dashboard* of Couchbase Web Console, and left-click on the [.ui]*Security* tab, on the vertical navigation-bar, at the left.
This brings up the [.ui]*Security* view, as follows:

[#security_view]
image::manage-security/securityView.png[,820,align=left]

The [.ui]*Security* view allows users to be defined, and roles to be allocated to them.
It also allows management of the [.ui]*Root* and [.ui]*Client* certificates; of [.ui]*Audit*-processing; of [.ui]*Log Redaction*; and of [.ui]*Session* timeouts.

Note that in some cases, the following notification may appear towards the upper left:

[#external_auth_not_enabled]
image::manage-security/externalAuthNotEnabled.png[,250,align=left]

This indicates that the ability to define users externally by means of `saslauthd` has not yet been enabled.
To enable, use the CLI command xref:cli:cbcli/couchbase-cli-setting-saslauthd.adoc[setting-saslauthd], specifying a value of `1` for the `--enabled` flag. For example:

----
couchbase-cli setting-saslauthd -c 10.143.192.101 \
--username Administrator \
--password password \
--enabled 1
----

This changes the notification to the following:

[#external_auth_enabled]
image::manage-security/externalAuthEnabled.png[,250,align=left]

Note that setting `saslauthd` is not required if _Native LDAP_ has been configured: see xref:manage:manage-security/configure-ldap.adoc[Configure LDAP] for details.
For a general overview of external authentication, see
xref:learn:security/authentication-overview.adoc#introduction-to-externally-based-authentication[Externally Based Authentication].

To add a user, left-click on the [.ui]*Add User* control, at the upper right.
The [.ui]*Add New User* dialog now appears:

[#manage_user_new]
image::manage-security/addNewUserDialogInitial.png[,420,align=left]

[#add-a-locally-authenticated-user]
=== Add a Locally Authenticated User

The [.ui]*Authentication Domain* panel features two checkboxes: one specifying [.ui]*Couchbase*, the other [.ui]*External*.
By default, [.ui]*Couchbase* is checked: this means that the user will be defined locally, and that a password for the user must therefore be created, using the [.ui]*Password* fields displayed on the dialog.

Add a locally authenticated user, by adding appropriate entries into the [.ui]*Username* and [.ui]*Password* fields.
See xref:learn:security/usernames-and-passwords.adoc[Usernames and Passwords] for requirements.
The [.ui]*Full Name* field may be left blank.

[#adding-roles]
==== Adding Roles

Roles can be specified by checking checkboxes in the [.ui]*Roles* panel, which is displayed by default:

[#add_new_user_dialog_roles_panel]
image::manage-security/addNewUserDialogRolesPanel.png[,280,align=left]

Roles are arranged in groups.
The first group, which appears at the top of the panel, is for *Administration & Global Roles*: these roles are either administrative, or involve access to cluster-wide features.
Subsequent groups appear below the first: each consists of roles that are applied _per bucket_.
By default, a single subsequent group is displayed, *All Buckets (&#42;)*.
Each individual bucket defined on the cluster is represented below *All Buckets (&#42;)*, with its own hierarchy of roles.
This allows each individual user to be assigned roles that apply either to all buckets defined on the cluster, or to specified, individual buckets.
Left-click on the corresponding right-pointing arrowhead to display a group's contents, scrolling down if necessary:

[#all_buckets_checkboxes]
image::manage-security/allBucketsCheckboxes.png[,280,align=left]

To display roles at lower levels of the *All Buckets (*)* hierarchy, left-click on the right-pointing arrowheads.

To assign roles to the user, simply check the appropriate checkboxes.
Then, left-click on the *Add User* button, at the lower right.

Note that some roles are considered to be _subsets_ of others.
In such cases, manually checking one checkbox may trigger the automated checking of others â€” indicating that the corresponding roles are also assigned to the user.
To demonstrate this, left-click on the [.ui]*Full Admin* checkbox, near the top.
The [.ui]*Roles* panel now appears as follows:

[#roles_panel_admin_checked]
image::manage-security/rolesPanelAdminChecked.png[,280,align=left]

As illustrated, selecting the [.ui]*Full Admin* role causes all other roles
also to become selected: this is because [.ui]*Full Admin* stands at the top
of the hierarchy, and is a superset of all other roles.

[#saving-and-making-changes]
=== Saving and Making Changes

Whenever you have finished allocating roles to a particular user, left-click
on [.ui]*Add User*.
The dialog disappears, and the [.ui]*Security* view now displays, on the row
of the corresponding [.ui]*username*, the roles you have allocated.
For example, if you have allocated [.ui]*Data Reader* and [.ui]*Data Writer*
on [.ui]*travel-sample*, the view is as follows:

[#security_view_with_new_user]
image::manage-security/securityViewWithNewUser.png[,720,align=left]

Note that by left-clicking within the row, you display options for making changes:

[#security_view_with_edit_options]
image::manage-security/securityViewWithEditOptions.png[,720,align=left]

By left-clicking on [.ui]*Delete*, you delete the user.
By left-clicking on [.ui]*Edit*, you bring up the [.ui]*Edit testUser* dialog,
with the options to redefine username, full name, and roles (the content of this dialog is very similar to that of the [.ui]*Add New User* dialog, examined in detail above).
The *Reset Password* button only appears when the selected user is
_locally_ defined.
Left-clicking on the button brings up a dialog that allows redefinition of the
user's password:

[#reset_password]
image::manage-security/resetPassword.png[,260,align=left]

For a complete account of the roles you can allocate and their significance,
see xref:learn:security/roles.adoc[Roles].

[#adding-an-externally-authenticated-user]
=== Adding an Externally Authenticated User

An _externally authenticated_ user is not authenticated on Couchbase Server.
Instead, they are authenticated on a server external to the cluster.
This means that the user's password is defined and maintained externally.

External authentication must be supported by xref:learn:security/authentication-overview.adoc#native-ldap-support[Native LDAP], xref:learn:security/authentication-overview.adoc#using-saslauthd[saslauthd], or xref:learn:security/authentication-overview.adoc#introduction-to-pam-based-authentication[PAM].
Appropriate set-up procedures must have been completed prior to the addition of externally authenticated users.

For the detailed steps required to establish external authentication by means of Native LDAP (which is the recommended mechanism), see xref:manage:manage-security/configure-ldap.adoc[Configure LDAP].

To add an externally authenticated user, on the *Add New User* dialog, select the *External* option:

image::manage-security/externalUserRadioButton.png[,100,align=middle]

This removes the password-related fields from the dialog, since they are not required for the creation of an externally authenticated user.
The fields for the user's names remain, and can be used.

The view provided by the dialog's right-hand panel can be toggled, by means of the *Roles* and *Groups* tabs, which appear above the panel:

image::manage-security/rolesAndGroupsToggle.png[,140,align=middle]

The *Roles* option can be used for externally authenticated users, just as it is used for locally authenticated users.
The only difference is that no password need be specified for externally authenticated users.

The *Groups* option can only be used when _Native LDAP_ has been established as the means of external authentication, and _LDAP group-support_ has been enabled.
It provides a _group-mapping_, whereby a user-group defined on Couchbase Server is mapped to an LDAP group on an external server, and the user's LDAP-group membership can thus be used to give them the roles assigned to a Couchbase Server user-group.
See xref:learn:security/authentication-overview.adoc#native-ldap-support[Native LDAP], for an overview; and xref:manage:manage-security/configure-ldap.adoc[Configure LDAP], for practical configuration steps.

[#add-an-externally-authenticated-user-individually]
==== Add an Externally Authenticated User without Group-Mapping

If the externally authenticated user is _not_ to be associated with an LDAP-group mapping, assign roles individually, using the *Roles* view, just as you would for a locally authenticated user.
For example:

image::manage-security/addNewIndividualLDAPuser.png[,420,align=middle]

Then, left-click on the *Add User* button.

image::manage-security/addUserTab2.png[,120,align=middle]

The *Users & Groups* panel now appears as follows:

image::manage-security/externalUserIndividual.png[,720,align=middle]

The new external user is listed, with their *auth domain* specified as `External`.

[#add-an-externally-authenticated-user-by-group]
==== Add an Externally Authenticated User with Group-Mapping

If the externally authenticated user _is_ to be associated with an LDAP-group mapping, do not assign roles to the user individually.
Instead, toggle the right-hand panel, by left-clicking on the *Groups* tab:

image::manage-security/groupsTab.png[,140,align=middle]

This displays the Couchbase-Server user-groups that have been mapped to LDAP groups:

image::manage-security/groupsPanel.png[,170,align=middle]

A single user-group is thus shown to have been created, called `Admins`.
For details of the mapping procedure, see xref:manage:manage-security/configure-ldap.adoc[Configure LDAP].

To add an externally authenticated user with this group-mapping, specify the user's username, and check the checkbox for the displayed group.
Then, left-click on *Add User*, to save.:

image::manage-security/addExternalUserGroup.png[,420,align=middle]

The *Users & Groups* screen now appears as follows:

image::manage-security/usersAndGroupsTwoUsers.png[,800,align=middle]

The new user is duly shown to have the `Full Admin` role associated with the the `Admins` group.

=== Add and Edit Groups

The step-by-step procedures for adding and editing groups are provided in xref:manage:manage-security/configure-ldap.adoc[Configure LDAP].

=== Role-Based Console Appearance

Role-assignment determines which features of Couchbase Web Console are
available to the administrator.
Non-available features are not displayed: therefore, the console's appearance
changes, based on which roles have been assigned to the current user.

[#manage-users-with-the-cli]
== Manage Users with the CLI

Users can be managed with the xref:cli:cli-user-manage.adoc[user-manage] command.
This allows the creation and deletion of users and groups, the assignment of roles, and the listing of current status.

[#get-user-information-with-the-cli]
=== Get User Information with the CLI

To list the cluster's current users, enter the following.
Note that the command is piped to the `jq` program, to optimize output-readability.

----
/opt/couchbase/bin/couchbase-cli user-manage --cluster http://10.143.192.101 \
--username Administrator \
--password password \
--list | jq
----

A document is returned, containing an entry for each of the current users:

----
[
  {
    "id": "externalUserIndividual",
    "domain": "external",
    "roles": [
      {
        "role": "cluster_admin",
        "origins": [
          {
            "type": "user"
          }
        ]
      }
    ],
    "groups": [],
    "external_groups": [],
    "name": "John Smith"
  },
  {
    "id": "localUser",
    "domain": "local",
    "roles": [
      {
        "role": "data_writer",
        "bucket_name": "travel-sample",
        "origins": [
          {
            "type": "user"
          }
        ]
      },
      {
        "role": "data_reader",
        "bucket_name": "travel-sample",
        "origins": [
          {
            "type": "user"
          }
        ]
      }
    ],
    "groups": [],
    "external_groups": [],
    "name": "",
    "password_change_date": "2019-05-31T03:59:49.000Z"
  },
  {
    "id": "externalUserGroup",
    "domain": "external",
    "roles": [
      {
        "role": "admin",
        "origins": [
          {
            "type": "group",
            "name": "Admins"
          },
          {
            "type": "user"
          }
        ]
      }
    ],
    "groups": [
      "Admins"
    ],
    "external_groups": [],
    "name": "David Brown"
  }
]
----

The entries include information on the `name` and `roles` of the user, and on the local and external `groups` to which the user belongs.

Information on currently defined _groups_ can similarly be returned:

----
/opt/couchbase/bin/couchbase-cli user-manage --cluster http://10.143.192.101 \
--username Administrator \
--password password \
--get-group \
--group-name Admins
----

An example of the output is as follows:

----
{
  "id": "Admins",
  "roles": [
    {
      "role": "admin"
    }
  ],
  "ldap_group_ref": "uid=cbadmins,ou=groups,dc=example,dc=com",
  "description": "Couchbase Server Administrators"
}
----

This shows that a single group, named `Admins`, has been defined on the cluster; and that the `admin` role has been assigned to it.
The group's LDAP reference and description are also provided.

[#manage-local-users-with-the-cli]
=== Manage Local Users with the CLI

To _create_ a user who is to be _locally authenticated_, enter the following:

----
/opt/couchbase/bin/couchbase-cli user-manage --cluster http://10.143.192.101 \
--username Administrator \
--password password \
--set \
--rbac-username dgreen \
--rbac-password dGr3En238 \
--roles ro_admin \
--auth-domain local
----

This uses the `--set` flag, to indicate that the RBAC profile for the cluster is being updated.
The username and password for the user are defined, and the `ro_admin` role is assigned.
The value of the `--auth-domain` flag indicates that this is indeed to be a `local` user.
If the call is successful, the following is displayed:

----
SUCCESS: User dgreen was created
----

To _delete_ a local user, specify the `--delete` flag, with the username and authorization domain:

----
/opt/couchbase/bin/couchbase-cli user-manage --cluster http://10.143.192.101 \
--username Administrator \
--password password \
--rbac-username dgreen \
--auth-domain local \
--delete
----

The output is as follows:

----
SUCCESS: User 'dgreen' was removed
----

[#manage-external-users]
=== Manage External Users

Users can be defined as _externally_ authenticated, by mean of the CLI.
This requires _external authentication_ to have been configured prior to user-creation.
For the recommended procedure, see xref:manage:manage-security/configure-ldap.adoc[Configure LDAP].
In particular, for use of `user-manage` to map a Couchbase-Server user-group to an LDAP group, see the subsection xref:manage:manage-security/configure-ldap.adoc#map-groups-with-the-cli[Map Groups with the CLI].

[#create-an-external-user-without-a-group-mapping-using-the-cli]
==== Create an External User without a Group Mapping, Using the CLI

To create an external user _without_ a group mapping, use the `user-manage` command as follows:

----
/opt/couchbase/bin/couchbase-cli user-manage --cluster http://10.143.192.101 \
--username Administrator \
--password password \
--set \
--rbac-username wgrey \
--roles cluster_admin \
--auth-domain external
----

The `--auth-domain` is specified as `external`.
The `--set` flag establishes that the cluster's RBAC profile is to be updated.
No password is specified, since none is required for authentication on Couchbase Server &#8212; authentication occurring on the LDAP server.

If the command is successful, the following is returned:

----
SUCCESS: User wgrey was created
----

[#create-an-external-user-with-a-group-mapping]
==== Create an External User with a Group Mapping

To create an external user _with_ a group mapping, use the `user-manage` command as follows:

----
/opt/couchbase/bin/couchbase-cli user-manage --cluster http://10.143.192.101 \
--username Administrator \
--password password \
--edit-users-groups \
--rbac-username rjones \
--rbac-name 'Richard Jones' \
--roles cluster_admin \
--auth-domain external \
--user-groups Admins
----

The `--edit-users-groups` flag specifies that a group is to be updated.
The existing Couchbase-Server user-group `Admins` is passed as the value of `--user-groups`: this specifies that `Admins` is indeed the group of which the external user, `rjones` is to be a member.

If successful, the command returns the following:

----
SUCCESS: User 'Administrator' group memberships were updated
----

To _delete_ an external user, use the `--delete-user` flag, specifying `external` as the value of the `--auth-domain` flag:

----
/opt/couchbase/bin/couchbase-cli user-manage --cluster http://10.143.192.101 \
--username Administrator \
--password password \
--rbac-username wgrey \
--auth-domain external \
--delete
----

If successful, the command returns the following:

----
SUCCESS: User 'wgrey' was removed
----

[#manage-users-with-the-rest-api]
== Manage Users with the REST API

Users can be managed with the REST API.
This allows the creation and deletion of users and groups, the assignment of roles, and the listing of current status.

[#get-user-information-with-the-rest-api]
=== Get User Information With the REST API

To list the cluster's current users, use the `GET /settings/rbac/users` method and URI.

----
curl -v -X GET -u Administrator:password \
http://10.143.192.101:8091/settings/rbac/users
----

If successful, the command provides as its output a document containing an entry for each of the current users.
This output is identical in form to that shown above, in xref:manage:manage-security/manage-users-and-roles.adoc#get-user-information-with-the-cli[Get User Information with the CLI].

[#manage-local-users-with-the-rest-api]
=== Manage Local Users with the REST API

To _add_ a local user, use the `PUT /settings/rbac/users/local/<username>` method and URI.
For example:

----
curl -v -X  PUT -u Administrator:password \
http://10.143.192.101:8091/settings/rbac/users/local/dgreen \
-d password=dGr3En238 \
-d roles=ro_admin
----

This specifies that the user `dgreen` should be locally established, with the given password and the `ro_admin` role.
If required, the `GET /settings/rbac/users` method and URI (described above) can be used to verify that the specified user has been added.

Local users can be _deleted_ by means of the `DELETE /settings/rbac/users/local/<username>` method and URI:

----
curl -v -X DELETE -u Administrator:password \
http://10.143.192.101:8091/settings/rbac/users/local/dgreen
----

[#manage-external-users-with-the-rest-api]
=== Manage External Users with the REST API

Users can be defined as _externally_ authenticated, by means of the REST API.
This requires _external authentication_ to have been configured prior to user-creation.
For the recommended procedure, see xref:manage:manage-security/configure-ldap.adoc[Configure LDAP].
In particular, for an example of mapping a Couchbase-Server user-group to an LDAP group, see the subsection xref:manage:manage-security/configure-ldap.adoc#map-groups-with-the-rest-api[Map Groups with the REST API].

[#create-an-external-user-without-a-group-mapping-with-the-rest-api]
==== Create an External User without a Group Mapping, Using the REST API

To create an external user who is not included in a Couchbase-Server user-group, use the `PUT /settings/rbac/users/external/<username>` method and URI.
For example:

----
curl -v -X PUT -u Administrator:password \
http://10.143.192.101:8091/settings/rbac/users/external/wgrey \
-d roles=cluster_admin
----

This gives the role `cluster_admin` to the externally authenticated user `wgrey`.

[#create-an-external-user-with-a-group-mapping-with-the-rest-api]
==== Create an External User with a Group Mapping, Using the REST API

Use the `PUT /settings/rbac/users/<name>` method and URI, as follows:

----
curl -v -X PUT -u Administrator:password \
http://10.143.192.101:8091/settings/rbac/users/rjones \
-d groups=Admins
----

This adds the externally authenticated user `rjones` to the cluster, adding that user to the `Admins` group.
The user now inherits the roles that have been assigned to the `Admins` group.
