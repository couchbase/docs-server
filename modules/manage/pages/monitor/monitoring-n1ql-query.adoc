= Monitor Queries
:description: Monitoring and profiling N1QL queries, query service engines, and corresponding system resources is very important for smoother operational performance and efficiency of the system.
:page-aliases: monitoring:monitoring-n1ql-query

[abstract]
{description}
In fact, often it is vital for diagnosing and troubleshooting issues such as query performance, resource bottlenecks, and overloading of various services.

Couchbase Server 4.5 introduced system keyspaces to provide various monitoring details and statistics about individual queries and query service.
When running on a cluster with multiple query nodes, stats about all queries on all query nodes are collected in these system keyspaces.

For example, this can help identify:

* The top 10 slow or fast queries running on a particular query engine or the cluster.
* Resource usage statistics of the query service, or resources used for a particular query.
* Details about the active, completed, and prepared queries.
* Find long running queries that are running for more than 2 minutes.

These system keyspaces are like virtual keyspaces that are transient in nature, and are not persisted to disk or permanent storage.
Hence, the information in the keyspaces pertains to the current instantiation of the query service.
You can access the keyspaces using any of the following:

* N1QL language (from the cbq shell or Query Workbench)
* REST API
* Monitoring SDK

NOTE: All the power of the N1QL query language can be applied on the keyspaces to obtain various insights.

The following diagnostics are provided:

[cols="1,3"]
|===
| System Catalogs
a|
* xref:n1ql:n1ql-intro/sysinfo.adoc#querying-datastores[system:datastores]
* xref:n1ql:n1ql-intro/sysinfo.adoc#querying-namespaces[system:namespaces]
* xref:n1ql:n1ql-intro/sysinfo.adoc#querying-keyspaces[system:keyspaces]
* xref:n1ql:n1ql-intro/sysinfo.adoc#querying-dual[system:dual]

| Monitoring Catalogs
a|
* xref:n1ql:n1ql-intro/sysinfo.adoc#querying-indexes[system:indexes]
* <<sys-prepared,system:prepareds>>
* <<sys-completed-req,system:completed_requests>>
* <<sys-active-req,system:active_requests>>
* <<sys_my-user-info,system:my_user_info>>
* <<sys-functions,system:functions>>
* <<sys-functions-cache,system:functions_cache>>
* <<sys-tasks-cache,system:tasks_cache>>

| Security Catalogs
a|
* <<sys-user-info,system:user_info>>
* <<sys-nodes,system:nodes>>
* <<sys-app-roles,system:applicable_roles>>

| Other
a|
* <<vitals>>

NOTE: These are only available using REST APIs.
|===

== Authentication and Client Privileges

Client applications must be authenticated with sufficient privileges to access system keyspaces.

* An Administrator user can access all system keyspaces, and can grant or revoke privileges to and from other users.
* Other non-Administrator users must have explicitly granted privilege called *Query System Catalog* to access the restricted system keyspaces.
For querying details of system keyspaces, see xref:n1ql:n1ql-intro/sysinfo.adoc[Getting System Information].
* The following system keyspaces are considered _open_, that is, all users can access them without any special privileges:
 ** `system:dual`
 ** `system:datastores`
 ** `system:namespaces`

== Query Monitoring Settings

The monitoring settings can be set for each query engine (using the REST API) or for each query statement (using the cbq command line tool).
Both settings are actually set via REST endpoints: using the xref:n1ql:n1ql-rest-api/admin.adoc[Admin REST API] (`/admin/settings` endpoint) and the xref:n1ql:n1ql-rest-api/index.adoc[Query REST API] (`/query/service` endpoint).

The cbq shell and Query Workbench use the Query REST API to set monitoring at the request level.
The Query Workbench automatically enables the profiling and timings.
It can be disabled using the [.ui]*Preferences* option.
For more information refer to the xref:tools:query-workbench.adoc[Query Workbench] section.

Use the following query parameters to enable, disable, and control the monitoring capabilities, and the level of monitoring and profiling details for each query or globally at a query engine level:

* profile
* controls

For more details and examples, refer to the
xref:settings:query-settings.adoc[Query Settings] section.

=== Enabling Settings for a Query Engine

You can enable profile settings for each query engine.
These examples use local host IP address and default port numbers.
You need to provide correct credentials, IP address, and port details of your setup.

. Get the current query settings:
+
[source,console]
----
$ curl -u Administrator:pword -X GET http://localhost:8093/admin/settings > ./query_settings.json

$ cat  ./query_settings.json
----
+
[source,json]
----
{"auto-prepare":false,"completed":{"aborted":null,"threshold":1000},"completed-limit":4000,"completed-threshold":1000,"controls":false,"cpuprofile":"","debug":false,"functions-limit":16384,"keep-alive-length":16384,"loglevel":"INFO","max-index-api":4,"max-parallelism":1,"memprofile":"","mutexprofile":false,"n1ql-feat-ctrl":12,"pipeline-batch":16,"pipeline-cap":512,"prepared-limit":16384,"pretty":false,"profile":"off","request-size-cap":67108864,"scan-cap":512,"servicers":4,"timeout":0}
----

. Set current query settings profile:
 .. To set the query settings saved in a file [.path]_./query_settings.json_, enter the following query:
+
[source,console]
----
$ curl -u Administrator:pword -XPOST  http://127.0.0.1:8093/admin/settings -d@./query_settings.json
----

 .. To explicitly specify the settings, enter the following query:
+
[source,console]
----
$ curl -u Administrator:pword  http://127.0.0.1:8093/admin/settings  -H 'Content-Type: application/json' -d '{"profile": "phases"}'
----

 .. Verify the settings are changed as specified:
+
[source,console]
----
$ curl -u Administrator:pword -X GET http://localhost:8093/admin/settings
----
+
[source,json]
----
{"auto-prepare":false,"completed":{"aborted":null,"threshold":1000},"completed-limit":4000,"completed-threshold":1000,"controls":false,"cpuprofile":"","debug":false,"functions-limit":16384,"keep-alive-length":16384,"loglevel":"INFO","max-index-api":4,"max-parallelism":1,"memprofile":"","mutexprofile":false,"n1ql-feat-ctrl":12,"pipeline-batch":16,"pipeline-cap":512,"prepared-limit":16384,"pretty":false,"profile":"phases","request-size-cap":67108864,"scan-cap":512,"servicers":4,"timeout":0}
----

=== Enabling Settings per Session or per Query

You can enable monitoring and profiling settings for each query statement.
To set query settings using the cbq shell, use the `\SET` command:

[source,console]
----
cbq> \set -profile "timings";
cbq> \set;
 Query Parameters :
 Parameter name : profile
 Value : ["timings"]
 ...
----

To set query settings using the REST API, specify the parameters in the request body:

[source,console]
----
$ curl -v http://localhost:8093/query/service -d 'profile=timings&statement=SELECT * FROM default LIMIT 1;'
----

[#monitor-profile-details]
== Monitoring and Profiling Details

Couchbase Server 5.0 introduces a collection of detailed query monitoring and profiling information.
The profiling and finer query execution timing details can be obtained for any query.

[[profile]]
=== Attribute Profile in Query Response

When profiling is enabled, a query response includes the profile attribute.
The attribute details are as follows:

.Attribute Details
[cols="14,8"]
|===
| Attribute | Example

a|
`phaseTimes` -- Cumulative execution times for various phases involved in the query execution, such as authorize, indexscan, fetch, parse, plan, run, etc.

[NOTE]
====
This value will be dynamic, depending on the documents processed by various phases up to this moment in time.

A new query on `system:active_requests` will return different values.
====
a|
[source,json]
----
"phaseTimes": {
  "authorize": "823.631µs",
  "fetch": "656.873µs",
  "indexScan": "29.146543ms",
  "instantiate": "236.221µs",
  "parse": "826.382µs",
  "plan": "11.831101ms",
  "run": "16.892181ms"
}
----

a|
`phaseCounts` -- Count of documents processed at selective phases involved in the query execution, such as authorize, indexscan, fetch, parse, plan, run, etc.

[NOTE]
====
This value will be dynamic, depending on the documents processed by various phases up to this moment in time.

A new query on `system:active_requests` will return different values.
====
a|
[source,json]
----
"phaseCounts": {
  "fetch": 16,
  "indexScan": 187
}
----

a|
`phaseOperators` -- Indicates the number of each kind of query operators involved in different phases of the query processing.
For instance, this example, one non covering index path was taken, which involves 1 indexScan and 1 fetch operator.

A join would have probably involved 2 fetches (1 per keyspace)

A union select would have twice as many operator counts (1 per each branch of the union).

This is in essence the count of all the operators in the `executionTimings` field.
a|
[source,json]
----
"phaseOperators": {
  "authorize": 1,
  "fetch": 1,
  "indexScan": 2
}
----

a|
`executionTimings` -- The execution details such as kernel and service execution times, number of documents processed at each query operator in each phase, and number of phase switches, for various phases involved in the query execution.

The following statistics are collected for each operator:

`#operator`::
Name of the operator.

`#stats`::
These values will be dynamic, depending on the documents processed by various phases up to this moment in time.
+
A new query on `system:active_requests` will return different values.

`#itemsIn`;;
Number of input documents to the operator.

`#itemsOut`;;
Number of output documents after the operator processing.

`#phaseSwitches`;;
Number of switches between executing, waiting for services, or waiting for the `goroutine` scheduler.

`execTime`;;
Time spent executing the operator code inside N1QL query engine.

`kernTime`;;
Time spent waiting to be scheduled for CPU time.

`servTime`;;
Time spent waiting for another service, such as index or data.
+
* For index scan, it is time spent waiting for GSI/indexer.
* For fetch, it is time spent waiting on the KV store.

a|
[source,json]
----
"executionTimings": {
  …
  [{
    "#operator": "Fetch",
    "#stats": {
      "#itemsIn": 187,
      "#itemsOut": 16,
      "#phaseSwitches": 413,
      "execTime": "128.434µs",
      "kernTime": "15.027879ms",
      "servTime": "1.590934ms",
      "state": "services"
    },
    "keyspace": "travel-sample",
    "namespace": "default"
  },
  {
    "#operator": "IntersectScan",
    "#stats": {
    "#itemsIn": 187,
    "#itemsOut": 187,
    "#phaseSwitches": 749,
    "execTime": "449.944µs",
    "kernTime": "14.625524ms"
    }
  }, …]
----

|===

These statistics (`kernTime`, `servTime`, and `execTime`) can be very helpful in troubleshooting query performance issues, such as:

* A high `servTime` for a low number of items processed is an indication that the indexer or KV store is stressed.
* A high `kernTime` means there is a downstream issue in the query plan or the query server having many requests to process (so the scheduled waiting time will be more for CPU time).

.Attribute Profile
====
The cbq engine must be started with authorization, for example:

[source,console]
----
$ ./cbq  -engine=http://127.0.0.1:8091/ -u Administrator -p pword
----

Show the statistics collected when the `profile` is set to `phases`:

[source,console]
----
cbq> \set -profile "phases";
cbq> SELECT * FROM `travel-sample` WHERE type = "airline" LIMIT 1;
----

[source,json]
----
{
  "requestID": "4852f401-a6fb-449a-b122-c744879bada1",
  "signature": {
    "*": "*"
  },
  "results": [
    {
      "travel-sample": {
        "callsign": "MILE-AIR",
        "country": "United States",
        "iata": "Q5",
        "icao": "MLA",
        "id": 10,
        "name": "40-Mile Air",
        "type": "airline"
      }
    }
  ],
  "status": "success",
  "metrics": {
    "elapsedTime": "20.793908ms",
    "executionTime": "20.697901ms",
    "resultCount": 1,
    "resultSize": 260
  },
  "profile": {
    "phaseTimes": {
      "authorize": "34.347µs",
      "fetch": "161.71µs",
      "filter": "51.029µs",
      "indexScan": "522.144µs",
      "instantiate": "25.277µs",
      "parse": "388.47µs",
      "plan": "19.387894ms",
      "run": "880.47µs"
    },
    "phaseCounts": {
      "fetch": 12,
      "filter": 1,
      "indexScan": 1
    },
    "phaseOperators": {
      "authorize": 1,
      "fetch": 1,
      "filter": 1,
      "indexScan": 1
    }
  }
}
----
====

.Attribute Profile
====
Show the statistics collected when `profile` is set to `timings`:

[source,console]
----
cbq> \set -profile "timings";
cbq> SELECT * FROM `travel-sample` WHERE type = "airline" LIMIT 1;
----

[source,json]
----
{
  "requestID": "874a6c27-b514-42c7-b057-caf07067db65",
  "signature": {
    "*": "*"
  },
  "results": [
    {
      "travel-sample": {
        "callsign": null,
        "country": "United States",
        "iata": null,
        "icao": "XSR",
        "id": 18257,
        "name": "Executive AirShare",
        "type": "airline"
      }
    }
  ],
  "status": "success",
  "metrics": {
    "elapsedTime": "29.855421ms",
    "executionTime": "29.838097ms",
    "resultCount": 1,
    "resultSize": 304
  },
  "profile": {
    "phaseTimes": {
      "authorize": "823.631µs",
      "fetch": "656.873µs",
      "indexScan": "29.146543ms",
      "instantiate": "236.221µs",
      "parse": "826.382µs",
      "plan": "11.831101ms",
      "run": "16.892181ms"
    },
    "phaseCounts": {
      "fetch": 16,
      "indexScan": 187
    },
    "phaseOperators": {
      "authorize": 1,
      "fetch": 1,
      "indexScan": 2
    },
    "executionTimings": {
      "#operator": "Sequence",
      "#stats": {
        "#phaseSwitches": 2,
        "execTime": "1.079µs",
        "kernTime": "16.889187ms"
      },
      "~children": [
        {
          "#operator": "Authorize",
          "#stats": {
            "#phaseSwitches": 4,
            "execTime": "5.423µs",
            "kernTime": "16.043784ms",
            "servTime": "818.208µs"
          },
          "privileges": {
            "List": [
              {
                "Target": "default:travel-sample",
                "Priv": 1
              },
              {
                "Target": "default:travel-sample",
                "Priv": 7
              }
            ]
          },
          "~child": {
            "#operator": "Sequence",
            "#stats": {
              "#phaseSwitches": 3,
              "execTime": "2.694µs",
              "kernTime": "16.036719ms"
            },
            "~children": [
              {
                "#operator": "Sequence",
                "#stats": {
                  "#phaseSwitches": 2,
                  "execTime": "1.418µs",
                  "kernTime": "16.028217ms"
                },
                "~children": [
                  {
                    "#operator": "IntersectScan",
                    "#stats": {
                      "#itemsIn": 187,
                      "#itemsOut": 187,
                      "#phaseSwitches": 749,
                      "execTime": "449.944µs",
                      "kernTime": "14.625524ms"
                    },
                    "limit": "1",
                    "scans": [
                      {
                        "#operator": "IndexScan",
                        "#stats": {
                          "#phaseSwitches": 3,
                          "execTime": "160.085µs",
                          "kernTime": "14.464239ms"
                        },
                        "index": "def_type",
                        "index_id": "7cc0b964c9b812d2",
                        "keyspace": "travel-sample",
                        "namespace": "default",
                        "spans": [
                          {
                            "Exact": true,
                            "Range": {
                              "High": [
                                "\"airline\""
                              ],
                              "Inclusion": 3,
                              "Low": [
                                "\"airline\""
                              ]
                            }
                          }
                        ],
                        "using": "gsi",
                        "~children": [
                          {
                            "#operator": "IndexScan",
                            "#stats": {
                              "#itemsOut": 187,
                              "#phaseSwitches": 753,
                              "execTime": "164.676µs",
                              "kernTime": "64.172µs",
                              "servTime": "14.228826ms"
                            },
                            "index": "def_type",
                            "index_id": "7cc0b964c9b812d2",
                            "keyspace": "travel-sample",
                            "namespace": "default",
                            "spans": [
                              {
                                "Exact": true,
                                "Range": {
                                  "High": [
                                    "\"airline\""
                                  ],
                                  "Inclusion": 3,
                                  "Low": [
                                    "\"airline\""
                                  ]
                                }
                              }
                            ],
                            "using": "gsi"
                          }
                        ]
                      },
                      {
                        "#operator": "DistinctScan",
                        "#stats": {
                          "#phaseSwitches": 4,
                          "execTime": "15.725µs",
                          "kernTime": "20.232µs",
                          "servTime": "14.597529ms"
                        },
                        "scan": {
                          "#operator": "IndexScan",
                          "#stats": {
                            "#phaseSwitches": 3,
                            "execTime": "113.002µs",
                            "kernTime": "14.486802ms"
                          },
                          "index": "univ_idx2",
                          "index_id": "75533bc1a5efe19e",
                          "keyspace": "travel-sample",
                          "namespace": "default",
                          "spans": [
                            {
                              "Exact": true,
                              "Range": {
                                "High": [
                                  "[\"type\", \"airline\"]"
                                ],
                                "Inclusion": 3,
                                "Low": [
                                  "[\"type\", \"airline\"]"
                                ]
                              }
                            }
                          ],
                          "using": "gsi",
                          "~children": [
                            {
                              "#operator": "IndexScan",
                              "#stats": {
                                "#phaseSwitches": 4,
                                "execTime": "18.384µs",
                                "kernTime": "1.681µs",
                                "servTime": "14.46157ms"
                              },
                              "index": "univ_idx2",
                              "index_id": "75533bc1a5efe19e",
                              "keyspace": "travel-sample",
                              "namespace": "default",
                              "spans": [
                                {
                                  "Exact": true,
                                  "Range": {
                                    "High": [
                                      "[\"type\", \"airline\"]"
                                    ],
                                    "Inclusion": 3,
                                    "Low": [
                                      "[\"type\", \"airline\"]"
                                    ]
                                  }
                                }
                              ],
                              "using": "gsi"
                            }
                          ]
                        }
                      }
                    ]
                  },
                  {
                    "#operator": "Fetch",
                    "#stats": {
                      "#itemsIn": 187,
                      "#itemsOut": 16,
                      "#phaseSwitches": 413,
                      "execTime": "128.434µs",
                      "kernTime": "15.027879ms",
                      "servTime": "1.590934ms",
                      "state": "services"
                    },
                    "keyspace": "travel-sample",
                    "namespace": "default"
                  },
                  {
                    "#operator": "Sequence",
                    "#stats": {
                      "#phaseSwitches": 5,
                      "execTime": "10.29µs",
                      "kernTime": "16.009655ms"
                    },
                    "~children": [
                      {
                        "#operator": "Filter",
                        "#stats": {
                          "#itemsIn": 16,
                          "#itemsOut": 16,
                          "#phaseSwitches": 69,
                          "execTime": "284.572µs",
                          "kernTime": "15.693579ms"
                        },
                        "condition": "((`travel-sample`.`type`) = \"airline\")"
                      },
                      {
                        "#operator": "InitialProject",
                        "#stats": {
                          "#itemsIn": 16,
                          "#itemsOut": 16,
                          "#phaseSwitches": 69,
                          "execTime": "7.202µs",
                          "kernTime": "15.984416ms"
                        },
                        "result_terms": [
                          {
                            "expr": "self",
                            "star": true
                          }
                        ]
                      },
                      {
                        "#operator": "FinalProject",
                        "#stats": {
                          "#itemsIn": 16,
                          "#itemsOut": 16,
                          "#phaseSwitches": 71,
                          "execTime": "24.641µs",
                          "kernTime": "15.980887ms"
                        }
                      }
                    ]
                  }
                ]
              },
              {
                "#operator": "Limit",
                "#stats": {
                  "#itemsIn": 2,
                  "#itemsOut": 1,
                  "#phaseSwitches": 11,
                  "execTime": "5.884µs",
                  "kernTime": "16.014442ms"
                },
                "expr": "1"
              }
            ]
          }
        },
        {
          "#operator": "Stream",
          "#stats": {
            "#itemsIn": 1,
            "#itemsOut": 1,
            "#phaseSwitches": 9,
            "execTime": "1.788µs",
            "kernTime": "16.883589ms"
          }
        }
      ]
    }
  }
}
----
====

[[plan]]
=== Attribute Meta in System Keyspaces

The `meta().plan` virtual attribute captures the whole query plan, and monitoring stats of various phases and involved query operators.
The `meta().plan` must be explicitly called in the SELECT query projection list.

The `meta().plan` attribute is enabled only for individual requests that are running (`active_requests`) or completed (`completed_requests`) when the profile is set to timings (`profile ="timings"`) for each individual request.
If at the engine level, the profile is set to off and individual requests have been run with `profile ="timings"`, then the system keyspaces will return the plan only for those requests.

Since there may be a combination of profile settings for all of the requests reported by the system keyspaces, not all requests returned will have a `meta().plan` attachment.

NOTE: For the `system:prepareds` requests, the `meta().plan` is available at all times since the `PREPARE` statement is not dependant on the profile setting.

This attribute is enabled for the following system keyspaces:

* <<sys-active-req>>
* <<sys-prepared>>
* <<sys-completed-req>>

For a detailed example, see <<example-2>>.

== N1QL Cluster Monitoring

=== Description

Couchbase Server allows you to monitor many aspects of an active cluster: cluster-aware operations, diagnostics, and more system keyspaces features that cover multiple nodes.
Functionalities include:

* Ability to access active / completed / prepared requests across all N1QL nodes from N1QL.
* Ability to list nodes by type and with status from N1QL.
* Ability to list system keyspaces from `system:keyspaces`.
* Extra fields in `system:active_requests` and `system:completed_requests`.
* Counters to keep track of specific requests, such as cancelled requests.
* Killing request for CREATE INDEX.

=== System Keyspaces

* The `system:keyspaces` keyspace can be augmented to list system keyspaces with a static map.
The small disadvantage of this is that it has to be maintained as new system keyspaces are added.
* The `system:active_requests` and `system:completed_requests` keyspaces can report scan consistency.
* The `system:prepareds` keyspace can list min and max execution and service times, as well as average times.

=== cbq-engine-cbauth

Cbq-engine-cbauth is an internal user that the query service uses to allow Query Workbench clients to query across multiple query nodes.

Since Query Workbench can connect to the same node only when cbq-engine is running, Query Workbench cannot do any query-clustered operations.

To get around this block, once the Query Workbench clients connect to a query node, this internal user (cbq-engine-cbauth) will be used to do any further inter-node user verification.

[#vitals]
== Vitals

The [.cmd]`Vitals` API provides data about the running state and health of the query engine, such as number of logical cores, active threads, queued threads, CPU utilization, memory usage, network utilization, garbage collection percentage, and so on.
This information can be very useful to assess the current workload and performance characteristics of a query engine, and hence load-balance the requests being sent to various query engines.

For field names and meanings, refer to xref:n1ql:n1ql-rest-api/admin.adoc#_vitals[Vitals].

=== Get System Vitals

[source,console]
----
$ curl -u Administrator:pword http://localhost:8093/admin/vitals
----

[source,json]
----
{
  "uptime":"32m8.864057439s",
  "local.time":"2019-05-06 07:44:38.23887048 -0700 PDT m=+1932.108850381",
  "version":"2.0.0-N1QL",
  "total.threads":114,
  "cores":1,
  "gc.num":37949760,
  "gc.pause.time":"10.23207ms",
  "gc.pause.percent":0,
  "memory.usage":17112800,
  "memory.total":2941446944,
  "memory.system":73201912,
  "cpu.user.percent":0,
  "cpu.sys.percent":0,
  "request.completed.count":435,
  "request.active.count":0,
  "request.per.sec.1min":0.0023,
  "request.per.sec.5min":0.141,
  "request.per.sec.15min":0.2009,
  "request_time.mean":"58.058383ms",
  "request_time.median":"10.141175ms",
  "request_time.80percentile":"14.391648ms",
  "request_time.95percentile":"38.252744ms",
  "request_time.99percentile":"1.372802439s",
  "request.prepared.percent":0
}
----

[#sys-active-req]
== system:active_requests

This catalog lists all currently executing active requests or queries.

For field names and meanings, refer to xref:n1ql:n1ql-rest-api/admin.adoc#_requests[Requests].
The profile related attributes are described in the section <<profile,Attribute profile in Query Response.>>

[[sys-active-get]]
=== Get Active Requests

To view active requests with Admin REST API:

[source,console]
----
$ curl -u Administrator:pword http://localhost:8093/admin/active_requests
----

To view active requests with N1QL, including the query plan:

[source,n1ql]
----
SELECT *, meta().plan FROM system:active_requests;
----

[[sys-active-delete]]
=== Terminate an Active Request

The DELETE command can be used to terminate an active request, for instance, a non-responding or a long-running query.

To terminate an active request [.var]`uuid` with the Admin REST API:

[source,console]
----
$ curl -u Administrator:pword -X DELETE http://localhost:8093/admin/active_requests/uuid
----

To terminate an active request [.var]`uuid` with N1QL:

[source,n1ql]
----
DELETE FROM system:active_requests WHERE requestId = "uuid";
----

[[sys-active-examples]]
=== Examples

.Get Active
====
[source,n1ql]
----
SELECT *, meta().plan FROM system:active_requests;
----

[source,json]
----
[
  {
    "active_requests": {
      "clientContextID": "81984707-a9cd-4b78-9110-d130eb580d7f",
      "elapsedTime": "65.543946ms",
      "executionTime": "65.507111ms",
      "node": "127.0.0.1:8091",
      "phaseCounts": {
        "primaryScan": 1
      },
      "phaseOperators": {
        "authorize": 1,
        "fetch": 1,
        "primaryScan": 1
      },
      "phaseTimes": {
        "authorize": "2.361862ms",
        "fetch": "7.222µs",
        "instantiate": "13.233µs",
        "parse": "660.048µs",
        "plan": "52.877µs",
        "primaryScan": "41.125271ms"
      },
      "remoteAddr": "127.0.0.1:57065",
      "requestId": "27e73286-c6cc-4c26-8977-ef8d68e91c8f",
      "requestTime": "2019-05-06 09:08:42.431161361 -0700 PDT m=+6976.301141271",
      "scanConsistency": "unbounded",
      "state": "running",
      "statement": "SELECT *, meta().plan FROM system:active_requests;",
      "userAgent": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10.13; rv:66.0) Gecko/20100101 Firefox/66.0 (Couchbase Query Workbench (6.5.0-2859-enterprise))",
      "users": "Administrator"
    },
    "plan": { <1>
      "#operator": "Sequence",
      "#stats": {
        "#phaseSwitches": 1,
        "execTime": "1.661µs"
      },
      "~children": [
        {
          "#operator": "Authorize",
          "#stats": {
            "#phaseSwitches": 3,
            "execTime": "4.844µs",
            "servTime": "2.357018ms"
          },
...
    "plan": {
      "#operator": "Sequence",
      "#stats": {
        "#phaseSwitches": 1,
        "execTime": "1.661µs"
      },
      "~children": [
        {
          "#operator": "Authorize",
          "#stats": {
            "#phaseSwitches": 3,
            "execTime": "4.844µs",
            "servTime": "2.357018ms"
          },
          "privileges": {
            "List": [
              {
                "Priv": 4,
                "Target": "#system:active_requests"
              }
            ]
          },
          "~child": {
            "#operator": "Sequence",
            "#stats": {
              "#phaseSwitches": 1,
              "execTime": "2.71µs"
            },
            "~children": [
              {
                "#operator": "PrimaryScan",
                "#stats": {
                  "#itemsOut": 1,
                  "#phaseSwitches": 7,
                  "execTime": "22.314µs",
                  "kernTime": "2.13µs",
                  "servTime": "41.102957ms"
                },
                "index": "#primary",
                "keyspace": "active_requests",
                "namespace": "#system",
                "using": "system"
              },
              {
                "#operator": "Fetch",
                "#stats": {
                  "#itemsIn": 1,
                  "#phaseSwitches": 5,
                  "execTime": "7.222µs",
                  "kernTime": "41.130913ms",
                  "servTime": "22.888285ms",
                  "state": "services"
                },
                "keyspace": "active_requests",
                "namespace": "#system"
              },
              {
                "#operator": "Sequence",
                "#stats": {
                  "#phaseSwitches": 1,
                  "execTime": "1.544µs"
                },
                "~children": [
                  {
                    "#operator": "InitialProject",
                    "#stats": {
                      "#phaseSwitches": 1,
                      "execTime": "980ns",
                      "kernTime": "64.066618ms",
                      "state": "kernel"
                    },
                    "result_terms": [
                      {
                        "expr": "self",
                        "star": true
                      },
                      {
                        "expr": "(meta(`active_requests`).`plan`)"
                      }
                    ]
                  },
                  {
                    "#operator": "FinalProject",
                    "#stats": {
                      "#phaseSwitches": 1,
                      "execTime": "827ns"
                    }
                  }
                ]
              }
            ]
          }
        },
        {
          "#operator": "Stream",
          "#stats": {
            "#phaseSwitches": 1,
            "execTime": "1.29µs",
            "kernTime": "66.511806ms",
            "state": "kernel"
          }
        }
      ],
      "~versions": [
        "2.0.0-N1QL",
        "6.5.0-2859-enterprise"
      ]
    }
  }
]
----
====

<1> The *plan* section contains a tree of operators that combine to execute the N1QL query.
The root operator is a Sequence, which itself has a collection of child operators like Authorize, PrimaryScan, Fetch, and possibly even more Sequences.

[#sys-prepared]
== system:prepareds

This catalog provides data about the known prepared statements and their state in a query engine’s prepared statement cache.
For each prepared statement, this catalog provides information such as name, statement, query plan, last use time, number of uses, and so on.

For field names and meanings, refer to xref:n1ql:n1ql-rest-api/admin.adoc#_statements[Statements].
The `system:prepareds` catalog returns all the properties that the N1QL Admin REST API would return for a specific prepared statement.
In addition, the `system:prepareds` catalog also returns the following property.

[options="header", cols=".^3a,.^11a,.^4a"]
|===
|Name|Description|Schema
|**node** +
__required__|The node on which the prepared statement is stored.|string
|===

[[sys-prepared-get]]
=== Get Prepared Statements

To get a list of all known prepared statements, you can use the Admin REST API or a N1QL query:

[source,console]
----
$ curl -u Administrator:pword http://localhost:8093/admin/prepareds
----

[source,n1ql]
----
SELECT * FROM system:prepareds;
----

To get information about a specific prepared statement [.var]`example1`, you can use the Admin REST API or a N1QL query:

[source,console]
----
$ curl -u Administrator:pword http://localhost:8093/admin/prepareds/example1
----

[source,n1ql]
----
SELECT * FROM system:prepareds WHERE name = "example1";
----

[[sys-prepared-delete]]
=== Delete Prepared Statements

To delete a specific prepared statement [.var]`p1`, you can use the Admin REST API or a N1QL query:

[source,console]
----
$ curl -u Administrator:pword -X DELETE http://localhost:8093/admin/prepareds/p1
----

[source,n1ql]
----
DELETE FROM system:prepareds WHERE name = "p1";
----

To delete all the known prepared statements, you must use a N1QL query:

[source,n1ql]
----
DELETE FROM system:prepareds;
----

[[sys-prepared-examples]]
=== Examples

.Get Prepared
====
[source,n1ql]
----
PREPARE p1 AS SELECT * FROM default WHERE foo = 42;
----

[source,json]
----
{
  "requestID": "87520590-8932-4be8-8d08-6bf4a0aad0d5",
  "signature": "json",
  "results": [
    {
      "encoded_plan": "H4sIAAAAAAAA/wEAAP//AAAAAAAAAAA=",
      "featureControls": 12,
      "indexApiVersion": 4,
      "name": "[127.0.0.1:8091]p1",
      "namespace": "default",
      "operator": {
        "#operator": "Sequence",
        "~children": [
          {
            "#operator": "Authorize",
            "privileges": {
              "List": [
                {
                  "Priv": 7,
                  "Target": "default:travel-sample"
                }
              ]
            },
            "~child": {
              "#operator": "Sequence",
              "~children": [
                {
                  "#operator": "PrimaryScan3",
                  "index": "def_primary",
                  "index_projection": {
                    "primary_key": true
                  },
                  "keyspace": "travel-sample",
                  "namespace": "default",
                  "using": "gsi"
                },
                {
                  "#operator": "Fetch",
                  "keyspace": "travel-sample",
                  "namespace": "default"
                },
                {
                  "#operator": "Parallel",
                  "~child": {
                    "#operator": "Sequence",
                    "~children": [
                      {
                        "#operator": "Filter",
                        "condition": "((`travel-sample`.`foo`) = 42)"
                      },
                      {
                        "#operator": "InitialProject",
                        "result_terms": [
                          {
                            "expr": "self",
                            "star": true
                          }
                        ]
                      },
                      {
                        "#operator": "FinalProject"
                      }
                    ]
                  }
                }
              ]
            }
          },
          {
            "#operator": "Stream"
          }
        ]
      },
      "signature": {
        "*": "*"
      },
      "text": "PREPARE p1 AS SELECT * FROM `travel-sample` WHERE foo = 42;"
    }
  ],
  "status": "success",
  "metrics": {
    "elapsedTime": "34.712303ms",
    "executionTime": "34.68522ms",
    "resultCount": 1,
    "resultSize": 3443
  }
}
----

[source,n1ql]
----
SELECT *, meta().plan FROM system:prepareds;
----

[source,json]
----
{
  "requestID": "e37ab60b-b616-478f-8cf3-cdc16e39283d",
  "signature": {
    "*": "*",
    "plan": "json"
  },
  "results": [
    {
      "plan": {
        "#operator": "Sequence",
        "~children": [
          {
            "#operator": "Authorize",
            "privileges": {
              "List": [
                {
                  "Priv": 7,
                  "Target": "default:travel-sample"
                }
              ]
            },
            "~child": {
              "#operator": "Sequence",
              "~children": [
                {
                  "#operator": "PrimaryScan3",
                  "index": "def_primary",
                  "index_projection": {
                    "primary_key": true
                  },
                  "keyspace": "travel-sample",
                  "namespace": "default",
                  "using": "gsi"
                },
                {
                  "#operator": "Fetch",
                  "keyspace": "travel-sample",
                  "namespace": "default"
                },
                {
                  "#operator": "Parallel",
                  "~child": {
                    "#operator": "Sequence",
                    "~children": [
                      {
                        "#operator": "Filter",
                        "condition": "((`travel-sample`.`foo`) = 42)"
                      },
                      {
                        "#operator": "InitialProject",
                        "result_terms": [
                          {
                            "expr": "self",
                            "star": true
                          }
                        ]
                      },
                      {
                        "#operator": "FinalProject"
                      }
                    ]
                  }
                }
              ]
            }
          },
          {
            "#operator": "Stream"
          }
        ]
      },
      "prepareds": {
        "encoded_plan": "H4sIAAAAAAAA/6SSQYvbPhTEv4qY/2U36F/IdqGg0kNYHFrYUpMs7aGERNgvjrqypD7JIWlwP3uxnRCS7aUt+GBL45l5P94B5ApfUrkMVjsoQGJNOjVMD94l9jZCje8kjCtpNwnmM3E03kHdSzhdExTCGMN7DLroDkpa68YmSPhArJNnqAP+O39gTt8bcgVB4mexMbZkclBfL0WTJm08mx+dKrDZGksVxc7q0cTUy580V5TOkSqx3pL9P+o62O6/nM0W6k27aE9Jf1UlZ1Nr3s8L7V7jCGNIXYbh6nS6DOy/UZF6Rgccb5fPtIdK3FAr8Uz7E6nrur+n2ETjKihU0aCVl82mlIoN/tj02ibXrK0li3/CNDU2EUOi8K40AwPc3KwuGq1erdber27FO3F/d/uiyQdnktE2HzBCgik2Ni0TcR37RNqFThjJriERk+Yj2sULOMadndpF2z1Xknli0jX6BYmmcv3qd8OPoDBCK5Fo121YPsvyySwTYSwmczHPHrOHJzES09mnj+JqQPHlfTbLxNr7fsa3aH8FAAD//yw1h9FnAwAA",
        "featuresControl": 12,
        "indexApiVersion": 4,
        "name": "p1",
        "node": "127.0.0.1:8091",
        "statement": "PREPARE p1 AS SELECT * FROM `travel-sample` WHERE foo = 42;",
        "uses": 0
      }
    }
  ],
  "status": "success",
  "metrics": {
    "elapsedTime": "122.056934ms",
    "executionTime": "122.03689ms",
    "resultCount": 1,
    "resultSize": 3499
  }
}
----
====

[#sys-completed-req]
== system:completed_requests

By default, this catalog maintains a list of the most recent completed requests that have run longer than a predefined threshold of time.
(You can also log completed requests that meet other conditions that you define.)

For each completed request, this catalog maintains information such as requestId, statement text, prepared name (if prepared statement), request time, service time, and so on.
This information provides a general insight into the health and performance of the query engine and the cluster.

For field names and meanings, refer to xref:n1ql:n1ql-rest-api/admin.adoc#_requests[Requests].
Note that most field names and meanings match exactly those of `system:active_requests`.

[NOTE]
====
Request profiling affects the `system:completed_requests` keyspace in the following ways:

* When the feature is turned on, completed requests are stored with their execution plan.
* Profiling information is likely to use 100KB+ per entry.
* Due to the added overhead of running both profiling and logging, we recommend turning on both of them only when needed.
Running only one of them continuously has no noticeable affect on performance.
* Profiling does not carry any extra cost beyond memory for completed requests, so it's fine to run it continuously.
====

[[sys-completed-get]]
=== Get Completed Requests

To get a list of all logged completed requests using the Admin REST API:

[source,console]
----
$ curl -u Administrator:pword http://localhost:8093/admin/completed_requests
----

To get a list of all logged completed requests using N1QL, including the query plan:

[source,n1ql]
----
SELECT *, meta().plan FROM system:completed_requests;
----

[[sys-completed-delete]]
=== Purge the Completed Requests

To purge a completed request [.var]`uuid` with the Admin REST API:

[source,console]
----
$ curl -u Administrator:pword -X DELETE http://localhost:8093/admin/completed_requests/uuid
----

To purge a completed request [.var]`uuid` with N1QL:

[source,n1ql]
----
DELETE FROM system:completed_requests WHERE requestId = "uuid";
----

To purge the completed requests for a given time period, use:

[source,n1ql]
----
DELETE FROM system:completed_requests WHERE requestTime LIKE "2015-09-09%";
----

[[sys-completed-config]]
=== Configure the Completed Requests

You can configure the `system:completed_requests` keyspace by specifying parameters through the Admin API settings endpoint.

In Couchbase Server 6.5 and later, you can specify the conditions for completed request logging using the `completed` field.

This field takes a JSON object containing the names and values of logging qualifiers.
Completed requests that meet the defined qualifiers are logged.

[source,console]
----
$ curl http://localhost:8093/admin/settings -u Administrator:password -H 'Content-Type: application/json' -d '{"completed": {"user": "marco", "error": 12003}}'
----

==== Logging Qualifiers

You can specify the following logging qualifiers.
A completed request is logged if _any_ of the qualifiers are met (logical OR).

[horizontal]
`threshold`:: The execution time threshold in milliseconds.
`aborted`:: Whether to log requests that generate a panic.
`error`:: Log requests returning this error number.
`client`:: Log requests from this IP address.
`user`:: Log requests with this user name.
`context`:: Log requests with this client context ID.

For full details, refer to xref:n1ql:n1ql-rest-api/admin.adoc#_logging_parameters[Logging parameters].

The basic syntax adds a qualifier to the logging parameters, i.e. any existing qualifiers are not removed.
You can change the value of a logging qualifier by specifying the same qualifier again with a new value.

To add a new instance of an existing qualifier, use a plus sign (`+`) before the qualifier name, e.g. `+user`.
To remove a qualifier, use a minus sign (`-`) before the qualifier name, e.g. `-user`.

For example, the following request will add user `simon` to those tracked, and remove error `12003`.

[source,console]
----
$ curl http://localhost:8093/admin/settings -u Administrator:password -H 'Content-Type: application/json' -d '{"completed": {"+user": "simon", "-error": 12003}}'
----

Similarly, you could remove all logging by execution time with the following request, as long as the value matches the existing threshold.

[source,console]
----
$ curl http://localhost:8093/admin/settings -u Administrator:password -H 'Content-Type: application/json' -d '{"completed": {"-threshold": 1000}}'
----

==== Tagged Sets

You can also specify qualifiers that have to be met as a group for the completed request to be logged (logical AND).

To do this, specify the `tag` field along with a set of qualifiers, like so:

[source,console]
----
$ curl http://localhost:8093/admin/settings -u Administrator:password -H 'Content-Type: application/json' -d '{"completed": {"user": "marco", "error": 12003, "tag": "both_user_and_error"}}'
----

In this case, the request will be logged when both user and error match.

The tag name can be any string that is meaningful and unique.
Requests that match a tagged set of conditions are logged with a field `~tag`, which is set to the name of the tag.

To add a qualifier to a tagged set, specify the tag name again along with the new qualifier:

[source,console]
----
$ curl http://localhost:8093/admin/settings -u Administrator:password -H 'Content-Type: application/json' -d '{"completed": {"client": "172.1.2.3",  "tag": "both_user_and_error"}}'
----

You cannot add a new instance of an existing qualifier to a tagged set using a plus sign (`+`) before the qualifier name.
For example, you cannot add a `user` qualifier to a tagged set that already contains a `user` qualifier.
If you need to track two users with the same error, create two tagged sets, one per user.

You can remove a qualifier from a tagged set using a minus sign (`-`) before the qualifier name, e.g. `-user`.
When you remove the last qualifier from a tagged set, the tagged set is removed.

[NOTE]
--
You can specify multiple tagged sets.
In this case, completed requests are logged if they match all of the qualifiers in any of the tagged sets.

You can also specify a mixture of tagged sets and individual qualifiers.
In this case, completed requests are logged if they match any of the individual qualifiers, or all of the qualifiers in any of the tagged sets.
--

==== Completed Threshold

The [.param]`completed-threshold` field provides another way of specifying the `threshold` qualifier within the `completed` field.

This field sets the minimum request duration after which requests are added to the `system:completed_requests` catalog.
The default value is 1000ms.
Specify [.in]`0` to log all requests and [.in]`-1` to not log any requests to the keyspace.

To specify a different value, use:

[source,console]
----
$ curl http://localhost:port/admin/settings -H 'Content-Type: application/json' -d '{"completed-threshold":0}' -u user:pword
----

==== Completed Limit

The [.param]`completed-limit` field sets the number of most recent requests to be tracked in the `system:completed_requests` catalog.
The default value is 4000.
Specify [.in]`0` to not track any requests and [.in]`-1` to set no limit.

To specify a different value, use:

[source,console]
----
$ curl http://localhost:port/admin/settings -H 'Content-Type: application/json' -d '{"completed-limit":1000}' -u user:pword
----

[[sys-completed-examples]]
=== Examples

[[example-2]]
.Completed Request
====
First, we set `profile = "timings"` and run a long query which takes at least 1000ms (the default value of the `completed-threshold` query setting) to get registered in the `system:completed_requests` keyspace:

.Query 1
[source,console]
----
cbq> \set -profile "timings";
cbq> SELECT * FROM `travel-sample` ORDER BY name;
----

Now, we change the profile setting to "phases" and rerun another long query:

.Query 2
[source,console]
----
cbq> \set -profile "phases";
cbq> SELECT * FROM `travel-sample` ORDER BY title;
----

Run a query `system:completed_requests` keyspace with `meta().plan`.

.Query 3
[source,console]
----
cbq> SELECT meta().plan, * from system:completed_requests;
----

.Result
[source,json]
----
{
  "requestID": "1c40bf56-5b58-43a4-94dc-bf78071c8b78",
  "signature": {
    "*": "*",
    "plan": "json"
  },
  "results": [
    { <1>
      "completed_requests": {
        "elapsedTime": "13.13643772s",
        "errorCount": 0,
        "node": "127.0.0.1:8091",
        "phaseCounts": {
          "fetch": 31599,
          "primaryScan": 31591,
          "sort": 31591
        },
        "phaseOperators": {
          "authorize": 1,
          "fetch": 1,
          "primaryScan": 1,
          "sort": 1
        },
        "phaseTimes": {
          "authorize": "24.749µs",
          "fetch": "2.747088103s",
          "instantiate": "23.974µs",
          "parse": "343.486µs",
          "plan": "713.077µs",
          "primaryScan": "80.802487ms",
          "run": "13.135258873s",
          "sort": "465.422275ms"
        },
        "remoteAddr": "10.143.192.1:54089",
        "requestId": "cb59ca6e-daf8-488f-9332-529283eac7e9",
        "requestTime": "2019-05-06 10:34:39.358924449 -0700 PDT m=+12133.228904346",
        "resultCount": 31591,
        "resultSize": 95381286,
        "scanConsistency": "unbounded",
        "serviceTime": "13.136355403s",
        "state": "completed",
        "statement": "SELECT * FROM `travel-sample` ORDER BY title;",
        "userAgent": "Go-http-client/1.1 (CBQ/2.0)",
        "users": "Administrator,Administrator"
      }
    },
    { <2>
      "completed_requests": {
        "elapsedTime": "13.448452215s",
        "errorCount": 0,
        "node": "127.0.0.1:8091",
        "phaseCounts": {
          "fetch": 31605,
          "primaryScan": 31591,
          "sort": 31591
        },
        "phaseOperators": {
          "authorize": 1,
          "fetch": 1,
          "primaryScan": 1,
          "sort": 1
        },
        "phaseTimes": {
          "authorize": "35.258µs",
          "fetch": "2.532068358s",
          "instantiate": "23.408µs",
          "parse": "820.508µs",
          "plan": "243.658µs",
          "primaryScan": "79.406995ms",
          "run": "13.447226791s",
          "sort": "253.974805ms"
        },
        "remoteAddr": "10.143.192.1:54071",
        "requestId": "ed11c0f5-6486-43ca-9148-16dba5e7971e",
        "requestTime": "2019-05-06 10:34:07.004829559 -0700 PDT m=+12100.874809462",
        "resultCount": 31591,
        "resultSize": 95381286,
        "scanConsistency": "unbounded",
        "serviceTime": "13.448333228s",
        "state": "completed",
        "statement": "SELECT * FROM `travel-sample` ORDER BY name;",
        "userAgent": "Go-http-client/1.1 (CBQ/2.0)",
        "users": "Administrator,Administrator"
      },
      "plan": {
        "#operator": "Sequence",
        "#stats": {
          "#phaseSwitches": 1,
          "execTime": "2.479µs"
        },
        "~children": [
          {
            "#operator": "Authorize",
            "#stats": {
              "#phaseSwitches": 3,
              "execTime": "2.17µs",
              "servTime": "33.088µs"
            },
            "privileges": {
              "List": [
                {
                  "Priv": 7,
                  "Target": "default:travel-sample"
                }
              ]
            },
            "~child": {
              "#operator": "Sequence",
              "#stats": {
                "#phaseSwitches": 1,
                "execTime": "1.953µs"
              },
              "~children": [
                {
                  "#operator": "Sequence",
                  "#stats": {
                    "#phaseSwitches": 1,
                    "execTime": "2.138µs"
                  },
                  "~children": [
                    {
                      "#operator": "PrimaryScan3",
                      "#stats": {
                        "#itemsOut": 31591,
                        "#phaseSwitches": 126367,
                        "execTime": "50.343241ms",
                        "kernTime": "2.451256939s",
                        "servTime": "29.063754ms"
                      },
                      "index": "def_primary",
                      "index_projection": {
                        "primary_key": true
                      },
                      "keyspace": "travel-sample",
                      "namespace": "default",
                      "using": "gsi"
                    },
                    {
                      "#operator": "Fetch",
                      "#stats": {
                        "#itemsIn": 31591,
                        "#itemsOut": 31591,
                        "#phaseSwitches": 130317,
                        "execTime": "57.835564ms",
                        "kernTime": "35.861393ms",
                        "servTime": "2.474232794s"
                      },
                      "keyspace": "travel-sample",
                      "namespace": "default"
                    },
                    {
                      "#operator": "InitialProject",
                      "#stats": {
                        "#itemsIn": 31591,
                        "#itemsOut": 31591,
                        "#phaseSwitches": 126367,
                        "execTime": "12.688544ms",
                        "kernTime": "2.555252091s"
                      },
                      "result_terms": [
                        {
                          "expr": "self",
                          "star": true
                        }
                      ]
                    }
                  ]
                },
                {
                  "#operator": "Order",
                  "#stats": {
                    "#itemsIn": 31591,
                    "#itemsOut": 31591,
                    "#phaseSwitches": 94778,
                    "execTime": "253.974805ms",
                    "kernTime": "2.561721648s"
                  },
                  "sort_terms": [
                    {
                      "expr": "(`travel-sample`.`name`)"
                    }
                  ]
                },
                {
                  "#operator": "FinalProject",
                  "#stats": {
                    "#itemsIn": 31591,
                    "#itemsOut": 31591,
                    "#phaseSwitches": 94774,
                    "execTime": "72.083151ms",
                    "kernTime": "10.510896696s"
                  }
                }
              ]
            }
          },
          {
            "#operator": "Stream",
            "#stats": {
              "#itemsIn": 31591,
              "#itemsOut": 31591,
              "#phaseSwitches": 63185,
              "execTime": "9.936962437s",
              "kernTime": "3.510240579s"
            }
          }
        ],
        "~versions": [
          "2.0.0-N1QL",
          "6.5.0-2859-enterprise"
        ]
      }
    }
  ],
  "status": "success",
  "metrics": {
    "elapsedTime": "38.651064ms",
    "executionTime": "38.56312ms",
    "resultCount": 2,
    "resultSize": 8740
  },
  "profile": { <3>
    "phaseTimes": {
      "authorize": "23.522µs",
      "fetch": "11.976706ms",
      "instantiate": "14.916µs",
      "parse": "714.888µs",
      "plan": "86.626µs",
      "primaryScan": "25.407183ms",
      "run": "37.731739ms"
    },
    "phaseCounts": {
      "fetch": 8,
      "primaryScan": 2
    },
    "phaseOperators": {
      "authorize": 1,
      "fetch": 1,
      "primaryScan": 1
    }
  }
}
----
====

This example shows:

<1> The profile attribute with all phases-related statistics for Query 2.
<2> The `meta().plan` with all detailed statistics collected for Query 1.
<3> The profile attribute with all phases-related statistics for this query itself (which is querying the `system:completed_requests` keyspace)

[#sys_my-user-info]
== system:my_user_info

This catalog maintains a list of all information of your profile.

To see your current information, use:

[source,n1ql]
----
SELECT * FROM system:my_user_info;
----

This will result in a list similar to:

[source,json]
----
[
  {
    "my_user_info": {
      "domain": "local",
      "external_groups": [],
      "groups": [],
      "id": "jane",
      "name": "Jane Doe",
      "password_change_date": "2019-05-07T02:31:53.000Z",
      "roles": [
        {
          "origins": [
            {
              "type": "user"
            }
          ],
          "role": "admin"
        }
      ]
    }
  }
]
----

[#sys-user-info]
== system:user_info

This catalog maintains a list of all current users in your bucket and their information.

To see the list of all current users, use:

[source,n1ql]
----
SELECT * FROM system:user_info;
----

This will result in a list similar to:

[source,json]
----
[
  {
    "user_info": {
      "domain": "local",
      "external_groups": [],
      "groups": [],
      "id": "jane",
      "name": "Jane Doe",
      "password_change_date": "2019-05-07T02:31:53.000Z",
      "roles": [
        {
          "origins": [
            {
              "type": "user"
            }
          ],
          "role": "admin"
        }
      ]
    }
  },
  {
    "user_info": {
      "domain": "ns_server",
      "id": "Administrator",
      "name": "Administrator",
      "roles": [
        {
          "role": "admin"
        }
      ]
    }
  }
]
----

[#sys-nodes]
== system:nodes

This catalog shows the datastore topology information.
This is separate from the N1QL clustering view, in that N1QL clustering shows a map of the N1QL cluster, as provided by the cluster manager, while `system:nodes` shows a view of the nodes and services that make up the actual datastore, which may or may not include N1QL nodes.

* The dichotomy is important in that N1QL could be clustered by one entity (e.g. Zookeeper) and be connected to a clustered datastore (e.g. Couchbase) such that each does not have visibility of the other.
* Should N1QL be extended to be able to concurrently connect to multiple datastores, each datastore will report its own topology, so that `system:nodes` offers a complete view of all the storage nodes, whatever those may be.
* The `system:nodes` keyspace provides a way to report services advertised by each node as well as services that are actually running.
This is datastore dependent.
* N1QL clustering is still reported by the `/admin` endpoints.

To see the list of all current node information, use:

[source,n1ql]
----
SELECT * FROM system:nodes;
----

This will result in a list similar to:

[source,json]
----
[
  {
    "nodes": {
      "name": "127.0.0.1:8091",
      "ports": {
        "cbas": 8095,
        "cbasAdmin": 9110,
        "cbasCc": 9111,
        "cbasSSL": 18095,
        "eventingAdminPort": 8096,
        "eventingSSL": 18096,
        "fts": 8094,
        "ftsSSL": 18094,
        "indexAdmin": 9100,
        "indexHttp": 9102,
        "indexHttps": 19102,
        "indexScan": 9101,
        "indexStreamCatchup": 9104,
        "indexStreamInit": 9103,
        "indexStreamMaint": 9105,
        "kv": 11210,
        "kvSSL": 11207,
        "n1ql": 8093,
        "n1qlSSL": 18093
      },
      "services": [
        "cbas",
        "eventing",
        "fts",
        "index",
        "kv",
        "n1ql"
      ]
    }
  }
]
----

[#sys-app-roles]
== system:applicable_roles

This catalog maintains a list of all applicable roles and grantee of each bucket.

To see the list of all current applicable role information, use:

[source,n1ql]
----
SELECT * FROM system:applicable_roles;
----

This will result in a list similar to:

[source,json]
----
[
  {
    "applicable_roles": {
      "grantee": "anil",
      "role": "replication_admin"
    }
  },
  {
    "applicable_roles": {
      "bucket_name": "travel-sample",
      "grantee": "anil",
      "role": "select"
    }
  },
  {
    "applicable_roles": {
      "bucket_name": "*",
      "grantee": "anil",
      "role": "select"
    }
  }
]
----

For more examples, take a look at the blog: https://blog.couchbase.com/optimize-n1ql-performance-using-request-profiling/[Optimize N1QL performance using request profiling^].

[#sys-functions]
== system:functions

include::ROOT:partial$developer-preview.adoc[tag=admonition]

This catalog maintains a list of all user-defined functions across all nodes.
To see the list of all user-defined functions, use:

[source,n1ql]
----
SELECT * FROM system:functions;
----

This will result in a list similar to:

[source,json]
----
[
  {
    "functions": {
      "definition": {
        "#language": "inline", // <1>
        "expression": "substr0(`vString`, (length(`vString`) - `vLen`), `vLen`)", // <2>
        "parameters": [ // <3>
          "vString",
          "vLen"
        ]
      },
      "identity": {
        "name": "rstr",
        "namespace": "default",
        "type": "global"
      }
    }
  },
  {
    "functions": {
      "definition": {
        "#language": "javascript",
        "library": "math77", // <4>
        "object": "add" // <5>
      },
      "identity": {
        "name": "javaScriptAdd", // <6>
        "namespace": "default", // <7>
        "type": "global" // <8>
      }
    }
  }
]
----

This query returns the following attributes:

<1> [.out]`definition.#language`: string (the language of the function, for example, inline)
<2> [.out]`definition.expression`: string (for inline functions only: the expression defining the function)
<3> [.out]`definition.parameters`: array of strings (the parameters required by the function)
<4> [.out]`definition.library`: string (for JavaScript functions only: the library containing the function)
<5> [.out]`definition.object`: string (for JavaScript functions only: the object defining the function)
<6> [.out]`identity.name`: string (the name of the function)
<7> [.out]`identity.namespace`: string (the namespace of the function, for example, default)
<8> [.out]`identity.type`: string (the type of the function, for example, global)

[#sys-functions-cache]
== system:functions_cache

include::ROOT:partial$developer-preview.adoc[tag=admonition]

This catalog maintains a list of recently-used user-defined functions across all nodes.
The catalog also lists user-defined functions that have been called recently, but do not exist.
To see the list of recently-used user-defined functions, use:

[source,n1ql]
----
SELECT * FROM system:functions_cache;
----

This will result in a list similar to:

[source,json]
----
[
  {
    "functions_cache": {
      "#language": "inline", // <1>
      "avgServiceTime": "8.926µs",
      "expression": "substr0(`vString`, (length(`vString`) - `vLen`), `vLen`)", // <2>
      "lastUse": "2019-08-06 06:08:35.37498882 -0700 PDT m=+2236.523899555",
      "maxServiceTime": "8.926µs",
      "minServiceTime": "0s",
      "name": "rstr", // <3>
      "namespace": "default", // <4>
      "node": "127.0.0.1:8091",
      "parameters": [ // <5>
        "vString",
        "vLen"
      ],
      "type": "global",
      "uses": 1
    }
  },
  {
    "functions_cache": {
      "#language": "javascript",
      "avgServiceTime": "674.264µs",
      "lastUse": "2019-08-06 06:10:50.681845642 -0700 PDT m=+2371.830756442",
      "library": "math77", // <6>
      "maxServiceTime": "674.264µs",
      "minServiceTime": "0s",
      "name": "javaScriptAdd",
      "namespace": "default",
      "node": "127.0.0.1:8091",
      "object": "add", // <7>
      "type": "global", // <8>
      "uses": 1
    }
  },
  {
    "functions_cache": {
      "avgServiceTime": "22.79µs", // <9>
      "lastUse": "2019-08-06 16:59:51.630317391 +0100 BST m=+17.966707065", // <10>
      "maxServiceTime": "22.79µs", // <11>
      "minServiceTime": "0s", // <12>
      "name": "notFound",
      "namespace": "default",
      "node": "127.0.0.1:8091", // <13>
      "type": "global",
      "undefined_function": true, // <14>
      "uses": 1 // <15>
    }
  }
]
----

This query returns the following attributes:

<1>  [.out]`#language`: string (the language of the function, for example, inline)
<2>  [.out]`expression`: string (for inline functions only: the expression defining the function)
<3>  [.out]`name`: string (the name of the function)
<4>  [.out]`namespace`: string (the namespace of the function, for example, default)
<5>  [.out]`parameters`: array of strings (the parameters required by the function)
<6>  [.out]`library`: string (for JavaScript functions only: the library containing the function)
<7>  [.out]`object`: string (for JavaScript functions only: the object defining the function)
<8>  [.out]`type`: string (the type of the function, for example, global)
<9>  [.out]`avgServiceTime`: string (the mean service time for the function)
<10> [.out]`lastUse`: string (the date and time when the function was last used)
<11> [.out]`maxServiceTime`: string (the maximum service time for the function)
<12> [.out]`minServiceTime`: string (the minimum service time for the function)
<13> [.out]`node`: string (the query node where the function is cached)
<14> [.out]`undefined_function`: boolean (whether the function exists or is undefined)
<15> [.out]`uses`: number (the number of uses of the function)

Each query node keeps its own cache of recently-used user-defined functions, so you may see the same function listed for multiple nodes.

[#sys-tasks-cache]
== system:tasks_cache

include::ROOT:partial$developer-preview.adoc[tag=admonition]

This catalog maintains a list of recently-used scheduled tasks, such as index advisor sessions.
To see the list of recently-used scheduled tasks, use:

[source,n1ql]
----
SELECT * FROM system:tasks_cache;
----

This will result in a list similar to:

[source,json]
----
[
  {
    "tasks_cache": {
      "class": "advisor", // <1>
      "delay": "1h0m0s", // <2>
      "id": "bcd9f8e4-b324-504c-a98b-ace90dba869f", // <3>
      "name": "aa7f688a-bf29-438f-888f-eeaead87ca40", // <4>
      "node": "10.143.192.101:8091", // <5>
      "state": "scheduled", // <6>
      "subClass": "analyze", // <7>
      "submitTime": "2019-09-17 05:18:12.903122381 -0700 PDT m=+8460.550715992" // <8>
    }
  },
  {
    "tasks_cache": {
      "class": "advisor",
      "delay": "5m0s",
      "id": "254abec5-5782-543e-9ee0-d07da146b94e",
      "name": "ca2cfe56-01fa-4563-8eb0-a753af76d865",
      "node": "10.143.192.101:8091",
      "results": [ // <9>
        ...
      ],
      "startTime": "2019-09-17 05:03:31.821597725 -0700 PDT m=+7579.469191487", // <10>
      "state": "completed",
      "stopTime": "2019-09-17 05:03:31.963133954 -0700 PDT m=+7579.610727539", // <11>
      "subClass": "analyze",
      "submitTime": "2019-09-17 04:58:31.821230131 -0700 PDT m=+7279.468823737"
    }
  }
]
----

This query returns the following attributes:

<1>  [.out]`class`: string (the class of the task; for example, `advisor`)
<2>  [.out]`delay`: string (the scheduled duration of the task)
<3>  [.out]`id`: string (the internal ID of the task)
<4>  [.out]`name`: string (the name of the task)
<5>  [.out]`node`: string (the node where the task was started)
<6>  [.out]`state`: string (the class of the task -- `scheduled`, `cancelled`, `completed`)
<7>  [.out]`subClass`: string (the subclass of the task; for example, `analyze`)
<8>  [.out]`submitTime`: string (the date and time when the task was submitted)
<9>  [.out]`results`: array (not scheduled tasks: the results of the task)
<10> [.out]`startTime`: string (not scheduled tasks: the date and time when the task started)
<11> [.out]`stopTime`: string (not scheduled tasks: the date and time when the task stopped)

Refer to xref:n1ql:n1ql-language-reference/advisor.adoc[ADVISOR Function] for more information on index advisor sessions.

== Related Links

* Refer to xref:n1ql:n1ql-intro/sysinfo.adoc[Getting System Information] for more information on the system namespace.