= Replicate Using Scopes and Collections

[abstract]
XDCR can be performed with reference to scopes and collections within source and target buckets.

[#understanding-scopes-collections-and-replication]
== Understanding Scopes, Collections, and Replication

As described in xref:learn:data/scopes-and-collections.adoc[Scopes and Collections], scopes and collections are containers for data within a bucket.
A cluster can contain up to 1000 scopes; and it can contain 1000 collections.

As well as specifying a source bucket and a target bucket, XDCR can specify scopes and collections within those buckets.
This allows data to be replicated from one collection to another.
For more information, see xref:learn:clusters-and-availability/xdcr-overview.adoc#xdcr-with-scopes-and-collections[XDCR with Scopes and Collections].

[#examples-on-this-page]
== Examples on this Page

The examples provided on this page &#8212; xref:manage:manage-xdcr/replicate-using-scopes-andcollections.adoc#replicate-data-between-collections-implicitly[Replicate Data Between Collections Implicitly], xref:manage:manage-xdcr/replicate-using-scopes-and-collections.adoc#replicate-data-between-collections-explicitly[Replicate Data Between Collections Explicitly] and xref:manage:manage-xdcr/replicate-using-scopes-and-collections.adoc#migrate-data-to-a-collection[Migrate Data to a Collection]
&#8212; demonstrate how XDCR can be performed with reference to scopes and collections within source and target buckets, using Couchbase Web Console.
The examples assume the following:

* A single-node cluster named `10.144.210.101` has been created, and features the `travel-sample` and `beer-sample` buckets.
See xref:manage:manage-settings/install-sample-buckets.adoc[Install Sample Buckets], for information on installing these buckets.
Note that the `travel-sample` bucket contains multiple scopes and collections, from which replications to the target cluster can be immediately established.
The `beer-sample` contains only the `_default` scope and collection, within which all data is contained: the _migration_ process will be used to separate data into scopes and collections on the target cluster.

* A single-node cluster named `10.144.210.102` has been created, and features no buckets.
Note that during the course of the examples on this page, buckets, scopes, and collections will need to be created on the `10.144.210.102` cluster: therefore, knowledge of how to create buckets, scopes, and collections must first be attained.
For comprehensive instructions, see xref:manage:manage-buckets/create-bucket.adoc[Create a Bucket] and xref:manage:manage-scopes-and-collections/manage-scopes-and-collections.adoc[Manage Scopes and Collections].

* The cluster `10.144.210.101` has defined `10.144.210.102` as a remote cluster for XDCR: this will permit replications to be established between the two clusters.

Before following the examples, familiarity should be gained with all XDCR management-basics explained on other pages. In particular, see xref:manage:manage-xdcr/prepare-for-xdcr.adoc[Prepare for XDCR], xref:manage:manage-xdcr/create-xdcr-reference.adoc[Create a Reference], and xref:manage:manage-xdcr/create-xdcr-replication.adoc[Create a Replication].

[#replicate-data-between-collections-implicitly]
== Replicate Data Between Collections Implicitly

XDCR allows data to be replicated between collections _implicitly_.

An _implicit_ mapping is one supported by XDCR whenever the same _keyspace_ exists within both the source and the target buckets.
The _keyspace_ is formed with a _scope-name_ and the _collection-name_.
Therefore, if a source bucket contains the keyspace `scope1.collection1`, and the target bucket also contains the keyspace `scope1.collection1`, once a replication has been established from the source bucket to the target cluster and bucket, data will be automatically replicated from the source collection to the target collection.
This is demonstrated in the following example.

Proceed as follows.

. On cluster `101.144.210.101`, access the *Buckets* screen:
+
image::manage-xdcr/access-buckets-screen.png[,100,align=left]

. When the screen appears, vertically expand the row for the `travel-sample` bucket; then, by means of the *Scopes and Collections* tab at the right-hand side of the row, examine the scopes already defined for the bucket.
Then, vertically expand the row for the scope `inventory`.
The screen now appears as follows:
+
image::manage-xdcr/source-bucket-screen.png[,720,align=left]
+
The screen shows that the scope `inventory` contains five collections; which are named `airport`, `airline`, `route`, `landmark`, and `hotel`.
In this example, the scope `inventory` and all five collections within it will be replicated to the target cluster.
+
The screen also shows that the `travel-sample` bucket contains, as well as its `&#95;default` scope, five additional scopes: which are named `tenant_agent_00` to `tenant_agent_04`.
These scopes will _not_ be replicated in this example.

. On cluster `101.144.210.102`, access the *Buckets* screen.

. Using the procedure described in xref:manage:manage-buckets/create-bucket.adoc[Create a Bucket], create a bucket namd `ts`.

. Using the procedures described in xref:manage:manage-scopes-and-collections/manage-scopes-and-collections.adoc[Manage Scopes and Collections], create, within `ts`, a scope named `inventory`; and within `inventory`, five collections; named `airport`, `airline`, `route`, `landmark`, and `hotel`.
(The *TTL* for each of these collections can be left at the default of `0`.)
+
With the row for `inventory` vertically expanded, the *Scopes and Collections* screen for the bucket `ts` now appears as follows:
+
image::manage-xdcr/target-bucket-screen.png[,720,align=left]
+
This indicates that the scope and collections have been successfully created, and contain no data.
The keyspaces thus formed &#8212; _inventory.airline_, _inventory.airport_, etc &#8212; are identical to ones that already exist on the source cluster, `10.144.210.101`.
The `&#95;default` scope for `ts` is also displayed.
Note that the other scopes on the target cluster &#8212; named `tenant_agent_00` to `tenant_agent_04` &#8212; have _not_ been created here, and will not be used for replication in the current example.

. On cluster `101.144.210.101`, access the *XDCR Replications* screen.
+
image::manage-xdcr/access-xdcr-screen.png[,100,align=left]
+
Currently, this has a remote reference to cluster `101.144.210.102` defined; but no replications have yet been defined.

. Left-click on the *ADD REPLICATION* button, at the upper right, to begin the process of defining a replication.

. When the *XDCR Add Replication* screen is displayed, use the fields in the upper part of the screen to specify a replication from the bucket `travel-sample` to the bucket `ts`, on cluster `101.144.210.102`.
The fields now appear as follows;
+
image::manage-xdcr/xdcr-replicate-to-102.png[,640,align=left]

. Save the replication, by left-clicking on the *Save Replication* button.
+
image::manage-xdcr/saveReplicationButton.png[,140,align=Left]
+
The replication is now started.

. Examine the *XDCR Replications* screen.
+
image::manage-xdcr/outgoingReplicationImplicit.png[,680,align=Left]
+
This confirms that replication is underway.

. On cluster `10.144.210.102`, access the *Buckets* screen; and access the *Scopes and Collections* screen for the bucket `ts`.
By successively left-clicking, open the row for `ts`, for the scope `inventory`; and then left-click on the *Documents* tab for any of the five collections previously created &#8212; for example, `airline`.
The *Documents* screen appears as follows:
+
image::manage-xdcr/targetCollectionAfterImplicit.png[,680,align=Left]
+
The presence of these documents verifies that replication has occurred from `travel-sample` on the source, to `ts` on the target; with replication occurring according to the implicit mappings discovered by XDCR.
Note that those scopes within `travel-sample` that did _not_ have an implicit mapping created have not been replicated.

[#replicate-data-between-collections-explicitly]
== Replicate Data Between Collections Explicitly

An _explicit_ mapping between collections is one established by an administrator, so as to allow replication to occur between differently named collections, and to apply filtering.
This is demonstrated in the following example.
Proceed as follows:

. Access the *XDCR Replications* screen of cluster `101.144.210.103`.
Currently, a remote reference to `10.144.210.104` is defined; but no replications have yet been defined.

. Create a replication from `101.144.210.103` to `101.144.210.104`.
Left-click on the *ADD REPLICATION* button, at the upper right of the screen.
The *XDCR Add Replication* screen is now displayed.

. Using the three upper fields &#8212; *Replicate From Bucket*, *Remote Cluster*, and *Remote Bucket* &#8212; define a replication from `tsBackup` on `103` to the bucket `tsBackup2` on `104`:
+
image::manage-xdcr/xdcr-basic-replication-definition-to-104.png[,560,align=left]


. To begin the process of specifying how data should be replicated between collections, switch on the *Specify scopes, collections, and mapping* toggle, in the middle of the screen:
+
image::manage-xdcr/xdcr-collections-mapping-toggle.png[,520,align=left]
+
Additional UI components are thus displayed.
The principal element is a list of scopes that are defined within the specified source bucket, `ts`.
Note that a `filter scopes` field is provided; which permits strings to be entered, such that only those scopes whose names include matches to the strings are displayed in the list.
+
Note the information that is displayed immediately above the list.
This relates to the presentation of scope-names, in the list's *scope* column.
Each scope-name is succeeded by the `>` symbol, and by a remote scope-name, which is by default assumed to be the name of the scope on the target system, to which replication will occur.
If this assumption is correct, no action need be taken.
However, if a remote scope to which replication is to occur has a different name from the one represented by default in the list, the remote-scope name must be changed: by left-clicking directly on the scope name, and editing the remote-scope name as appropriate.
(Note that this requirement also applies to the representation of collection-names, as will be demonstrated in the next step of this procedure.)
+
In the list currently presented, two scopes appear: which are the `_default` scope, and the scope `airlineScope`.
In this example, data will be replicated from `airlineScope`.

. Left-click on the list-row for `airlineScope`.
The row expands, and appears as follows:
+
image::manage-xdcr/xdcr-scope-row-expansion.png[,520,align=left]
+
The expanded row displays a field whereby collections in the scope can be filtered, based on a string-match.
It also features a *check all* checkbox, which allows all collections to be checked and thereby included in the intended replication; and an *include future collections* checkbox, which, if checked, ensures that collections added to the scope in future will automatically themselves be included in the replication.
+
Currently, the scope contains a single collection, which is `airlineCollection`.
This is checked by default: however, `airlineScope` itself has not yet been checked.
Both `airlineScope` and `airlineCollection` must be specified for inclusion in the replication: note, however, that the default remote-names with which they are associated are incorrect, and must thereby be edited appropriately.
+
Left-click on the scope named `airlineScope`:
+
image::manage-xdcr/xdcr-edit-remote-scope-name.png[,210,align=left]
+
Once focus is obtained, change the remote-scope name to `usAirlineBackupScope`:
+
image::manage-xdcr/xdcr-modified-remote-scope-name.png[,225,align=left]
+
In the same way, modify the remote-collection name associated with `airlineCollection` to `usAirlineBackupCollection`:
+
image::manage-xdcr/xdcr-modified-remote-collection-name.png[,225,align=left]
+
Note that the rules now appear in the *Mapping Rules* column, at the upper right of the screen:
+
image::manage-xdcr/xdcr-mapping-rules-for collections.png[,300,align=left]

. Filter the replication, to ensure that only documents whose `country` value is `United States` are replicated.
Switch on the *Filter replication* toggle, and enter the regular expression `country = "United States"`, into the interactive *Filter Expression* panel:
+
image::manage-xdcr/xdcr-filter-collections-replication.png[,225,align=left]
+
(Note that filtering, once enabled and defined, takes place across _all_ collections-mappings: there is currently no option right now to place individual filters on different collection-to-collection mappings.)

. Save the replication, by left-clicking on the *Save Replication* button, in the lower part of the screen.

The *XDCR Replications* screen is now displayed, with the *Outgoing Replications* panel indicating that replication is occurring as required between `10.144.210.103` and `10.144.210.104`.
Inspection, on `10.144.210.104`, of the collection `usAirlineBackupCollection` will indicate that the subset of documents whose `country` value is `United States` is being replicated into the collection.

[#migrate-data-to-a-collection]
== Migrate Data to a Collection

By specifying a scope and collection within a target bucket, XDCR can be used to replicate data selectively from the `&#95;default` collection within one bucket to the purpose-created collection within another.
Once such migration is complete, all future replications between collections should be performed with _implicit_ or _explicit_ mapping, as described in the corresponding examples, below.

Before migrating data in a production context, note the following:

* Each established migration rule is CPU-intensive, and may lower XDCR replication performance.
The more migration rules are added, the slower each migration replication will be.
Therefore, the total number of simultaneous migration-rule-based replications per source cluster should be no greater than 2.

* Correspondingly, if migration is to be performed with many rules; the replications should be performed 2 at a time.
On conclusion of those replications, applications intended to use the migrated data should be appropriately switched over.
Then, the next two migration rules should be configured, and the process repeated.
Continue in this way until the overall migration is complete.

Migration can now be exemplified as follows:

. Access the *XDCR Replications* screen of cluster `101.144.210.101`.
Currently, a remote reference to `10.144.210.102` is defined; but no replications have yet been defined.

. Create a replication from `101.144.210.101` to `101.144.210.102`.
Left-click on the *ADD REPLICATION* button, at the upper right of the screen.
The *XDCR Add Replication* screen is now displayed:
+
image::manage-xdcr/xdcr-add-replication-screen.png[,720,align=left]

. Using the three upper fields &#8212; *Replicate From Bucket*, *Remote Cluster*, and *Remote Bucket* &#8212; define a replication from `travel-sample` on `101` to the bucket `ts` on `102`:
+
image::manage-xdcr/xdcr-basic-replication-definition-to-102.png[,560,align=left]
+
Note the confirmatory notification that appears underneath the replication-definition.
As this indicates, if a replication is defined to include any destination-entity &#8212; bucket, scope, or collection &#8212; that does not exist, the entity will be ignored, and no attempt will be made to replicate data to it.
However, if other specified entities are valid, replication to them will proceed.

. To migrate data, switch on the *Migrate collections* toggle, in the middle of the screen:
+
image::manage-xdcr/xdcr-migrate-collections-toggle.png[,520,align=left]
+
Three new fields thus appear, which allow migration to be defined.
*Replication Filter for Source* allows a _regular expression_ to be specified, whereby only a subset of documents within `travel-sample` are replicated.
*Replicate to Collection* allows specification of a collection on the target cluster: the collection must be preceded by the name of the scope that contains it, with scope-name and collection-name comma-separated.
The *Save Mapping* button allows the migration-definition to be saved.

. Specify that _airline_ documents from `travel-sample` be replicated to the collection `airlineScope.airlineCollection`.
Use the regular expression `REGEXP_CONTAINS(META().id, "^airline")`.
The fields now appear as follows:
+
image::manage-xdcr/xdcr-migrate-collections-definition.png[,520,align=left]
+
Left-click on the *Save Mapping* button, to save the mapping:
+
image::manage-xdcr/xdcr-save-mapping-button.png[,150,align=left]
+
Note that the saved rule now appears in the *Mapping Rules* column, at the upper right of the screen:
+
image::manage-xdcr/mapping-rules-migration-definition.png[,200,align=left]

. Save the replication, by left-clicking on the *Save Replication* button, at the bottom of the screen:
+
image::manage-xdcr/saveReplicationButton.png[,140,align=Left]
+
The *XDCR Replications* screen now returns, with the *Outgoing Replications* panel appearing as follows:
+
image::manage-xdcr/xdcr-outgoing-replication-migration.png[,680,align=left]
+
As this indicates, the defined replication is now proceeding from `travel-sample` on the source cluster, to `ts` on the remote.

. On cluster `10.144.210.102`, access the *Buckets* screen, and left-click on the *Documents* tab for the collection `airlineCollection`, within the bucket `ts`.
+
image::manage-xdcr/xdcr-access-usAirlineCollection.png[,680,align=left]
+
The documents within the collection are now displayed:
+
image::manage-xdcr/xdcr-target-collection-filled.png[,680,align=left]
+
This indicates that the `airline` documents from `travel-sample` have been successfully filtered and replicated to the `airlineCollection` collection, within the remote bucket `ts`.


[#next-steps-after-replicate-between-scopes-and-collections]
== Next Steps

An XDCR replication can be _filtered_, by means of _regular expressions_; so that only selected documents are replicated from the source to the target cluster.
See xref:manage:manage-xdcr/filter-xdcr-replication.adoc[Filter a Replication].
