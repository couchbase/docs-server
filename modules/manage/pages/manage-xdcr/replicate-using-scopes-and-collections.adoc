= Replicate Using Scopes and Collections

[abstract]
XDCR can be performed with reference to scopes and collections within source and target buckets.

[#understanding-scopes-collections-and-replication]
== Understanding Scopes, Collections, and Replication

As described in xref:learn:data/scopes-and-collections.adoc[Scopes and Collections], scopes and collections are containers for data within a bucket.
A cluster can contain up to 1000 scopes; and it can contain 1000 collections.

As well as specifying a source bucket and a target bucket, XDCR can specify scopes and collections within those buckets.
This allows data to be replicated from one collection to another.
For more information, see xref:learn:clusters-and-availability/xdcr-overview.adoc#xdcr-with-scopes-and-collections[XDCR with Scopes and Collections].

[#examples-on-this-page]
== Examples on this Page

The examples provided on this page &#8212; xref:manage:manage-xdcr/replicate-using-scopes-and-collections.adoc#migrate-data-to-a-collection[Migrate Data to a Collection], xref:manage:manage-xdcr/replicate-using-scopes-and-collections.adoc#replicate-data-between-collections-implicitly[Replicate Data Between Collections Implicitly], and xref:manage:manage-xdcr/replicate-using-scopes-and-collections.adoc#replicate-data-between-collections-explicitly[Replicate Data Between Collections Explicitly] &#8212; demonstrate how XDCR can be performed with reference to scopes and collections within source and target buckets, using Couchbase Web Console.
The examples assume the following:

* A single-node cluster named `10.144.210.101` has been created, and features the `travel-sample` bucket.
The `travel-sample` bucket contains, by default, only a `_default` scope and a `_default` collection; within which all its data resides.
See xref:manage:manage-settings/install-sample-buckets.adoc[Install Sample Buckets], for information on installing `travel-sample`.

* A single-node cluster named `10.144.210.102` has been created, and features a single, empty bucket, named `ts`.
This bucket contains a scope named `airlineScope`; which itself contains a collection named `airlineCollection`.
For information on creating scopes and collections, see xref:manage:manage-scopes-and-collections/manage-scopes-and-collections.adoc[Manage Scopes and Collections].

* A single-node cluster named `10.144.210.103` has been created, and features a single, empty bucket, named `tsBackup`.
This bucket contains a scope named `airlineScope`; which itself contains a collection named `airlineCollection`.
Note that the scope and collection names on `10.144.210.103` are thus identical to those on `10.144.210.104`.

* A single-node cluster named `10.144.210.104` has been created, and features a single, empty bucket named `tsBackup2`.
This bucket contains a scope named `usAirlineBackupScope`; which itself contains a collection named `usAirlineBackupCollection`.

* The cluster `10.144.210.101` has defined `10.144.210.102`, the cluster `10.144.210.102` has defined `10.144.210.103`, and the cluster `10.144.210.103` has defined `10.144.210.104` as a remote cluster for XDCR: this will permit a chain of replications to be established, from the first cluster to the last.

Before following the examples, familiarity should be gained with XDCR management-basics, explained on other pages. In particular, see xref:manage:manage-xdcr/prepare-for-xdcr.adoc[Prepare for XDCR], xref:manage:manage-xdcr/create-xdcr-reference.adoc[Create a Reference], xref:manage:manage-xdcr/create-xdcr-replication.adoc[Create a Replications], and xref:manage:manage-xdcr/filter-xdcr-replication.adoc[Filter a Replication].

[#migrate-data-to-a-collection]
== Migrate Data to a Collection

By specifying a scope and collection within a target bucket, XDCR can be used to replicate data selectively from the `&#95;default` collection within one bucket to the purpose-created collection within another.
Once such migration is complete, all future replications between collections should be performed with _implicit_ or _explicit_ mapping, as described in the corresponding examples, below.

Before migrating data in a production context, note the following:

* Each established migration rule is CPU-intensive, and may lower XDCR replication performance.
The more migration rules are added, the slower each migration replication will be.
Therefore, the total number of simultaneous migration-rule-based replications per source cluster should be no greater than 2.

* Correspondingly, if migration is to be performed with many rules; the replications should be performed 2 at a time.
On conclusion of those replications, applications intended to use the migrated data should be appropriately switched over.
Then, the next two migration rules should be configured, and the process repeated.
Continue in this way until the overall migration is complete.

Migration can now be exemplified as follows:

. Access the *XDCR Replications* screen of cluster `101.144.210.101`.
Currently, a remote reference to `10.144.210.102` is defined; but no replications have yet been defined.

. Create a replication from `101.144.210.101` to `101.144.210.102`.
Left-click on the *ADD REPLICATION* button, at the upper right of the screen.
The *XDCR Add Replication* screen is now displayed:
+
image::manage-xdcr/xdcr-add-replication-screen.png[,720,align=left]

. Using the three upper fields &#8212; *Replicate From Bucket*, *Remote Cluster*, and *Remote Bucket* &#8212; define a replication from `travel-sample` on `101` to the bucket `ts` on `102`:
+
image::manage-xdcr/xdcr-basic-replication-definition-to-102.png[,560,align=left]
+
Note the confirmatory notification that appears underneath the replication-definition.
As this indicates, if a replication is defined to include any destination-entity &#8212; bucket, scope, or collection &#8212; that does not exist, the entity will be ignored, and no attempt will be made to replicate data to it.
However, if other specified entities are valid, replication to them will proceed.

. To migrate data, switch on the *Migrate collections* toggle, in the middle of the screen:
+
image::manage-xdcr/xdcr-migrate-collections-toggle.png[,520,align=left]
+
Three new fields thus appear, which allow migration to be defined.
*Replication Filter for Source* allows a _regular expression_ to be specified, whereby only a subset of documents within `travel-sample` are replicated.
*Replicate to Collection* allows specification of a collection on the target cluster: the collection must be preceded by the name of the scope that contains it, with scope-name and collection-name comma-separated.
The *Save Mapping* button allows the migration-definition to be saved.

. Specify that _airline_ documents from `travel-sample` be replicated to the collection `airlineScope.airlineCollection`.
Use the regular expression `REGEXP_CONTAINS(META().id, "^airline")`.
The fields now appear as follows:
+
image::manage-xdcr/xdcr-migrate-collections-definition.png[,520,align=left]
+
Left-click on the *Save Mapping* button, to save the mapping:
+
image::manage-xdcr/xdcr-save-mapping-button.png[,150,align=left]
+
Note that the saved rule now appears in the *Mapping Rules* column, at the upper right of the screen:
+
image::manage-xdcr/mapping-rules-migration-definition.png[,200,align=left]

. Save the replication, by left-clicking on the *Save Replication* button, at the bottom of the screen:
+
image::manage-xdcr/saveReplicationButton.png[,140,align=Left]
+
The *XDCR Replications* screen now returns, with the *Outgoing Replications* panel appearing as follows:
+
image::manage-xdcr/xdcr-outgoing-replication-migration.png[,680,align=left]
+
As this indicates, the defined replication is now proceeding from `travel-sample` on the source cluster, to `ts` on the remote.

. On cluster `10.144.210.102`, access the *Buckets* screen, and left-click on the *Documents* tab for the collection `airlineCollection`, within the bucket `ts`.
+
image::manage-xdcr/xdcr-access-usAirlineCollection.png[,680,align=left]
+
The documents within the collection are now displayed:
+
image::manage-xdcr/xdcr-target-collection-filled.png[,680,align=left]
+
This indicates that the `airline` documents from `travel-sample` have been successfully filtered and replicated to the `airlineCollection` collection, within the remote bucket `ts`.

[#replicate-data-between-collections-implicitly]
== Replicate Data Between Collections Implicitly

XDCR allows data to be replicated between collections _implicitly_.

An _implicit_ mapping is one supported by XDCR whenever the same _namespace_ exists within both the source and the target buckets.
The _namespace_ is formed with a _scope-name_ and the _collection-name_.
Therefore, if a source bucket contains the namespace `scope1.collection1`, and the target bucket also contains the namespace `scope1.collection1`, once a replication has been established from the source bucket to the target cluster and bucket, data will be automatically replicated from the source collection to the target collection.
This is demonstrated in the following example.

Proceed as follows.
(Note that this example assumes that the previous example, xref:manage:manage-xdcr/replicate-using-scopes-and-collections.adoc#migrate-data-to-a-collection[Migrate Data to a Collection], has already been followed, and that cluster `101.144.210.102` contains the data that was thereby replicated.)

. Access the *XDCR Replications* screen on cluster `101.144.210.102`.
Currently, this has a remote reference to cluster `101.144.210.103` defined; but no replications have yet been defined.

. Left-click on the *ADD REPLICATION* button, at the upper right, to begin the process of defining a replication.

. When the *XDCR Add Replication* screen is displayed, use the fields in the upper part of the screen to specify a replication from the bucket `ts` to the bucket `tsBackup`, on cluster `101.144.210.103`.
The fields now appear as follows;
+
image::manage-xdcr/xdcr-replicate-to-103.png[,680,align=left]

. Save the replication, by left-clicking on the *Save Replication* button.
+
image::manage-xdcr/saveReplicationButton.png[,140,align=Left]
+
The replication is now started.

. Examine the replication.
First, examine the *XDCR Replications* screen.
+
image::manage-xdcr/outgoingReplicationImplicit.png[,680,align=Left]
+
This confirms that replication is underway.
Next, access cluster `10.144.210.103`, access its *Buckets* screen, and access the *Scopes and Collections* screen for the bucket *tsBackup*.
Then, left-click on the *Documents* tab for the collection *airlineCollection*.
The *Documents* screen for the collection is now displayed, and appears as follows:
+
image::manage-xdcr/documentsImplicitlyReplicated.png[,680,align=Left]

This confirms that all documents within _airlineScope_._airlineCollection_ on `10.144.210.102` have been implicitly replicated to _airlineScope_._airlineCollection_ on `10.144.210.103`.

[#replicate-data-between-collections-explicitly]
== Replicate Data Between Collections Explicitly

An _explicit_ mapping between collections is one established by an administrator, so as to allow replication to occur between differently named collections, and to apply filtering.
This is demonstrated in the following example.
Proceed as follows:

. Access the *XDCR Replications* screen of cluster `101.144.210.103`.
Currently, a remote reference to `10.144.210.104` is defined; but no replications have yet been defined.

. Create a replication from `101.144.210.103` to `101.144.210.104`.
Left-click on the *ADD REPLICATION* button, at the upper right of the screen.
The *XDCR Add Replication* screen is now displayed.

. Using the three upper fields &#8212; *Replicate From Bucket*, *Remote Cluster*, and *Remote Bucket* &#8212; define a replication from `tsBackup` on `103` to the bucket `tsBackup2` on `104`:
+
image::manage-xdcr/xdcr-basic-replication-definition-to-104.png[,560,align=left]


. To begin the process of specifying how data should be replicated between collections, switch on the *Specify scopes, collections, and mapping* toggle, in the middle of the screen:
+
image::manage-xdcr/xdcr-collections-mapping-toggle.png[,520,align=left]
+
Additional UI components are thus displayed.
The principal element is a list of scopes that are defined within the specified source bucket, `ts`.
Note that a `filter scopes` field is provided; which permits strings to be entered, such that only those scopes whose names include matches to the strings are displayed in the list.
+
Note the information that is displayed immediately above the list.
This relates to the presentation of scope-names, in the list's *scope* column.
Each scope-name is succeeded by the `>` symbol, and by a remote scope-name, which is by default assumed to be the name of the scope on the target system, to which replication will occur.
If this assumption is correct, no action need be taken.
However, if a remote scope to which replication is to occur has a different name from the one represented by default in the list, the remote-scope name must be changed: by left-clicking directly on the scope name, and editing the remote-scope name as appropriate.
(Note that this requirement also applies to the representation of collection-names, as will be demonstrated in the next step of this procedure.)
+
In the list currently presented, two scopes appear: which are the `_default` scope, and the scope `airlineScope`.
In this example, data will be replicated from `airlineScope`.

. Left-click on the list-row for `airlineScope`.
The row expands, and appears as follows:
+
image::manage-xdcr/xdcr-scope-row-expansion.png[,520,align=left]
+
The expanded row displays a field whereby collections in the scope can be filtered, based on a string-match.
It also features a *check all* checkbox, which allows all collections to be checked and thereby included in the intended replication; and an *include future collections* checkbox, which, if checked, ensures that collections added to the scope in future will automatically themselves be included in the replication.
+
Currently, the scope contains a single collection, which is `airlineCollection`.
This is checked by default: however, `airlineScope` itself has not yet been checked.
Both `airlineScope` and `airlineCollection` must be specified for inclusion in the replication: note, however, that the default remote-names with which they are associated are incorrect, and must thereby be edited appropriately.
+
Left-click on the scope named `airlineScope`:
+
image::manage-xdcr/xdcr-edit-remote-scope-name.png[,210,align=left]
+
Once focus is obtained, change the remote-scope name to `usAirlineBackupScope`:
+
image::manage-xdcr/xdcr-modified-remote-scope-name.png[,225,align=left]
+
In the same way, modify the remote-collection name associated with `airlineCollection` to `usAirlineBackupCollection`:
+
image::manage-xdcr/xdcr-modified-remote-collection-name.png[,225,align=left]
+
Note that the rules now appear in the *Mapping Rules* column, at the upper right of the screen:
+
image::manage-xdcr/xdcr-mapping-rules-for collections.png[,300,align=left]

. Filter the replication, to ensure that only documents whose `country` value is `United States` are replicated.
Switch on the *Filter replication* toggle, and enter the regular expression `country = "United States"`, into the interactive *Filter Expression* panel:
+
image::manage-xdcr/xdcr-filter-collections-replication.png[,225,align=left]
+
(Note that filtering, once enabled and defined, takes place across _all_ collections-mappings: there is currently no option right now to place individual filters on different collection-to-collection mappings.)

. Save the replication, by left-clicking on the *Save Replication* button, in the lower part of the screen.

The *XDCR Replications* screen is now displayed, with the *Outgoing Replications* panel indicating that replication is occurring as required between `10.144.210.103` and `10.144.210.104`.
Inspection, on `10.144.210.104`, of the collection `usAirlineBackupCollection` will indicate that the subset of documents whose `country` value is `United States` is being replicated into the collection.

[#next-steps-after-replicate-between-scopes-and-collections]
== Next Steps

An XDCR replication can be _filtered_, by means of _regular expressions_; so that only selected documents are replicated from the source to the target cluster.
See xref:manage:manage-xdcr/filter-xdcr-replication.adoc[Filter a Replication].
