= Replicate Using Scopes and Collections

[abstract]
XDCR can be performed with reference to scopes and collections within source and target buckets.

[#understanding-scopes-collections-and-replication]
== Understanding Scopes, Collections, and Replication

As described in xref:learn:data/scopes-and-collections.adoc[Scopes and Collections], scopes and collections are containers for data within a bucket.
A bucket can contain up to 100 scopes; and a scope can contain up to 1000 buckets.

As well as specifying a source bucket and a target bucket, XDCR can specify scopes and collections within those buckets.
This potentially allows the data in the source bucket to be redistributed across different collections in the target bucket.
It also allows a replication to be defined only to replicate a subset of the data within the bucket, in accordance with the specifying of only some of the collections that the bucket contains.

XDCR advanced filtering can continue to be used on replications that specify one or more source collections, so that only a subset of the data those collections contain is replicated.

[#examples-on-this-page]
== Examples on this Page
The examples provided on this page demonstrate how XDCR can be performed with reference to scopes and collections within source and target buckets, using Couchbase Web Console.
The examples assume the following:

* A single-node cluster named `10.144.210.101` has been created, and features the `travel-sample` bucket.
The `travel-sample` bucket contains, by default, only a `_default` scope and a `_default` collection; within which all its data resides.
See xref:manage:manage-settings/install-sample-buckets.adoc[Install Sample Buckets], for information on installing `travel-sample`.

* A single-node cluster named `10.144.210.102` has been created, and features a single, empty bucket, named `ts`.
This bucket contains a scope named `airlineScope`; which itself contains a collection named `usAirlineCollection`.
For information on creating scopes and collections, see xref:manage:manage-scopes-and-collections/manage-scopes-and-collections.adoc[Manage Scopes and Collections].

* A single-node cluster named `10.144.210.103` has been created, and features a single, empty bucket, named `tsBackup`.
This bucket contains a scope named `airlineBackupScope`; which itself contains a collection named `usAirlineBackupCollection`.

* The cluster `10.144.210.101` has defined `10.144.210.102` as a remote cluster for XDCR.
In turn, the cluster `10.144.210.102` has defined `10.144.210.103` as a remote cluster for XDCR.
As the following examples show, this allows data to be selectively replicated from `101` to `102`; and again replicated from `102` to `103`.
+
For information on establishing a remote cluster for XDCR, see xref:manage:manage-xdcr/create-xdcr-reference.adoc[Create a Reference].

[#migrate-data-to-a-collection]
== Example 1: Migrate Data to a Collection

By specifying a scope and collection within a target bucket, XDCR can be used to replicate data selectively from the `_default` collection within one bucket to the purpose-created collection within another.

Proceed as follows:

. Access the *XDCR Replications* screen of cluster `101.144.210.101`.
Currently, a remote reference to `10.144.210.102` is defined; but no replications have yet been defined.

. Create a replication from `101.144.210.101` to `101.144.210.102`.
Left-click on the *ADD REPLICATION* button, at the upper right of the screen.
The *XDCR Add Replication* screen is now displayed:
+
image::manage-xdcr/xdcr-add-replication-screen.png[,720,align=left]

. Using the three upper fields &#8212; *Replicate From Bucket*, *Remote Cluster*, and *Remote Bucket* &#8212; define a replication from `travel-sample` on `101` to the bucket `ts` on `102`:
+
image::manage-xdcr/xdcr-basic-replication-definition-to-102.png[,560,align=left]
+
Note the confirmatory notification that appears underneath the replication-definition.
As this indicates, if a replication is defined to include any destination-entity &#8212; bucket, scope, or collection &#8212; that does not exist, the entity will be ignored, and no attempt will be made to replicate data to it.
However, if other specified entities are valid, replication to them will proceed.

. To migrate data, switch on the *Migrate collections* toggle, in the middle of the screen:
+
image::manage-xdcr/xdcr-migrate-collections-toggle.png[,520,align=left]
+
Three new fields thus appear, which allow migration to be defined.
*Replication Filter for Source* allows a _regular expression_ to be specified, whereby only a subset of documents within `travel-sample` are replicated.
*Replicate to Collection* allows specification of a collection on the target cluster: the collection must be preceded by the name of the scope that contains it, with scope-name and collection-name comma-separated.
The *Save Mapping* button allows the migration-definition to be saved.

. Specify that _airline_ documents from `travel-sample` be replicated to the collection `airlineScope.usAirlineCollection`.
Use the regular expression `REGEXP_CONTAINS(META().id, "^airline")`.
The fields now appear as follows:
+
image::manage-xdcr/xdcr-migrate-collections-definition.png[,520,align=left]
+
Left-click on the *Save Mapping* button, to save the mapping:
+
image::manage-xdcr/xdcr-save-mapping-button.png[,150,align=left]
+
Note that the saved rule now appears in the *Mapping Rules* column, at the upper right of the screen:
+
image::manage-xdcr/mapping-rules-migration-definition.png[,200,align=left]

. Save the replication, by left-clicking on the *Save Replication* button, at the bottom of the screen:
+
image::manage-xdcr/saveReplicationButton.png[,140,align=Left]
+
The *XDCR Replications* screen now returns, with the *Outgoing Replications* panel appearing as follows:
+
image::manage-xdcr/xdcr-outgoing-replication-migration.png[,680,align=left]
+
As this indicates, the defined replication is now proceeding from `travel-sample` on the source cluster, to `ts` on the remote.

. On cluster `10.144.210.102`, the *Documents* tab for the collection `usAirlineCollection`, within the bucket `ts`.
+
image::manage-xdcr/xdcr-access-usAirlineCollection.png[,680,align=left]
+
The documents within the collection are now displayed:
+
image::manage-xdcr/xdcr-target-collection-filled.png[,680,align=left]
+
This indicates that the `airline` documents from `travel-sample` have been successfully filtered and replicated to the `usAirlineCollection` collection, within the remote bucket `ts`.
