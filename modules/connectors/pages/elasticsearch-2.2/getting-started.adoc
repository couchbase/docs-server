[#topic1645]
= Getting Started

[abstract]
Once installation and configuration of the three principal components are complete, you can replicate data from Couchbase to Elasticsearch; run Elasticsearch text-based queries on the replicated Couchbase data; and use document IDs returned by Elasticsearch to initiate queries on Couchbase, thereby returning full Couchbase documents.
This section explains how to accomplish these tasks both manually and programmatically.

== Replicate Data from Couchbase Server to Elasticsearch

Data-replication from Couchbase Server to Elasticsearch is managed by means of the _XDCR_ facility, accessible from the Couchbase Web Console.

Proceed as follows:

. Within the virtual environment, using the browser, access the Couchbase Web Console, at the _localhost_ address of your virtual machine, on the 8091 port:
+
[#couchbaseConsoleInitial]
image::elasticsearch-2.2/images/couchbaseConsoleInitial.png[,540,align=left]

. Select the [.uicontrol]*XDCR* option, on the upper toolbar:
+
[#XDCRoption]
image::elasticsearch-2.2/images/selectXDCR.png[,86,align=left]
+
{blank}
+
This brings up the [.uicontrol]*XDCR* interface, as follows:
+
{blank}
+
[#XDCRui]
image::elasticsearch-2.2/images/xdcrInitial.png[,540,align=left]

. Left-click on the btn:[Create Cluster Reference] button, at the upper-right of the [.uicontrol]*REMOTE CLUSTERS* panel:
+
[#createClusterRef]
image::elasticsearch-2.2/images/selectCreateClusterReference.png[,204,align=left]
+
{blank}
+
The following dialog now appears:
+
{blank}
+
[#createClusterRefDialog]
image::elasticsearch-2.2/images/createClusterReferenceDialog.png[,320,align=left]
+
{blank}
+
Enter appropriate data into the fields of this dialog, and then left-click on the [.uicontrol]*Save* button.
The [.uicontrol]*Cluster Name* can be any name of your choice, to refer to your Elasticsearch cluster.
The [.uicontrol]*IP/hostname* should be the port-number 9091, appended to the word `localhost`.
The [.uicontrol]*Username* and [.uicontrol]*Password* are those you have established for your Elasticsearch cluster, in the `elasticsearch.yml` configuration-file.
You do not need to enable TLS encryption.
+
{blank}
+
The Couchbase Web Console now appears as follows:
+
{blank}
+
[#createClusterReferenceCreated]
image::elasticsearch-2.2/images/clusterReferenceCreated.png[,520,align=left]

. Left-click on the btn:[Create Replication] button, to the upper-right of the [.uicontrol]*ONGOING REPLICATIONS* panel.
The following dialog appears:
+
[#createReplicationDialog]
image::elasticsearch-2.2/images/createReplicationDialog.png[,380,align=left]
+
{blank}
+
Enter appropriate data into the fields of this dialog.
The [.uicontrol]*Bucket* should be the bucket whose data you intend to replicate to Elasticsearch (previously designated as _beer-sample_).
The [.uicontrol]*Cluster* should be the Elasticsearch cluster you previously created; which you now select from the drop-down menu:
+
{blank}
+
[#pickRemoteCluster]
image::elasticsearch-2.2/images/pickRemoteCluster.png[,220,align=left]
+
{blank}
+
The [.uicontrol]*Bucket* should be the name of the Elasticsearch index you specified to handle data replicated from Couchbase: which was _beer-sample_.
+
{blank}
+
Next, left-click on [.uicontrol]*Advanced settings*.
The following dialog appears:
+
{blank}
+
[#advancedSettings]
image::elasticsearch-2.2/images/advancedSettings.png[,380,align=left]
+
{blank}
+
Since replication from Couchbase to Elasticsearch is supported only by Version 1 of the XDCR Protocol, you must change the value of the [.uicontrol]*XDCR Protocol* correspondingly, by accessing the pull-down menu, as follows:
+
{blank}
+
[#selectVersion1]
image::elasticsearch-2.2/images/selectVersion1.png[,220,align=left]
+
{blank}
+
Left-click on the btn:[Replicate] button, at the lower-right of the dialog.

At this point, replication from Couchbase to Elasticsearch begins.
This is represented within the [.uicontrol]*ONGOING REPLICATIONS* panel, as follows:

[#replicationInProgress]
image::elasticsearch-2.2/images/replicationInProgress.png[,480,align=left]

== Query Elasticsearch Data Manually

The simplest Elasticsearch query takes the form of a Lucene-based string; and can be dispatched as an HTTP request.
For example, on the command-line, within the virtual environment, enter the following:

 $ curl http://localhost:9200/beer-sample/_search?q=Classic-Special-Brew\
 > +AND+North+American+Lager

This searches the Elasticsearch repository for items that each contain the two strings `Classic Special Brew` and `North American Lager`.
Output takes approximately the following appearance:

[source,bash]
----
{"took":35,"timed_out":false,"_shards":{"total":5,"successful":5,"failed":0},"hits":{"total":156,
"max_score":1.7641015,"hits":[{"_index":"beer-sample","_type":"couchbaseDocument","_id":"aass_bre
wery-classic_special_brew","_score":1.7641015,"_source":{"meta":{"rev":"1-14987863e28400010000000
002000006","flags":33554438,"expiration":0,"id":"aass_brewery-classic_special_brew"}}},{"_index":
"beer-sample","_type":"couchbaseDocument","_id":"otter_creek_brewing_wolaver_s_organic_ales-vermo
nt_lager","_score":0.7017108,"_source":{"meta":{"rev":"1-14987864700e00000000000002000006","flags
":33554438,"expiration":0,"id":"otter_creek_brewing_wolaver_s_organic_ales-vermont_lager"}}},{"_i
ndex":"beer-sample","_type":"couchbaseDocument","_id":"blue_point_brewing-toasted_lager","_score"
:0.68838316,"_source":{"meta":{"rev":"1-14987864d3f500010000000002000006","flags":33554438,"expir
ation":0,"id":"blue_point_brewing-toasted_lager"}}},{"_index":"beer-sample","_type":"couchbaseDoc
ument","_id":"seabright_brewery-brew_ribbon","_score":0.65299296,"_source":{"meta":{"rev":"1-1498
786402b300000000000002000006","flags":33554438,"expiration":0,"id":"seabright_brewery-brew_ribbon
"}}},   .   .   .
----

Note that the appearance of the JSON documents here displayed can be improved by installation and use of a tool such as *jq*:

[source,bash]
----
$ curl http://localhost:9200/beer-sample/_search?q=Classic-Special-Brew\
> +AND+North+American+Lager | jq
{
    "took": 27,
    "timed_out": false,
    "_shards": {
        "total": 5,
        "successful": 5,
        "failed": 0
    },
    "hits": {
        "total": 156,
        "max_score": 1.7641015,
        "hits": [
    {
    "_index": "beer-sample",
    "_type": "couchbaseDocument",
    "_id": "aass_brewery-classic_special_brew",
    "_score": 1.7641015,
    "_source": {
        "meta": {
            "rev": "1-14987863e28400010000000002000006",
            "flags": 33554438,
            "expiration": 0,
            "id": "aass_brewery-classic_special_brew"
            }
            .
            .
            .
----

Alternatively, more complex forms of query can be performed by means of the Elasticsearch REST API.
For example, you can use the following JSON construct:

[source,bash]
----
{
    "query": {
        "query_string": {
            "query": "North American Lager AND Classic Special Brew"
        }
    }
}
----

For example, enter the following at the command prompt:

[source,bash]
----
$ curl -XPOST 'localhost:9200/beer-sample/_search?pretty' -d'{"query": \
> {"query_string": {"query": "North American Lager AND \
> Classic Special Brew"}}}'
----

This produces the same output as the Lucene-based example.

For more information on Elasticsearch query-options, see https://www.elastic.co/guide/en/elasticsearch/reference/current/_introducing_the_query_language.html[Introducing the Query Language], in the Elasticsearch API documentation.

== Use the Elasticsearch Web UI

The Elasticsearch Web UI is located at http://localhost:9200:/_plugin/head/[], and appears as follows:

[#esWebUI]
image::elasticsearch-2.2/images/elasticsearchConsole.png[,480,align=left]

The `docs` field indicates the number of items indexed by Elasticsearch.
Note that this may be greater than the actual number of documents in Couchbase server; because XDCR and the Couchbase Plug-in send additional documents, describing the status of replication.
The UI provides various options for performing Elasticsearch queries, which you can experiment with as appropriate.

== Examine Elasticsearch Responses

As indicated by the output shown above, responses to Elasticsearch queries contain data on the following:

* _Search-performance_.
The `took` parameter indicates the number of milliseconds required for the search; while fields within the `_shards` object indicate how many Elasticsearch shards were available for search, how many were accessed successfully, and how many unsuccessfully.
+
{blank}

* _Items matched_.
The `total` field indicates the total number of items.
A `max_score` is provided, to indicate Elasticsearch’s estimate of the relevance of each search-hit.
Note that the `source` object contains only metadata, rather than a document’s entire contents: this is because the contents, if and when required, can more rapidly be retrieved from Couchbase itself; using the document ID that is the value of the `_id` field.

== Use Elasticsearch Responses to Query Couchbase Manually

The contents of the `_id` field, returned from an Elasticsearch query, can be used to retrieve the entire corresponding document from Couchbase.
Ensure Couchbase is running; then, proceed as follows:

. Access the Couchbase Web Console, at http://localhost:8091:/[].
+
{blank}

. Left-click on the Data Buckets tab, near the top:
+
[#dataBucketsTab]
image::elasticsearch-2.2/images/dataBucketsTab.png[,120,align=left]
+
{blank}
+
This brings up the [.uicontrol]*Couchbase Buckets* screen.

. Left-click on the btn:[Documents] button, towards the right of the [.uicontrol]*beer-sample* row:
+
[#beerSampleLine]
image::elasticsearch-2.2/images/beerSampleLine.png[,480,align=left]
+
{blank}
+
This brings up the [.uicontrol]*Documents* screen for the beer-sample bucket:
+
{blank}
+
[#beerSampleDocuments]
image::elasticsearch-2.2/images/beerSampleDocuments.png[,480,align=left]

. In the text-field to the left of the btn:[Lookup Id] button, enter the document-ID retrieved from the Elasticsearch output:
+
[#beerSampleDocumentsLookUpField]
image::elasticsearch-2.2/images/beerSampleDocumentsLookUpField.png[,320,align=left]
+
{blank}
+
Then, left-click on the btn:[Lookup Id] button.
This brings up a display containing the document associated with the specified ID:
+
{blank}
+
[#beerSampleDocumentsLookUpResults]
image::elasticsearch-2.2/images/beerSampleDocumentsLookUpResults.png[,480,align=left]

== Query Elasticsearch and Couchbase Programmatically

This section provides an example of searching Elasticsearch and Couchbase Server programmatically.
A JavaScript routine within an html page makes calls on two node.js servers: one being responsible for running server-side queries on Elasticsearch; the other, on Couchbase Server.
The structure is as follows:

[#codeExampleDiagram]
image::elasticsearch-2.2/images/codeExampleDiagram.png[,520,align=left]

The annotations to this diagram are as follows:

. The html interface allows the user to select a beer-style.
On selection, a `getJSON` call passes the style, in the form of a key-value pair, to the node.js program _esNodeJsQueryAgent_.
+
{blank}

. The node.js routine performs an Elasticsearch query on the existing _beer-sample_ index: the returned documents each contain an ID corresponding to a particular beer, which is described by the specified style.
+
{blank}

. The documents are passed back to the client-side, where the IDs are retrieved.
Each is displayed for the user.
+
{blank}

. The client passes each ID to the node.js program _cbNodeJsQueryAgent_.
+
{blank}

. The program cbNodeJsQueryAgent duly queries Couchbase.
Couchbase returns, for each ID, a document containing detailed information on the beer specified by the ID.
+
{blank}

. Each document is returned to the client-side routine, which displays the results for the user.
+
{blank}

== Access Source-Files

You can access the three source-files for the example at this location: https://github.com/couchbaselabs/elasticsearchdemo/tree/master[].
The following sections of the current document provide a brief summary of the functionality.

== Client-Side HTML and JavaScript

The file _couchbaseESqueryDemo.html_ provides html-based interactive elements for the selection of beer-styles and the display of query-results.
Beer-styles can be selected by means of a series of radio-buttons, within a dialog named `availableBeerStylesDialog`.

A value is associated with each possible radio-button selection.
When the user left-clicks on the btn:[Query Elasticsearch] button, this value is retrieved:

[source,javascript]
----
$("#queryElasticsearch").click(function(event)
{  
    // Get the user's radio-button selection, which corresonds to a particular
    // beer style.
    // 
    var beerStyles = document.getElementsByName("beerStyle");
    var selectedBeerValue = 0;
    var selectedBeerStyle = "";

    for (var i = 0; i < beerStyles.length; i++) 
    {
        if (beerStyles[i].checked == true) 
        {
            selectedBeerValue = beerStyles[i].value;
        }
    }
----

The value is then used to determine the style-name, which will be passed to Elasticsearch, and used in a search-procedure.

[source,javascript]
----
if (selectedBeerValue == 0)
{
    selectedBeerStyle = "American-Style Pale Ale";
} 
else 
{
    if (selectedBeerValue == 1)
    {
        selectedBeerStyle = "American-Style Brown Ale";
    }
    else
    {
        if (selectedBeerValue == 2)
----

A corresponding Elasticsearch query is then prepared and executed:

[source,javascript]
----
var esNodeJsAddress = "http://localhost:8081/";
var esNodeJsTargetURL = esNodeJsAddress + '?' + "foo=" + selectedBeerStyle;

$.getJSON(esNodeJsTargetURL, function(dataFromElasticsearch)  
{
----

Retrieved IDs are, first, assembled and displayed:

[source,javascript]
----
$.each(dataFromElasticsearch, function(key, val) 
{	
    esDataDisplayString = esDataDisplayString + '<p>' + dataFromElasticsearch[key]._id + '</p>';
    numberOfIds++;
});

document.getElementById('ElasticSearchRetrievalsContent').innerHTML = esDataDisplayString;
----

Then, the IDs are dispatched as an array, to _cbNodeJsQueryAgent_, so that Couchbase Server can be searched for each of them.

[source,javascript]
----
cbNodeJsTargetURL = cbNodeJsAddress + '?' + keyNameForIDparam + '=' 
+ returnedCouchbaseIDsStringed + '&' + countKey + '=' + numberOfIds;

$.getJSON(cbNodeJsTargetURL, function(dataReturnedFromCouchbase) 
{
----

An array of documents is returned, each of which is duly displayed:

[source,javascript]
----
for (var currentKeyPosition = 0; currentKeyPosition < numberOfIds; currentKeyPosition++)
{	
					
    $.each(JSON.parse(dataReturnedFromCouchbase[currentKeyPosition]), function(key, val) 
    {
        cbDataDisplayString =  '<p>' + cbDataDisplayString + "\"" + key + "\"" 
            + " : " + "\"" + val + "\"" + '</p>';
    });
}

document.getElementById('CouchbaseRetrievalsContent').innerHTML = cbDataDisplayString;
----

== Server-Side node.js for Elasticsearch

The file _esNodeJsQueryAgent.js_ uses the require function to add appropriate modules, including the module for the Elasticsearch client.
It then creates an instance of the client:

[source,javascript]
----
var http = require('http');
var url = require('url');
var elasticsearch = require('elasticsearch');
var client = new elasticsearch.Client({
    host: 'localhost:9200',
    log: 'trace'
});
----

An http server is then created:

[source,javascript]
----
http.createServer(function (request, response) 
{
console.log('New connection');
----

The server is directed (near the end of the file) to listen on port 8081:

----
}).listen(8081);
----

The value passed to the program by couchbaseESqueryDemo is retrieved, by referencing its known key:

[source,javascript]
----
var queryObject = url.parse(request.url, true).query
		
var luceneString = queryObject.foo;
----

Then, an appropriate query-string is created, to be passed to Elasticsearch:

[source,javascript]
----
var clientSearchStringStart = 
    "{index: 'beer-sample', body: { query: { query_string: { query: ";
var clientSearchStringEnd = "}}}}"
var clientSearchStringFull = clientSearchStringStart + "\"" + luceneString + "\"" + clientSearchStringEnd;
var extendedLuceneString = "\"" + luceneString + "\"";
----

Next, the Elasticsearch query is made, on the _beer-sample_ index:

[source,javascript]
----
client.search({
    index:'beer-sample',
    body: {
        query: {
            query_string: {
                query: luceneString
            }
        }
     }
 }).then(function(resp){
     hits = resp.hits.hits;
     console.log("Hits are: " + JSON.stringify(hits));
----

The retrieved data is then passed back to couchbaseESqueryDemo:

[source,javascript]
----
response.writeHead(200, {"Content-Type": "application/json", "Access-Control-Allow-Origin": "*"});
response.end(JSON.stringify(hits));
----

== Server-Side node.js for Couchbase

Having used the require function to include modules for url and http, cbNodeJsQueryAgent creates an http server, and specifies that it will listen on port 8080.

It then parses the query-URL, and obtains the ID-array, provided by couchbaseESqueryDemo.
It then prepares to access Couchbase on its default port:

[source,javascript]
----
var queryObject = url.parse(request.url, true).query

var couchbase = require("couchbase");
var myCluster = new couchbase.Cluster('couchbase://localhost');
var myBucket = myCluster.openBucket('beer-sample');
----

Next, the function _searchCouchbaseForNextID_ is called recursively, once for each ID in the array.
The function itself invokes the Couchbase SDK _get_ method, to search Couchbase Server for a single ID.
(Note that this method is asynchronous.) Once all IDs have been searched for, a response containing an array of retrieved documents is provided to the client.

[source,javascript]
----
function searchCouchbaseForNextID(arrayOfIDs, count, totalCount)
{
    myBucket.get(arrayOfIDs[count], function(err, res)  
    {
	    couchbaseObjectArray[count] = JSON.stringify(res.value);
	
	    if (count < totalCount)
	    {
	        count++;
	        searchCouchbaseForNextID(receivedArray, count, totalCount);
	    } 
	    else 
	    {
	        response.writeHead(200, {"Content-Type": "application/json", 
                "Access-Control-Allow-Origin": "*"});
	        response.end(JSON.stringify(couchbaseObjectArray));
	    }
    });
}
----

== Setting Up the Example

Successful running of the example requires that Couchbase Server and Elasticsearch both be already installed, configured, and running.
The instructions in this section assume that all are on the same node, and that all services can thus be accessed from localhost.

Note that the node.js program esNodeJsQueryAgent.js has been written to run on port 8081; and cbNodeJsQueryAgent.js on port 8080.
If you wish to change these port-designations, you must edit the program-files, including that for couchbaseESqueryDemo.html.

To run the provided node.js programs, you must install both the Couchbase SDK and node.js Elasticsearch client; which in turn requires that you install and use the Node Package Manager, _npm_.
On non-Windows platforms, you may also need to install _node-gyp_.

For information on installing the node.js instance of the Couchbase SDK see the documentation at https://developer.couchbase.com/documentation/server/current/sdk/nodejs/start-using-sdk.html[Start Using the SDK].
See also the Elasticsearch documentation for installing the Elasticsearch client, at https://www.elastic.co/guide/en/elasticsearch/client/javascript-api/current/about.html[About].

When you have installed the required SDK, start cbNodeJsQueryAgent at the command-line, as follows:

[source,bash]
----
$ node cbNodeJsQueryAgent.js
----

The message _Server started_ is provided in response.

Start esNodeJsQueryAgent in a separate terminal, as follows:

[source,bash]
----
$ node esNodeJsQueryAgent.js
----

A repsonse is provided, confirming that the program has been added as a connection to http://localhost:9200, which is the Elasticsearch port.

Now, bring up couchbaseESqueryDemo.html in a browser.
The layout appears as follows:

[#demoUIinitial]
image::elasticsearch-2.2/images/demoUIinitial.png[,520,align=left]

The UI features three principal elements.
at the upper-left, a dialog presents a series of radio-butons, permitting selection from a number of beer-styles.
At the lower-left, a pane is provided for the display of IDs retrieved from Elasticsearch; at the right, a pane for the display of documents retrieved from Couchbase.

Each beer-style can be selected by its corresponding radio-button.
For example:

[#demoUIradioButtons]
image::elasticsearch-2.2/images/demoUIradioButtons.png[,240,align=left]

Once a beer-style has been selected, querying can be initiated by left-clicking on the btn:[Query Elasticsearch] button.

[#demoUIqueryESbutton]
image::elasticsearch-2.2/images/demoUIqueryESbutton.png[,180,align=left]

The full query-routine is duly performed: the beer-style is passed to Elasticsearch, and queried on; ID-information is returned to the client; then, ID-information is queried against Couchbase Server.
Elements retrieved from both repositories are displayed in the appropriate panes:

[#demoUIfullQueryResults]
image::elasticsearch-2.2/images/demoUIfullQueryResults.png[,520,align=left]

The panes can be scrolled as needed, to reveal the full set of results.

== Using Advanced Lucene Strings

In the above example, since a single beer-style was used as the basis for an Elasticsearch query, the Lucene string submitted was simply the style-name.
Note that (as in the case of the curl command-line example provided earlier) more complex queries can be submitted, with the full syntactical form of the query simply submitted as the string.
For example, the string `American-Style Pale Ale` might be replaced by `American-Style Pale Ale AND American-Style Brown Ale`.
