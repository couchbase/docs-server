= Deep Traversal for Nested Documents
:page-topic-type: guide
:imagesdir: ../../assets/images
:tabs:
:description: How to join data sources for a N1QL selection query, and how to use subqueries.

[abstract]
{description}

== Introduction

Couchbase Server is a document database.
Data is stored as JSON documents in keyspaces, rather than as rows in tables.
This means that documents can contain arrays of embedded subdocuments.
N1QL provides syntax which enables you to _unnest_ (flatten) or _nest_ (create) arrays of embedded documents in a query.

== Before You Begin

If you want to try out the examples in this section, follow the instructions given in xref:getting-started:do-a-quick-install.adoc[Do a Quick Install] to install Couchbase Server, configure a cluster, and load a sample dataset.

== Query Tools

Read the following for further information about the tools available for editing and executing queries:

* xref:tools:cbq-shell.adoc[cbq: The Command Line Shell for N1QL]
+
....
cbq> 
....

* xref:tools:query-workbench.adoc[Query Workbench]
+
image::manage:manage-ui/queryTab.png[,100,align=left]

== Unnesting Data

Unnesting data is like creating joins from a parent document to subdocuments in an array within that document.
In the resultset, the subdocuments are flattened and joined to the parent document.

To unnest subdocuments from an array, use the UNNEST clause.
The following query unnests the schedule data from within the route document to get a list of flights on Monday 1 (day `1`).

====
[source,n1ql]
----
include::n1ql:example$select/unnest.n1ql[]
----

.Results
[source,json]
----
include::n1ql:example$select/unnest.jsonc[]
----
====

For more information and examples, refer to xref:n1ql:n1ql-language-reference/unnest.adoc[UNNEST Clause].

== Nesting Data

Nesting data is the opposite of unnesting.
Nesting is like creating joins from a document to documents in another keyspace.
However, in the resultset, the joined documents are embedded in an array within the parent document.

There are three ways of nesting data: ANSI nests, lookup nests, and index nests.

=== ANSI Nests

To nest using arbitrary fields, use an ANSI nest clause.


=== Lookup Nests

=== Index Nests

== Next Steps

* xref:join.adoc[Querying Across Relationships]

== Related Links

Reference and explanation:

* xref:n1ql:n1ql-language-reference/join.adoc[JOIN Clause]

Tutorials:

* https://query-tutorial.couchbase.com/tutorial/#1[N1QL Query Language Tutorial^]

Querying with SDKs:

* xref:c-sdk:howtos:n1ql-queries-with-sdk.adoc[C]
| xref:dotnet-sdk:howtos:n1ql-queries-with-sdk.adoc[.NET]
| xref:go-sdk:howtos:n1ql-queries-with-sdk.adoc[Go]
| xref:java-sdk:howtos:n1ql-queries-with-sdk.adoc[Java]
| xref:nodejs-sdk:howtos:n1ql-queries-with-sdk.adoc[Node.js]
| xref:php-sdk:howtos:n1ql-queries-with-sdk.adoc[PHP]
| xref:python-sdk:howtos:n1ql-queries-with-sdk.adoc[Python]
| xref:ruby-sdk:howtos:n1ql-queries-with-sdk.adoc[Ruby]
| xref:scala-sdk:howtos:n1ql-queries-with-sdk.adoc[Scala]

