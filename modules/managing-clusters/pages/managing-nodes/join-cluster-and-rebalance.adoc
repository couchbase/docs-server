= Join a Cluster and Rebalance

[abstract]
An independent Couchbase Server-node can be joined to an existing cluster.

[#understanding-the-join-operation]
== Understanding the Join Operation

_Full_ and _Cluster_ administrators can use the UI, CLI, or REST API
to join a Couchbase Server nodes to an existing cluster. On each node
to be added, Couchbase Server must have been _installed and started_.
The process of node-addition grants to the new node the
settings already established for the parent cluster. (See
xref:managing-clusters:managing-settings/manage-settings.adoc[Manage
Settings] for details.) The process allow services to be assigned to
the new node. If the new node was previously _initialized_ with
custom disk-paths, these are retained. All aspects of _provisioning_
that may previously have occurred on the new node are eliminated: this
includes buckets, services, and settings.

Following node-addition, _rebalance_ is required, to make the new node
and active member of the cluster.

Note that this process has the same effect as that described in
xref:managing-clusters:managing-nodes/add-node-and-rebalance.adoc[Add a Node and Rebalance].
The difference is that here, the process is inverted: rather than a
cluster adding a node to itself, a node is joining itself to a cluster.

[#examples-on-this-page-node-addition]
== Examples on This Page

The examples in the subsections below show how the same uninitialized and
unprovisioned node joins itself to the same existing cluster, using the
xref:managing-clusters:managing-nodes/join-cluster-and-rebalance.adoc#join-a-cluster-with-the-ui[UI],
the
xref:managing-clusters:managing-nodes/join-cluster-and-rebalance.adoc#join-a-cluster-with-the-ui[UI],
and the
xref:managing-clusters:managing-nodes/join-cluster-and-rebalance.adoc#join-a-cluster-with-the-rest-api[REST
API] respectively. No node-join is supported by the CLI.

The examples assume:

* A one-node cluster already exists; and is named after its
IP address: `10.142.181.101`. It is running the Data, Query, and
Index services, and has the `travel-sample` bucket installed
(To access and install this, see
xref:settings:install-sample-buckets.adoc[Sample Buckets].)

* A new node has been started. This is named after its IP address:
`10.142.181.101`. It has not been initialized or provisioned.

* The cluster has the Full Administrator username of
`Administrator`, and password of `password`.

[#join-a-cluster-with-the-ui]
== Join a Cluster with the UI

Proceed as follows:

. Bring up Couchbase Web Console, and acccess the new node's
Couchbase Web Console instance, at `10.142.181.102:8091`. The
welcome screen is displayed:
+
[#new-node-welcome-screen]
image::managing-nodes/newNodeWelcomeScreen.png[,400,align=middle]

. Left-click on the *Join Existing Cluster* button:
+
[#join-existing-cluster-button]
image::managing-nodes/joinExistingClusterButton.png[,230,align=middle]
+
This brings up the *Join Cluster* dialog:
+
[#join-cluster-dialog]
image::managing-nodes/joinClusterDialog.png[,400,align=middle]

. Left-click on the *Configure Services & Setings For This Node* control. The
dialog expands vertically, as follows:
+
[#join-cluster-dialog-expanded]
image::managing-nodes/joinClusterDialogExpanded.png[,400,align=middle]
+
The expanded dialog allows specification of the services, the name and
IP address, and the disk paths for the new node. It also requires the
username and password of the *Cluster Admin* (although the credentials
of the *Full Admin* for the cluster are equally implied), and the name
or IP address of the cluster to be joined.

. Enter the cluster-name and password, and uncheck all *Services* fields
except *Data*. Leave
all other details unchanged. Then, left-click on the *Join With Custom
Configuration* button, at the lower right.
+
The dashboard for the cluster now appears. The following notification is
provided along the top:
+
[#server-association-message]
image::managing-nodes/serverAssociationMessage.png[,600,align=middle]

. Access the *Servers* screen, by left-clicking on the *Servers* tab, on
the left-hand navigation bar. The display is as follows:
+
[#servers-screen-with-node-added]
image::managing-nodes/twoNodeClusterAfterAddNodeExpanded.png[,800,align=middle]
+
This indicates that the new node, `10.142.181.102` has successfully
joined the cluster. However, it is not yet taking traffic, and will be added following
a _rebalance_. Note, at this point, the figure under the *Items* column for
for `10.142.181.101`: this is `31.1 K/0`, which indicates that the node
contains 3.1 K items in _active_ vBuckets, and 0 items in _replica_ vBuckets.
Meanwhile, the *Items* figure for `10.142.181.102` is 0/0, indicating that no
items are yet distributed onto that node in either active or replica form.
+
To access information on buckets, vBuckets, and intra-cluster replication,
see the
xref:understanding-couchbase:understanding-couchbase.adoc[Architecture
Overview].

. To rebalance the cluster, and thereby fully add the new node, left-click on
the *Rebalance* button, at the upper right:
+
[#rebalance-button]
image::managing-nodes/rebalanceButton.png[,140,align=middle]
+
Rebalance occurs, and the *Servers* display reflects the successful
outcome:
+
[#servers-screen-with-node-added-after-rebalance]
image::managing-nodes/twoNodeClusterAfterRebalance.png[,800,align=middle]
+
This indicates that cluster `10.142.181.101` now contains two fully
functioning nodes, which are `10.142.181.101` and `10.142.181.102`. (Note
that the figure in the *Items* column for node `10.142.181.101` is
`15.2 K/15.8 K`, which indicates that 15.2 K items are stored on the node in
_active_ vBuckets, and 15.8 K in _replica_ vBuckets. The figure for
`10.142.181.102` indicates the converse. Therefore, replication has
successfully distributed the contents of `travel-sample` across both nodes,
providing a single replica vBucket for each active vBucket.)

[#join-a-cluster-with-the-rest-api]
== Join a Cluster with the REST API

To join a node to a cluster with the REST API, use the
`/node/controller/doJoinCluster` URI. Enter the following:

----
curl -u Administrator:password -v -X POST \
http://10.142.181.102:8091/node/controller/doJoinCluster \
-d 'hostname=10.142.181.101&user=Administrator&password=password&services=kv'
----

The `hostname` and `user`(-name) and `password` of the Full Administrator for
the cluster to be joined are specified. The service specified to be run on
the new node is `kv`, signifying the Data Server.

At this point, the newly joined node must be rebalanced into the cluster.
Use the `/controller/rebalance` URI, as follows:

----
curl -u Administrator:password -v -X POST \
10.142.181.101:8091/controller/rebalance \
-d 'knownNodes=ns_1@10.142.181.101,ns_1@10.142.181.102'
----

Note that the `knownNodes` argument lists each of the nodes in the
cluster.
If successful, the command returns no output.

For further information on joining a cluster with the REST API, see
xref:rest-api:rest-cluster-joinnode.adoc[Joining Nodes into Clusters]; on
rebalancing, see
xref:rest-api:rest-cluster-rebalance.adoc[Rebalancing Nodes].

[#next-steps-after-joining-and-rebalancing]
== Next Steps

Couchbase Server allows you to list the nodes within a cluster. See
xref:managing-clusters:managing-nodes/list-cluster-nodes.adoc[List Cluster Nodes]
for details.
