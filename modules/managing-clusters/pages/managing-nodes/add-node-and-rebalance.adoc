= Add a Node and Rebalance

[abstract]
A new Couchbase Server node can be added to an existing cluster.

[#understanding-node-addition]
== Understanding Node-Addition

_Full_ and _Cluster_ administrators can use the UI, CLI, or REST API
to add Couchbase Server nodes to existing clusters. On each node
to be added, Couchbase Server must have been _installed and started_.
The process of node-addition grants to the new node the
settings already established for the parent cluster. (See
xref:managing-clusters:managing-settings/manage-settings.adoc[Manage
Settings] for details.) The process allow services to be assigned to
the new node. If the new node was previously _initialized_ with
custom disk-paths, these are retained. All aspects of _provisioning_
that may previously have occurred on the new node are eliminated: this
includes buckets, services, and settings.

Following node-addition, _rebalance_ is required, to make the new node
and active member of the cluster.

[#examples-on-this-page-node-addition]
== Examples on This Page

The examples in the subsections below show how to add the same
node to the same one-node cluster; using the
xref:managing-clusters:managing-nodes/add-node-and-rebalance.adoc#add-a-node-with-the-ui[UI],
the
xref:managing-clusters:managing-nodes/add-node-and-rebalance.adoc#add-a-node-with-the-cli[CLI],
and the
xref:managing-clusters:managing-nodes/add-node-and-rebalance.adoc#add-a-node-with-the-rest-api[REST
API] respectively. The examples assume:

* A one-node cluster already exists; and is named after its
IP address: `10.142.181.101`. It is running the Data, Query, and
Index services, and has the `travel-sample` bucket installed
(To access and install this, see
xref:settings:install-sample-buckets.adoc[Sample Buckets].)

* A new node has been started. This is named after its IP address:
`10.142.181.101`. It has not been initialized or provisioned.

* The cluster has the Full Administrator username of
`Administrator`, and password of `password`.

[#add-a-node-with-the-ui]
== Add a Node with the UI

Proceed as follows:

. Bring up Couchbase Web Console, and log into cluster `10.142.181.101`,
using the Full Administrator
username and password. Access the *Servers* tab, in the left-hand
navigation bar:
+
[#left_click_on_servers_tab]
image::managing-nodes/accessServersTab.png[,90,align=middle]
+
The *Servers* screen for the cluster is now displayed:
+
[#servers-screen-initial]
image::managing-nodes/serversScreenInitial.png[,800,align=middle]
+
This shows the name of the sole node in the cluster, `10.142.181.101`, plus
additional information, including the services hosted.

. Ensure that the node to be added has been started. This can be
accomplished by checking the IP address and port number for the
new node in the address bar of the browser. The following interface is
displayed:
+
[#new-node-welcome-screen]
image::managing-nodes/newNodeWelcomeScreen.png[,400,align=middle]
+
This indicates that Couchbase Server is installed and running on the new
node, but has not yet been provisioned. Do not use this interface: instead,
return to Couchbase Web Console for the cluster, `10.142.181.101`.

. In the *Servers* panel for the cluster, left-click on the *ADD SERVER* button,
at the upper right:
+
[#add-server-button]
image::managing-nodes/addServerButton.png[,140,align=middle]
+
The *Add Server Node* dialog is now displayed:
+
[#add-server-node-dialog]
image::managing-nodes/addServerNodeDialog.png[,400,align=middle]
+
Note the warning provided at the top of the dialog: if the node to be
added has already been provisioned, the results of such provisioning will
be eliminated and replaced on the node's addition to the current cluster.
(In fact, the node to be added in this example, has neither been
initialized nor provisioned.)

. Specify the IP address of the node to be added. There is no need to
specify a password, since the node has not yet been provisioned with one.
Uncheck all of the *Services* check-boxes except *Data*. The dialog now
appears as follows:
+
[#add-server-node-dialog-complete]
image::managing-nodes/addServerNodeDialogComplete.png[,400,align=middle]
+
Left-click on the *Add Server* button to save. The *Servers* screen is
redisplayed, with the following appearance:
+
[#servers-screen-with-node-added]
image::managing-nodes/serversScreenWithNodeAdded.png[,800,align=middle]
+
This indicates that the new node, `10.142.181.102` has been successfully
added. However, it is not yet taking traffic, and will be added following
a _rebalance_.

. To perform a rebalance, left-click on the *Rebalance* button, at the
upper right:
+
[#rebalance-button]
image::managing-nodes/rebalanceButton.png[,140,align=middle]
+
The new node is rebalanced into the cluster, meaning that whatever active and
replica vBuckets were previously distributed across the original cluster nodes
are redistributed across the superset of nodes created by the addition. The
*Servers* screen now appears as follows:
+
[#servers-screen-with-node-added-after-rebalance]
image::managing-nodes/serversScreenWithNodeAddedAfterRebalance.png[,800,align=middle]
+
This indicates that cluster `10.142.181.101` now contains two fully
functioning nodes, which are `10.142.181.101` and `10.142.181.102`.

[#add-a-node-with-the-cli]
== Add a Node with the CLI

To add a new Couchbase Server-node to an existing cluster, use the
xref:cli:cbcli/couchbase-cli-server-add.adoc[server-add] command. Note
that this command requires that arguments be provided for its
`--server-add-username` and `--server-add-password` flags. In this case,
meaningful arguments do not exist, since the new node features an instance
of Couchbase Server that is running, but has not been provisioned with
a username or password. Therefore, specify placeholder arguments. Additionally,
specify that the `data` service be run on the node, once it is part of
the cluster.

----
couchbase-cli server-add -c 10.142.181.101:8091 --username Administrator \
--password password --server-add 10.142.181.102:8091 \
--server-add-username someName --server-add-password somePassword \
> --services data
----

If successful, the command returns the following:

----
SUCCESS: Server added
----

The newly added node must now be rebalanced into the cluster. Use the
xref:cli:cbcli/couchbase-cli-rebalance.adoc[rebalance] command:

----
couchbase-cli rebalance -c 10.142.181.101:8091 --username Administrator \
--password password
----

If successful, the command returns the following:

----
SUCCESS: Rebalance complete
----

This rebalance is likely to have occurred rapidly. When the operation is
highly complex, it may be desirable to get status on its progress, or
stop the operation. See the command reference for
xref:cli:cbcli/couchbase-cli-rebalance-status.adoc[rebalance-status]
and
xref:cli:cbcli/couchbase-cli-rebalance-stop.adoc[rebalance-stop],
for more information.

[#add-a-node-with-the-rest-api]
== Add a Node with the REST API

To add a new Couchbase Server-node to an existing cluster, use the
`/controller/addNode` URI. The following command adds node
`10.142.181.102` to cluster `10.142.181.101`:

----
curl -u Administrator:password -v -X POST \
10.142.181.101:8091/controller/addNode \
-d 'hostname=10.142.181.102&user=someName&password=somePassword&services=kv'
----

Note that the argument passed for `services` is `kv`, which signifies
the Data Service. As with the CLI command shown above, a username and
password are expected, even though in this case, the new node has not
been provisioned: therefore, placeholders are used. If successful, the
command returns the name of the newly added node:

----
{"otpNode":"ns_1@10.142.181.102"}
----

The newly added node must now be rebalanced into the cluster. Use the
`/controller/rebalance` URI, as follows:

----
curl -u Administrator:password -v -X POST \
10.142.181.101:8091/controller/rebalance \
-d 'knownNodes=ns_1@10.142.181.101,ns_1@10.142.181.102'
----

Note that the `knownNodes` argument lists each of the nodes in the
cluster.
If successful, the command returns no output.

For further information on adding nodes with the REST API, see
xref:rest-api:rest-cluster-addnodes.adoc[Adding Nodes to Clusters]; on
rebalancing, see
xref:rest-api:rest-cluster-rebalance.adoc[Rebalancing Nodes].

[#next-steps-after-adding-and-rebalancing]
== Next Steps

As well as supporting a cluster's adding a node to itself, Couchbase Server
also supports a node's joining itself to a cluster (which is essentially
the same operation, but proceeding from the node, rather than from the
cluster). See
xref:managing-clusters:managing-nodes/join-cluster-and-rebalance.adoc[Join
a Cluster and Rebalance]
for details.
