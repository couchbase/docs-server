= Enable Fully Secure Replications

[abstract]
_Fully_ secure replications handle both authentication and data-transfer
via TLS.

[#understanding-fully-secure-replications]
== Understanding Fully Secure Replications

A _fully_ secure replication handles both authentication and
data-transfer via TLS. This can be accomplished in either of
the following ways:

* Specifying username, password, and root certificate.
* Specifying root and client certificates, and client private key.

General information on preparing client certificates and keys is provided in
xref:security:security-x509certsintro.adoc[X.509 for TLS].
Information on configuring clusters to handle client certificates is provided in
xref:security:security-comm-encryption.adoc#handling-client-certificates[Handling
Client Certificates].
Note that if the client certificate has been generated using the root
certificate, the client certificate itself must be specified.
Alternatively, if the client certificate has been generated using intermediate
certificates, the entire certificate chain — including the client certificate
and all intermediate certificates — must be specified.

[#examples-on-this-page-fully-secure-replication]
== Examples on This Page

The examples in the subsections below show how to _fully_ secure a
replication; using the
xref:managing-clusters:managing-xdcr/enable-full-secure-replication.adoc#enable-fully-secure-replications-with-the-ui[UI],
the
xref:managing-clusters:managing-xdcr/enable-full-secure-replication.adoc#enable-fully-secure-replications-with-the-cli[CLI],
and the
xref:managing-clusters:managing-xdcr/enable-full-secure-replication.adoc#enable-fully-secure-replications-with-the-rest-api[REST
API] respectively. As their starting-point, the
examples assume the scenario that concluded the page
xref:managing-clusters:managing-xdcr/resume-xdcr-replication.adoc[Resume a
Replication].

[#enable-fully-secure-replications-with-the-ui]
== Enable Fully Secure Replications with the UI


. Access Couchbase Web Console. Left-click on the *XDCR* tab, in the
right-hand navigation menu.
+
[#left_click_on_xdcr_tab]
image::managing-xdcr/left-click-on-xdcr-tab.png[,100,align=middle]
+
This brings up the [.ui]*XDCR Replications* screen.
The upper part of the main panel, entitled *Remote Clusters*, lists the
currently defined reference.

. Left-click on the `Edit` tab, located at the right-hand side of the row:

+
[#references-edit-tab]
image::managing-xdcr/left-click-on-edit-tab.png[,120,align=middle]

+
This brings up the partially filled *Edit Remote Cluster* dialog:

+
[#edit-remote-cluster-dialog]
image::managing-xdcr/xdcr-edit-remote-cluster-dialog.png[,400,align=middle]

. In the dialog, enter the *Password* for the remote cluster, and check
the *Enable Secure Connection* checkbox. The dialog now expands vertically:

+
[#edit-remote-cluster-dialog-expanded]
image::managing-xdcr/xdcr-edit-remote-cluster-dialog-expanded.png[,400,align=middle]
+
The *Half* radio button is checked by default: this means that half-secure
replication is selected. Instead, select the *Full (TLS encrypt password
and data)* button. The dialog again expands vertically, and now appears as
follows:
+
[#xdcr-edit-remote-cluster-full-expanded-initial]
image::managing-xdcr/xdcr-edit-remote-cluster-full-expanded-initial.png[,400,align=middle]

+
Proceed in either of the ways explained
immediately below.

[#specify-full-xdcr-security-with-credentials]
==== Specify Username, Password, and Root Certificate

. In the open *Add* or *Edit* dialog, enter the *Username for Remote Cluster*,
and *Password*.

. Copy and paste the root certificate for the remote cluster into the top
interactive pane, below the radio buttons — leaving both of the lower
interactive panes blank.
+
The dialog now appears approximately as follows:
+
[#xdcr-edit-remote-cluster-dialog-expanded-with-creds]
image::managing-xdcr/xdcr-edit-remote-cluster-dialog-expanded-with-creds.png[,400]

. Left-click on the *Save* button, at the lower-right of the dialog.

All replications for the edited reference will now be fully secured.

[#specify-full-xdcr-security-with-certificates]
==== Specify Root and Client Certificates, and Client Private Key

. Copy and paste the root certificate for the destination cluster into the top interactive pane.
. Copy and paste the client certificate for the local cluster into the middle interactive pane.
. Copy and paste the client private key for the local cluster into the bottom interactive pane.
. Ensure that the *Username for Remote Cluster* and *Password* fields are blank.
The dialog now appears approximately as follows:
+
[#xdcr-edit-remote-cluster-dialog-expanded-with-certs]
image::managing-xdcr/xdcr-edit-remote-cluster-dialog-expanded-with-certs.png[,400]

. Left-click on the *Save* button, at the lower-right of the dialog.

All replications for the edited reference will now be fully secured.

[#enable-half-secure-replications-with-add-remote-cluster-full]
==== Enable Half-Secure Replications with Add Remote Cluster

Left-clicking on the *Add Remote Cluster* button, located at the upper-right
of the *XDCR Replications* screen, brings up the *Add Remote Cluster*
dialog. As shown in
xref:managing-clusters:managing-xdcr/create-xdcr-reference.adoc#create-an-xdcr-reference-with-the-ui[Create
an XDCR Reference with the UI], this is used to create a new reference. The
field-content of this dialog is identical to that of the *Edit Remote Cluster*
dialog, just examined: therefore it too can be used to establish security for
the reference and its corresponding replications.

[#enable-fully-secure-replications-with-the-cli]
== Enable Fully Secure Replications with the CLI

To create and edit a reference, and attribute to it a security-level,
use the `xdcr-setup` command. Use of this command to create a non-secure
reference is
already demonstrated in
xref:managing-clusters:managing-xdcr/create-xdcr-reference.adoc#create-an-xdcr-reference-with-the-cli[Create
an XDCR Reference with the CLI].

From the starting-point given above, in
xref:managing-clusters:managing-xdcr/enable-full-secure-replication.adoc#examples-on-this-page-full-secure-replication[Examples
on this Page], proceed as follows.

[#edit-existing-reference-to-fully-secure-with-creds]
==== Secure an Existing Reference, Using Credentials

To edit the existing non-secure reference to `10.142.180.102`, specifying
fully secure replication by means of the remote cluster's appropriate
administrative credentials and its root certificate, enter the following:

----
couchbase-cli xdcr-setup -c 10.142.180.101 \
-u Administrator -p password \
--edit \
--xdcr-cluster-name 10.142.180.102 \
--xdcr-hostname 10.142.180.102 \
--xdcr-username Administrator \
--xdcr-password password \
--xdcr-secure-connection full \
--xdcr-certificate /Users/username/cert/ca.pem
----

Note that the `--edit` flag is specified.
The `--xdcr-username` and `--xdcr-password` are those for the remote
cluster. The value of `--xdcr-certificate` is set to `full`. The value
of `--xdcr-certificate` is the root certificate of the remote cluster,
specified as a local pathname. If successful, the command returns the
following:

----
SUCCESS: Cluster reference edited
----

The reference and its associated replications are now fully secured.

[#edit-existing-reference-to-fully-secure-with-certs]
==== Secure an Existing Reference, Using Certificates

To edit the existing non-secure reference to `10.142.180.102`, specifying
fully secure replication by means of the remote cluster's root certificate,
a client certificate, and a client private key, enter the following:

----
couchbase-cli xdcr-setup -c 10.142.180.101 \
-u Administrator \
-p password \
--edit \
--xdcr-cluster-name 10.142.180.102 \
--xdcr-hostname 10.142.180.102 \
--xdcr-username Administrator \
--xdcr-password password \
--xdcr-secure-connection full \
--xdcr-certificate /Users/username/cert/ca.pem \
--xdcr-user-certificate /Users/username/cert/chain.pem \
--xdcr-user-key /Users/username/cert/client.key
----

Note that the `--edit` flag is specified.
The `--xdcr-username` and `--xdcr-password` are those for the remote
cluster. The value of `--xdcr-certificate` is set to `full`. Specified
as local pathnames are the values of
 `--xdcr-certificate` (the root certificate of the remote cluster),
 `--xdcr-user-certificate` (the client certificate), and
 `--xdcr-user-key` (the client's private key).
 If successful, the command returns the  following:

----
SUCCESS: Cluster reference edited
----

The reference and its associated replications are now fully secured.

[#create-new-fully-secure-reference-with-creds]
==== Create a New, Fully Secure Reference, Using Credentials

To create a new, fully secure reference from `10.142.180.103`
to `10.142.180.103`
by means of the remote cluster's appropriate
administrative credentials and its root certificate, enter the following:

----
couchbase-cli xdcr-setup -c 10.142.180.101 \
-u Administrator -p password \
--create \
--xdcr-cluster-name 10.142.180.103 \
--xdcr-hostname 10.142.180.103 \
--xdcr-username Administrator \
--xdcr-password password \
--xdcr-secure-connection full \
--xdcr-certificate /Users/username/cert/ca.pem
----

Note that the `--create` flag is specified.
The `--xdcr-username` and `--xdcr-password` are those for the remote
cluster. The value of `--xdcr-certificate` is set to `full`. The value
of `--xdcr-certificate` is the root certificate of the remote cluster,
specified as a local pathname. If successful, the command returns the
following:

----
SUCCESS: Cluster reference created
----

The new reference is now fully secured, as will be its associated
replications.

[#create-new-fully-secure-reference-with-certs]
==== Create a New, Fully Secure Reference, Using Certificates

To create a new, fully secure reference from `10.142.180.103`
to `10.142.180.103`
by means of the remote cluster's root certificate,
a client certificate, and a client private key, enter the following:

----
couchbase-cli xdcr-setup -c 10.142.180.101 \
-u Administrator -p password \
--edit \
--xdcr-cluster-name 10.142.180.102 \
--xdcr-hostname 10.142.180.102 \
--xdcr-username Administrator \
--xdcr-password password \
--xdcr-secure-connection full \
--xdcr-certificate /Users/username/cert/ca.pem
----

Note that the `--edit` flag is specified.
The `--xdcr-username` and `--xdcr-password` are those for the remote
cluster. The value of `--xdcr-certificate` is set to `full`. The value
of `--xdcr-certificate` is the root certificate of the remote cluster,
specified as a local pathname. If successful, the command returns the
following:

----
SUCCESS: Cluster reference edited
----

The reference and its associated replications are now fully secured.

[#edit-existing-reference-to-fully-secure-with-certs]
==== Secure an Existing Reference, Using Certificates

To edit the existing non-secure reference to `10.142.180.102`, specifying
fully secure replication by means of the remote cluster's root certificate,
a client certificate, and a client private key, enter the following:

----
couchbase-cli xdcr-setup -c 10.142.180.101 \
-u Administrator \
-p password \
--create \
--xdcr-cluster-name 10.142.180.103 \
--xdcr-hostname 10.142.180.103 \
--xdcr-username Administrator \
--xdcr-password password \
--xdcr-secure-connection full \
--xdcr-certificate /Users/username/cert/ca.pem \
--xdcr-user-certificate /Users/username/cert/chain.pem \
--xdcr-user-key /Users/username/cert/client.key
----

Note that the `--create` flag is specified.
The `--xdcr-username` and `--xdcr-password` are those for the remote
cluster. The value of `--xdcr-certificate` is set to `full`. Specified
as local pathnames are the values of
 `--xdcr-certificate` (the root certificate of the remote cluster),
 `--xdcr-user-certificate` (the client certificate), and
 `--xdcr-user-key` (the client's private key).
 If successful, the command returns the  following:

----
SUCCESS: Cluster reference created
----

The new reference is now fully secured, as will be its associated
replications.

[#enable-fully-secure-replications-with-the-rest-api]
== Enable Fully Secure Replications with the REST API
