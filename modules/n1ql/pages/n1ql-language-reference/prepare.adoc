= PREPARE
:page-topic-type: concept
:imagesdir: ../../assets/images

[abstract]
The PREPARE statement prepares a query for repeated execution.

== Purpose

Building plans for N1QL requests may be expensive, in particular where a cluster has many indexes.
Sometimes planning may take more time than actually executing a request.

If you know that a statement text will be executed repeatedly, you can request the N1QL service to prepare the execution plan beforehand, and then request to execute the prepared plan as many times as needed, thereby avoiding the cost of repeated planning.

== Syntax

[subs="normal"]
----
prepare ::= PREPARE [ FORCE ] [ _name_ ( FROM | AS ) ] _statement_
----

image::n1ql-language-reference/prepare.png["'PREPARE' 'FORCE'? ( name ( 'FROM' | 'AS' ) )? statement"]

=== Arguments

name::
[Optional] A local name for the prepared statement.
If you do not specify a local name for the prepared statement, the query engine generates a UUID as a local name.

statement::
The full text of the N1QL statement to prepare.

=== FORCE

The default behavior of the PREPARE statement, without the FORCE keyword, is as follows:

*When you create a prepared statement with a local name*, the query engine checks whether a prepared statement with that name already exists.

* If it does not, the prepared statement is created.

* If it does, the query engine checks whether the text of your N1QL statement matches the N1QL statement associated with the existing prepared statement.

** If it does not match, a duplicate name error is generated.

** If it matches, the existing prepared statement is returned. 

*When you create a prepared statement without a local name*, the query engine checks whether a prepared statement already exists for this N1QL statement.

* If it does not, the prepared statement is created, and the query engine generates a UUID as a local name.

* If it does, the query engine checks whether the existing prepared statement has a UUID as a local name.

** If it does not, the query engine creates a new prepared statement with a new UUID as its local name.

** If it does, the previously prepared statement is returned.

When present, the FORCE keyword forces the query engine to create the prepared statement again, even if a matching prepared statement already exists.

The FORCE keyword does _not_ enable you to assign an existing name to a new prepared statement.

== Result

A JSON object is returned that contains the following properties:

name:: The full name of the prepared statement.
This has the format `[host:port]local-name-or-UUID`, and consists of:
+
* The host and port of the node where the prepared statement was created, in square brackets, followed by
* The local name that you specified for the prepared statement, or a UUID that was assigned automatically.

operator:: The execution plan of the statement being prepared.

signature:: The signature of the statement being prepared.

text:: The full PREPARE statement text.

encoded_plan:: The full prepared statement in encoded format.
This is included in Couchbase Server 6.5 for for compatibility with previous versions.
In previous versions of Couchbase Server, you can use the encoded plan in a request to execute a prepared statement.

== Usage

You can prepare a statement in three ways:

* Using the PREPARE statement in the Query Workbench.

* Using the PREPARE statement in the the xref:tools:cbq-shell.adoc[cbq] command line shell.

* Using the xref:n1ql:n1ql-rest-api/index.adoc[Query REST API] (`/query/service` endpoint).

Prepared statements are stored in memory until you restart the Couchbase Server.
After restarting the server, you must prepare the statements again before you can execute the prepared statements.

For information on how to use prepared statements with various SDKs, refer to xref:java-sdk::n1ql-query.adoc#prepare-stmts[Querying with N1QL] and xref:nodejs-sdk::n1ql-queries-with-sdk.adoc[N1QL from the SDK].

== Authorization

The user executing the PREPARE statement must have the RBAC privileges of the statement being prepared.
For more details about user roles, see
xref:learn:security/authorization-overview.adoc[Authorization].

For example,

To execute the following statement, user must have the _Query Select_ privilege on both keyspaces `pass:c[`travel-sample`]` and `pass:c[`beer-sample`]`.

====
[source,N1QL]
----
PREPARE SELECT * FROM `travel-sample`
WHERE city = (SELECT RAW city FROM `beer-sample`)
----
====

To execute the following statement, user must have the _Query Update_ and _Query Select_ privileges on `pass:c[`travel-sample`]`.

====
[source,N1QL]
----
PREPARE UPDATE `travel-sample`
SET city = "San Francisco" WHERE lower(city) = "sanfrancisco"
RETURNING *
----
====

== Example

====
.Query
[source,N1QL]
----
PREPARE SELECT * FROM `travel-sample`
WHERE type = "route"
AND airline = "FL";
----

.Result
[source,JSON]
----
{
  "encoded_plan": "H4sIAAAAAAAA/wEAAP//AAAAAAAAAAA=",
  "featureControls": 12,
  "indexApiVersion": 3,
  "name": "[127.0.0.1:8091]5944e03f-aa9a-5f02-8fc9-f54070322758",
  "namespace": "default",
  "operator": {
    "#operator": "Sequence",
    "~children": [
      {
        "#operator": "Authorize",
        "privileges": {
          "List": [
            {
              "Priv": 7,
              "Target": "default:travel-sample"
            }
          ]
        },
        "~child": {
          "#operator": "Sequence",
          "~children": [
            {
              "#operator": "IndexScan3",
              "index": "def_type",
              "index_id": "ff413bfa5f5869f4",
              "index_projection": {
                "primary_key": true
              },
              "keyspace": "travel-sample",
              "namespace": "default",
              "spans": [
                {
                  "exact": true,
                  "range": [
                    {
                      "high": "\"route\"",
                      "inclusion": 3,
                      "low": "\"route\""
                    }
                  ]
                }
              ],
              "using": "gsi"
            },
            {
              "#operator": "Fetch",
              "keyspace": "travel-sample",
              "namespace": "default"
            },
            {
              "#operator": "Parallel",
              "~child": {
                "#operator": "Sequence",
                "~children": [
                  {
                    "#operator": "Filter",
                    "condition": "(((`travel-sample`.`type`) = \"route\") and ((`travel-sample`.`airline`) = \"FL\"))"
                  },
                  {
                    "#operator": "InitialProject",
                    "result_terms": [
                      {
                        "expr": "self",
                        "star": true
                      }
                    ]
                  },
                  {
                    "#operator": "FinalProject"
                  }
                ]
              }
            }
          ]
        }
      },
      {
        "#operator": "Stream"
      }
    ]
  },
  "signature": {
    "*": "*"
  },
  "text": "PREPARE SELECT * FROM `travel-sample`\nWHERE type = \"route\"\nAND airline = \"FL\";"
}
----
====

== Related

* For information on executing the prepared statement, refer to xref:n1ql-language-reference/execute.adoc[EXECUTE].
