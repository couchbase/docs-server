= PREPARE
:page-topic-type: concept
:imagesdir: ../../assets/images

[abstract]
The PREPARE statement prepares a query for repeated execution.

== Purpose

Building plans for N1QL requests may be expensive, in particular where a cluster has many indexes.
Sometimes planning may take more time than actually executing a request.

If you know that a statement text will be executed repeatedly, you can request the N1QL service to prepare the execution plan beforehand, and then request to execute the prepared plan as many times as needed, thereby avoiding the cost of repeated planning.

== Syntax

[subs="normal"]
----
prepare ::= PREPARE [ FORCE ] [ _name_ ( FROM | AS ) ] _statement_
----

image::n1ql-language-reference/prepare.png["'PREPARE' 'FORCE'? ( name ( 'FROM' | 'AS' ) )? statement"]

statement::
The full text of the N1QL statement to prepare.
The N1QL statement may contain parameters.
For more details, refer to <<parameters>> below.

=== FORCE

[Optional] The FORCE keyword forces the query engine to create the prepared statement again, even if a matching prepared statement already exists.
For more details, refer to <<cache>> below.

The FORCE keyword does _not_ enable you to assign an existing name to a new prepared statement.

=== FROM / AS Clause

[Optional] The FROM or AS clause enables you to specify a name for the prepared statement.

name::
A local name for the prepared statement.
If you do not specify a local name for the prepared statement, the query engine generates a UUID from the statement text.
For more details, refer to <<result>> below.

== Usage

You can prepare a statement in three ways:

* Using the PREPARE statement in the Query Workbench.

* Using the PREPARE statement in the the xref:tools:cbq-shell.adoc[cbq] command line shell.

* Using the xref:n1ql:n1ql-rest-api/index.adoc[Query REST API] (`/query/service` endpoint).

For information on how to use prepared statements with various SDKs, refer to xref:java-sdk::n1ql-query.adoc#prepare-stmts[Querying with N1QL] and xref:nodejs-sdk::n1ql-queries-with-sdk.adoc[N1QL from the SDK].

[[parameters]]
== Parameters

A prepared statement may contain parameters.
These are replaced by a supplied value when the statement is executed.
Parameters may be _named parameters_ or _positional parameters_.

Named parameters are specified by name when the prepared statement is executed.
To refer to a named parameter in a statement, use `$` followed by the name of the parameter, e.g. `$city`.

====
[source,N1QL]
----
PREPARE NameParam AS
SELECT * FROM `travel-sample`
WHERE type="hotel" AND city=$city AND country=$country;
----
====

Positional parameters are specified by the position of each supplied parameter when the statement is executed.
To refer to a positional parameter in a statement, use `$` followed by the position of the supplied parameter.
So `$1` refers to the first supplied parameter, `$2` refers to the second supplied parameter, etc.

====
[source,N1QL]
----
PREPARE NumParam AS
SELECT * FROM `travel-sample`
WHERE type="hotel" AND city=$1 AND country=$2;
----
====

You may also use `?` to refer to a positional parameter in a statement.
In this case, the order of parameters in the statement must exactly match the order of parameters when the statement is executed.
So the first `?` refers to the first supplied parameter, the second `?` refers to the second supplied parameter, etc.

====
[source,N1QL]
----
PREPARE NumParam AS
SELECT * FROM `travel-sample`
WHERE type="hotel" AND city=? AND country=?;
----
====

[[result]]
== Result

A JSON object is returned that contains the following properties:

name:: The full name of the prepared statement.
This has the format `[host:port]local-name-or-UUID`, and consists of:
+
* The host and port of the node where the prepared statement was created, in square brackets, followed by
* The local name that you specified for the prepared statement, or a UUID that was generated from the statement text.

operator:: The execution plan of the statement being prepared.

signature:: The signature of the statement being prepared.

text:: The full PREPARE statement text.

encoded_plan:: The full prepared statement in encoded format.
This is included in Couchbase Server 6.5 for for compatibility with previous versions.
In previous versions of Couchbase Server, you can use the encoded plan in a request to execute a prepared statement.

[[cache]]
== Statement Cache

Prepared statements are stored in the prepared statement cache until you restart the Couchbase Server.

In Couchbase Server 6.5 and later, the query engine uses the prepared statement cache to speed up the creation of prepared statements.

When you create a prepared statement with a local name:

* The query engine checks whether a prepared statement with that name already exists.

** If it does not, the prepared statement is created.

** If it does, the query engine checks whether the text of your N1QL statement matches the N1QL statement associated with the existing prepared statement.

*** If it does not match, a duplicate name error is generated.

*** If it matches, the existing prepared statement is returned. 

When you create an anonymous prepared statement, i.e. a prepared statement without a local name:

* The query engine generates a UUID from the statement text.

* The query engine then searches the prepared cache to see if the UUID is already listed.

** If found, the existing prepared statement is returned.

** If not found, the statement is created and added to the prepared cache.

In this case, if there is a named prepared statement in the cache with identical statement text, the named prepared statement is not returned.
The anonymous prepared statement is added to the cache in addition to the named prepared statement.

== Auto-Prepare

_(Introduced in Couchbase Server 6.5)_

When the _auto-prepare_ feature is active, a prepared statement is created every time you submit a N1QL request, whether you use the PREPARE statement or not.

The process is similar to creating prepare statement without a local name:

* The query engine generates a UUID from the statement text.

* The query engine then searches the prepared cache to see if the UUID is already listed.

** If found, the existing prepared statement is returned.

** If not found, the statement is created and added to the prepared cache.

You can turn the auto-prepare feature on or off.
For more details, refer to xref:settings:query-settings.adoc[Query Settings].

Auto-prepare is disabled for N1QL requests which contain parameters, if they do not use the PREPARE statement.

== Statement Propagation

When prepared, new statements are distributed to all query nodes.

In Couchbase Server 6.5 and later, when a query node is started or restarted, the prepared statement cache is primed from another node.

If it is not possible to prime the statement cache from another node, you must prepare the statements again before you can execute the them.

== Authorization

The user executing the PREPARE statement must have the RBAC privileges of the statement being prepared.
For more details about user roles, refer to xref:learn:security/authorization-overview.adoc[Authorization].

For example,

To execute the following statement, user must have the _Query Select_ privilege on both keyspaces `pass:c[`travel-sample`]` and `pass:c[`beer-sample`]`.

====
[source,N1QL]
----
PREPARE SELECT * FROM `travel-sample`
WHERE city = (SELECT RAW city FROM `beer-sample`)
----
====

To execute the following statement, user must have the _Query Update_ and _Query Select_ privileges on `pass:c[`travel-sample`]`.

====
[source,N1QL]
----
PREPARE UPDATE `travel-sample`
SET city = "San Francisco" WHERE lower(city) = "sanfrancisco"
RETURNING *
----
====

== Example

====
.Query
[source,N1QL]
----
PREPARE SELECT * FROM `travel-sample`
WHERE type = "route"
AND airline = "FL";
----

.Result
[source,JSON]
----
{
  "encoded_plan": "H4sIAAAAAAAA/wEAAP//AAAAAAAAAAA=",
  "featureControls": 12,
  "indexApiVersion": 3,
  "name": "[127.0.0.1:8091]5944e03f-aa9a-5f02-8fc9-f54070322758",
  "namespace": "default",
  "operator": {
    "#operator": "Sequence",
    "~children": [
      {
        "#operator": "Authorize",
        "privileges": {
          "List": [
            {
              "Priv": 7,
              "Target": "default:travel-sample"
            }
          ]
        },
        "~child": {
          "#operator": "Sequence",
          "~children": [
            {
              "#operator": "IndexScan3",
              "index": "def_type",
              "index_id": "ff413bfa5f5869f4",
              "index_projection": {
                "primary_key": true
              },
              "keyspace": "travel-sample",
              "namespace": "default",
              "spans": [
                {
                  "exact": true,
                  "range": [
                    {
                      "high": "\"route\"",
                      "inclusion": 3,
                      "low": "\"route\""
                    }
                  ]
                }
              ],
              "using": "gsi"
            },
            {
              "#operator": "Fetch",
              "keyspace": "travel-sample",
              "namespace": "default"
            },
            {
              "#operator": "Parallel",
              "~child": {
                "#operator": "Sequence",
                "~children": [
                  {
                    "#operator": "Filter",
                    "condition": "(((`travel-sample`.`type`) = \"route\") and ((`travel-sample`.`airline`) = \"FL\"))"
                  },
                  {
                    "#operator": "InitialProject",
                    "result_terms": [
                      {
                        "expr": "self",
                        "star": true
                      }
                    ]
                  },
                  {
                    "#operator": "FinalProject"
                  }
                ]
              }
            }
          ]
        }
      },
      {
        "#operator": "Stream"
      }
    ]
  },
  "signature": {
    "*": "*"
  },
  "text": "PREPARE SELECT * FROM `travel-sample`\nWHERE type = \"route\"\nAND airline = \"FL\";"
}
----
====

== Related

* For information on executing the prepared statement, refer to xref:n1ql-language-reference/execute.adoc[EXECUTE].
