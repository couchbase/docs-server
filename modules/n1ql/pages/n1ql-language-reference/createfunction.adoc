= CREATE FUNCTION
:page-topic-type: concept
:page-status: Developer Preview
:imagesdir: ../../assets/images
:page-partial:

The `CREATE FUNCTION` statement enables you to create a user-defined function.

There are two types of user-defined function:

* <<create-function-inline,Inline functions>> are defined using N1QL expressions, including subqueries.
They enable you to name and reuse complex or repetitive expressions, including subqueries, in order to simplify your queries.

* <<create-function-external,External functions>> are defined using an external language.
They enable you to create functions that may be difficult or impossible to define using built-in N1QL expressions.
The only supported language is Javascript.

// == RBAC Privileges
// 
// To execute the CREATE FUNCTION statement, you must have the _Query Manage Index_ privilege granted on the keyspace/bucket.
// For more details about user roles, see
// xref:learn:security/authorization-overview.adoc[Authorization].

include::ROOT:partial$developer-preview.adoc[]

== Syntax

The `CREATE FUNCTION` statement takes a different syntax depending on the type of function you are creating.

[subs="normal"]
----
create-function ::= <<create-function-inline,create-function-inline>> | <<create-function-external,create-function-external>>
----

image::n1ql-language-reference/create-function.png["create-function-inline | create-function-external"]

[[create-function-inline]]
:section: inline
=== Inline Functions

There are two alternative syntaxes for defining an inline function.
The two syntaxes are synonymous.

[subs="normal"]
----
create-function-inline ::= CREATE FUNCTION <<{section}-name,name>> '(' [ <<{section}-parameter,parameter>> ( ',' <<{section}-parameter,parameter>> )* ] ')' ( '{' <<inline-expression,expression>> '}' | LANGUAGE INLINE AS <<inline-expression,expression>> )
----

image::n1ql-language-reference/create-function-inline.png["'CREATE' 'FUNCTION' name '(' (parameter (',' parameter)* )? ')' ( '{' expression '}' | 'LANGUAGE' 'INLINE' 'AS' expression )"]

// tag::arguments[]
[id='{section}-name']
name::
The name of the function.
This may be an unqualified identifier, such as `func1` or `{backtick}func-1{backtick}`, or a qualified identifier with a namespace, such as `default:func1`.
It is recommended to use an unqualified identifier for the function name.
This may not be the same as a reserved keyword.
A function name with a namespace may have the same name as a reserved keyword.

[id='{section}-parameter']
parameter::
The name of a function argument.
If you specify named parameters for the function, then you must call the function with exactly the same number of parameters at runtime.
If you specify no parameters for the function, then you may call the function with any number of parameters at runtime, or with none.
// end::arguments[]

[[inline-expression]]
expression::
The N1QL expression that defines the function.
If you specified named parameters for the function, you can use these in the expression to represent arguments passed to the function at runtime.
If you did not specify any named parameters for the function, any arguments passed to the function at runtime are held in an array named `args`.
+
[NOTE]
--
If the expression contains a parameter that has the same name as a field in the document, it will always refer to the parameter.
To distinguish between the field and the parameter, prefix the field with the keyspace name, for example `{backtick}travel-sample{backtick}.type`.
To avoid this ambiguity, you should use unique parameter names that do not clash with document field names, such as `vType`.
--

[[create-function-external]]
:section: external
=== Eternal Functions

[subs="normal"]
----
create-function-external ::=  CREATE FUNCTION <<{section}-name,name>> '(' [ <<{section}-parameter,parameter>> ( ',' <<{section}-parameter,parameter>> )* ] ')' LANGUAGE JAVASCRIPT AS '{' <<external-library,library>> ',' <<external-object,object>> '}'
----

image::n1ql-language-reference/create-function-external.png["'CREATE' 'FUNCTION' name '(' (parameter (',' parameter)* )? ')' 'LANGUAGE' 'JAVASCRIPT' 'AS' '{' library ',' object '}'"]

== Examples

.Inline function with the LANGUAGE syntax
====
This statement creates a function called `celsius`, which converts Fahrenheit to Celsius.
The function does not define any arguments.
The expression converts the first argument supplied at runtime, which is stored the first member in the `args` array.

[source,n1ql]
----
CREATE FUNCTION celsius () LANGUAGE INLINE AS (args[0] - 32) * 5/9;
----
====

.Inline function with the braces syntax
====
This statement creates a function called `fahrenheit`, which converts Celsius to Fahrenheit.
The function does not define any arguments.
The expression converts the first argument supplied at runtime, which is stored the first member in the `args` array.

[source,n1ql]
----
CREATE FUNCTION fahrenheit () { (args[0] * 9/5) + 32 };
----
====

.Inline function with named parameters, LANGUAGE syntax
====
The following statement creates a function called `lstr`, which returns the specified number of characters from the left of a string.
The expression expects two named arguments: `string`, which is the string to work with, and `len`, which is the number of characters to return.

[source,n1ql]
----
CREATE FUNCTION lstr(string, len) LANGUAGE INLINE AS SUBSTR(string, 0, len);
----
====

.Inline function with named parameters, braces syntax
====
The following statement creates a function called `rstr`, which returns the specified number of characters from the right of a string.
The expression expects two named arguments: `string`, which is the string to work with, and `len`, which is the number of characters to return.

[source,n1ql]
----
CREATE FUNCTION rstr(string, len) { SUBSTR(string, LENGTH(string) - len, len) };
----
====

.Inline function with subquery
====
The following statement creates a function called which selects all documents from the `travel-sample` bucket of the specified type.

[source,n1ql]
----
CREATE FUNCTION func1(vType) { (select * from `travel-sample` where type = vType) };
----
====

== Related Links

* To execute user-defined functions, refer to xref:n1ql-language-reference/execfunction.adoc[EXECUTE FUNCTION].
* To include user-defined functions in an expression, refer to xref:n1ql-language-reference/userfun.adoc[User-Defined Functions].
* To monitor user-defined functions, refer to xref:manage:monitor/monitoring-n1ql-query.adoc[Monitor Queries].
* To drop user-defined functions, refer to xref:n1ql-language-reference/dropfunction.adoc[DROP FUNCTION].
