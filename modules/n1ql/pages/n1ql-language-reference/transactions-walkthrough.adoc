= Use {sqlpp} with Couchbase Transactions
:page-topic-type: tutorial
:imagesdir: ../../assets/images
:description: Use this tutorial to complete a Couchbase ACID transaction session with {sqlpp}.

// Manage cross-references
:install-sample-buckets: xref:manage:manage-settings/install-sample-buckets.adoc

// Tools cross-references
:query-workbench: xref:tools:query-workbench.adoc
:cbq-shell: xref:tools:cbq-shell.adoc
:n1ql-rest-api: xref:n1ql:n1ql-rest-api/index.adoc

[abstract]
{description}

The following example demonstrates how to use the data in the `travel-sample` bucket with the <<workbench-shell,Query Workbench or CBQ Shell>> or <<query-api, Query REST API>> to:

* Create a primary index.
* Set transaction parameters and settings.
* Create a document.
* Set savepoints.
* Update a document.
* Check the contents of a document. 
* Rollback a transaction to a savepoint. 
* Commit a transaction.

For more information about {sqlpp} support for Couchbase transactions, see xref:n1ql:n1ql-language-reference/transactions.adoc[].

== Prerequisites

* You must install the `travel-sample` bucket.
For more information about how to install the `travel-sample` bucket, see {install-sample-buckets}[].
* You must have {cbq-shell}[cbq shell] version 2.0 or greater.

[#workbench-shell]
== Complete a Transaction with the Query Workbench or CBQ Shell

. Open the {query-workbench}[Query Workbench] or the {cbq-shell}[cbq shell].

. Create a xref:guides/create-index.adoc[primary index] on the `{backtick}travel-sample{backtick}.tenant_agent_00.bookings` keyspace:
+
[source.no-callouts,n1ql]
----
include::example$transactions/multiple.n1ql[tag=index]
----

[start="3"]
. Set the transaction timeout, scan consistency, and durability level: 
+
[{tabs}]
====
Query Workbench::
+
--
. To open the *Run-Time Preferences* window, click btn:[Settings] (icon:cog[]).

. In the *Scan Consistency* list, select *not_bounded*. 

. Next to *Named Parameters*, click btn:[Add Parameter] (*+*).

.. In the new parameter's *Name* field, enter `durability_level`.

.. In the new parameter's *Value* field, enter `"none"`.

. In the *Transaction Timeout* field, enter `120`.

. Click btn:[Save Preferences].
--

CBQ Shell::
+
--
. Set the transaction timeout, scan consistency, and durability level:

[source.no-callouts,n1ql]
----
include::example$transactions/multiple.n1ql[tag=settings]
----

--
====
[start="4"]
. Copy the code below and paste it into either the Query Workbench or cbq shell:
+
[source.no-callouts,n1ql]
----
include::example$transactions/multiple.n1ql[tags=transaction;!begin-mark;!set-mark;!savepoint-mark;!rollback-mark;!commit-mark]
----
+
The transaction code returns the following results:
+
NOTE: The cbq shell formats the results differently, but contains the same information.
+
[source.no-callouts,json]
----
include::example$transactions/results.jsonc[tags=!ellipsis]
----
+
First, the transaction returns a transaction ID: 
+
[source.no-callouts,json]
----
include::example$transactions/results.jsonc[tag=begin]
----
+
Before the transaction sets a second savepoint, the booking document has a user value of `"0"` and a name of `"Keon Hoppe"`:
+
[source.no-callouts,json]
----
include::example$transactions/results.jsonc[tag=user0]
----
+
After the transaction sets the second savepoint and performs an update, the booking document has a user value of `"1"` and a name of `"Rigoberto Bernier"`:
+
[source.no-callouts,json]
----
include::example$transactions/results.jsonc[tag=user1]
----
+
After the transaction rolls back to the second savepoint, the booking document has a user value of `"0"` and a name of `"Keon Hoppe"`:
+
[source.no-callouts,json]
----
include::example$transactions/results.jsonc[tag=rollback]
----


. You can also check the results from committing the transaction:
+
====

.Query
[source.no-callouts,n1ql]
----
include::example$transactions/multiple.n1ql[tag=check-3]
----

.Results
[source.no-callouts,json,indent=0]
----
include::example$transactions/results.jsonc[tag=check-3]
----

====

+
The transaction adds the booking document to the database with the attributes from when the transaction was committed.


[#query-api]
== Complete a Transaction with the Query REST API

To complete the same transaction steps as the preceding example but with the Query REST API: 

. Begin the transaction and set parameters: 
+
[source.no-callouts,console]
----
include::example$transactions/multiple.sh[tag=begin]
----

[start="2"]
. Set the transaction settings:
+
[source.no-callouts,console]
----
include::example$transactions/multiple.sh[tag=set]
----

[start="3"]
. Create a booking document:
+
[source.no-callouts,console]
----
include::example$transactions/multiple.sh[tag=upsert]
----

[start="4"]
. Set a savepoint:
+
[source.no-callouts,console]
----
include::example$transactions/multiple.sh[tag=savepoint-1]
----

[start="5"]
. Update the booking document to include a user:
+
[source.no-callouts,console]
----
include::example$transactions/multiple.sh[tag=update-1]
----

[start="6"]
. Check the content of the booking and the user:
+
[source.no-callouts,console]
----
include::example$transactions/multiple.sh[tag=check-1]
----

[start="7"]
. Set a second savepoint:
+
[source.no-callouts,console]
----
include::example$transactions/multiple.sh[tag=savepoint-2]
----

[start="8"]
. Update the booking documents to change the user:
+
[source.no-callouts,console]
----
include::example$transactions/multiple.sh[tag=update-2]
----

[start="9"]
. Check the content of the booking and the user:
+
[source.no-callouts,console]
----
include::example$transactions/multiple.sh[tag=check-2]
----

[start="10"]
. Roll back the transaction to the second savepoint:
+
[source.no-callouts,console]
----
include::example$transactions/multiple.sh[tag=rollback]
----

[start="11"]
. Check the content of the booking and the user:
+
[source.no-callouts,console]
----
include::example$transactions/multiple.sh[tag=check-3]
----

[start="12"]
. Commit the transaction:
+
[source.no-callouts,console]
----
include::example$transactions/multiple.sh[tag=commit]
----