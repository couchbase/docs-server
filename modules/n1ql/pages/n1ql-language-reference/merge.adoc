= MERGE
:page-topic-type: concept
:imagesdir: ../../assets/images

A MERGE statement provides the ability to update, insert into, or delete from a keyspace based on the results of a join with another keyspace or subquery.
It is possible to specify actions (insert, update, delete) on the keyspace based a match or no match in the join.
Multiple actions can be specified in the same query.

== merge

[subs="normal"]
----
MERGE INTO keyspace-ref USING merge-source ON key-clause merge-actions [limit-clause] [returning-clause]
----

[subs="normal"]
----
MERGE INTO keyspace-ref USING merge-source ON expression merge-actions-2 [limit-clause] [returning-clause]
----

image::n1ql-language-reference/merge.png[]

[[merge-source]]
=== merge-source

[subs="normal"]
----
[from-path] ( [AS] [alias] | ( select ) [AS] alias
----

image::n1ql-language-reference/merge-source.png[]

[[key-clause]]
=== keys-clause

[subs="normal"]
----
[PRIMARY] KEY expression
----

image::n1ql-language-reference/key-clause.png[]

[[merge-action]]
=== merge-actions

[subs="normal"]
----
[merge-update] [merge-delete] [merge-insert]
----

image::n1ql-language-reference/merge-actions.png[]

[[merge-update]]
=== merge-update

[subs="normal"]
----
WHEN MATCHED THEN UPDATE [set-clause] [unset-clause] [where-clause]
----

image::n1ql-language-reference/merge-update.png[]

[[merge-delete]]
=== merge-delete

[subs="normal"]
----
WHEN MATCHED THEN DELETE [where-clause]
----

image::n1ql-language-reference/merge-delete.png[]

[[merge-insert]]
=== merge-insert

[subs="normal"]
----
WHEN NOT MATCHED THEN INSERT expression [where-clause]
----

image::n1ql-language-reference/merge-insert.png[]

[[merge-action-2]]
=== merge-actions-2

[subs="normal"]
----
[merge-update] [merge-delete] [merge-insert-2]
----

image::n1ql-language-reference/merge-actions.png[]

[[merge-insert-2]]
=== merge-insert-2

[subs="normal"]
----
WHEN NOT MATCHED THEN INSERT (key, value) [where-clause]
----

TODO: Check use of where-clause above

image::n1ql-language-reference/merge-insert.png[]

[[merge-key-2]]
=== merge-key-2

[subs="normal"]
----
[KEY] key-expression
----

image::n1ql-language-reference/merge-insert.png[]

[[merge-value-2]]
=== merge-value-2

[subs="normal"]
----
[VALUE] value-expression
----

image::n1ql-language-reference/merge-insert.png[]

== RBAC Privileges

User executing the MERGE statement must have the following privileges:

* _Query Select_ privileges on the source keyspace
* _Query Insert_, _Query Update_, or _Query Delete_ privileges on the target keyspace as per the MERGE actions
* _Query Select_ privileges on the keyspaces referred in the RETURNING clause

For more details about user roles, see
xref:learn:security/authorization-overview.adoc[Authorization].

For example,

[source,n1ql]
----
MERGE INTO `travel-sample` t
USING [{"id":"21728"},{"id":"21730"}] source
ON KEY "hotel_"|| source.id
WHEN MATCHED THEN UPDATE SET t.old_vacancy = t.vacancy, t.vacancy = false
RETURNING meta(t).id, t.old_vacancy, t.vacancy;
----

== Examples

The following statement updates product based on orders.

[source,n1ql]
----
MERGE INTO product p USING orders o ON KEY o.productId
WHEN MATCHED THEN
     UPDATE SET p.lastSaleDate = o.orderDate
WHEN MATCHED THEN
     DELETE WHERE p.inventoryCount  <= 0
----

The following statement merges two datasets containing employee information.
It then updates all_empts on match with emps_deptb and inserts when there is no match.

[source,n1ql]
----
MERGE INTO all_empts a USING emps_deptb b ON KEY b.empId
WHEN MATCHED THEN
     UPDATE SET a.depts = a.depts + 1
     a.title = b.title || ", " || b.title
WHEN NOT MATCHED THEN
     INSERT  { "name": b.name, "title": b.title, "depts": b.depts, "empId": b.empId, "dob": b.dob }
----
