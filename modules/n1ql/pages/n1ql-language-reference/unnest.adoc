= UNNEST clause
:description: The UNNEST clause creates an input object by flattening an array in the parent document.
:imagesdir: ../../assets/images
:clause: UNNEST

[abstract]
{description}

== Purpose

The `UNNEST` clause is used within the xref:n1ql-language-reference/from.adoc[FROM] clause.
If a document or object contains a nested array, UNNEST conceptually performs a join of the nested array with its parent object.
Each resulting joined object becomes an output of the query.
Unnests can be chained.

== Syntax

[subs="normal"]
----
unnest-clause ::= <<from-term,from-term>> [ <<unnest-type,unnest-type>> ] ( UNNEST | FLATTEN ) <<unnest-path,expr>> [ [ AS ] <<unnest-as-alias,alias>> ]
----

image::n1ql-language-reference/unnest-clause.png[]

[#from-term]
include::partial$n1ql-language-reference/from-term.adoc[]

[#unnest-type]
=== Unnest Type

[subs="normal"]
----
unnest-type ::= INNER | ( LEFT [ OUTER ] )
----

image::n1ql-language-reference/unnest-type.png[]

This clause represents the type of unnest.

`INNER`::
For each result object produced, the array object in the left-hand side keyspace must be non-empty.

`LEFT [OUTER]`::
{startsb}Query Service interprets `LEFT` as `LEFT OUTER`{endsb}
+
A left-outer unnest is performed, and at least one result object is produced for each left source object.

This clause is optional.
If omitted, the default is `INNER`.

[#unnest-path]
=== Unnest Path

expr:: The path to the nested array.

The path expression in each UNNEST clause must reference some preceding path.

[#unnest-as-alias]
=== AS Alias

Assigns another name to the right-hand side of the unnest.
For details, see xref:n1ql-language-reference/from.adoc#section_ax5_2nx_1db[AS Clause].

Assigning an alias to the path is optional.
If you assign an alias to the path, the `AS` keyword may be omitted.

[NOTE]
====
In Couchbase Server 6.5 and later, if you want to use an xref:n1ql-language-reference/indexing-arrays.adoc[ARRAY index] for the UNNEST query, you can use any arbitrary alias for the right side of the UNNEST -- the alias does not have to be the same as the ARRAY index variable name in order to use that index.
====

== Examples

[#UNNEST-Example-1]
.UNNEST an array to select an item
====
In the `route` keyspace, flatten the schedule array to get details of the flights on Monday (`1`).

[source,N1QL]
----
include::example$select/unnest.n1ql[]
----

.Results
[source,JSON]
----
include::example$select/unnest.jsonc[]
----

Another way to get similar results is by using a quantified expression to find array items that meet our criteria:

[source,N1QL]
----
include::example$select/unnest-array.n1ql[]
----

However, without the `UNNEST` clause, the unflattened list results in 3 sets of flights instead of only 3 individual flights:

[source,JSON]
----
include::example$select/unnest-array.jsonc[]
----
====

[#UNNEST-Example-2]
.Use `UNNEST` to collect items from one array to use in another query
====
In this example, the `UNNEST` clause iterates over the `reviews` array and collects the `author` names of the reviewers who rated the rooms less than a 2 to be contacted for ways to improve.
`r` is an element of the array generated by the UNNEST operation.

[source,N1QL]
----
include::example$select/unnest-raw.n1ql[]
----

.Results
[source,JSON]
----
include::example$select/unnest-raw.jsonc[]
----
====
