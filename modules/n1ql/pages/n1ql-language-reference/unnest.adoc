= UNNEST clause
:page-status: Couchbase Server 4.0
:imagesdir: ../../assets/images

[abstract]
The `UNNEST` clause creates an input object by flattening an array in the parent document.

== Purpose

If a document or object contains a nested array, UNNEST conceptually performs a join of the nested array with its parent object.
Each resulting joined object becomes an output of the query.
Unnests can be chained.

== Syntax

[subs="normal"]
----
unnest-clause ::= <<section_nkd_3nx_1db,from-term>> join-type? ('UNNEST' | 'FLATTEN') expr ('AS'? alias)?
----

image::n1ql-language-reference/FROM_unnest-clause_4.0_RR.png[]

----
[ join-type ] UNNEST path [ [ AS ] alias ]
----

== Arguments

join-type:: [Optional; default is `INNER`]
`INNER`;; For each result object produced, the array object in the left-hand side keyspace must be non-empty.

`LEFT` or `LEFT OUTER`;; A left-outer unnest is performed, and at least one result object is produced for each left source object.

path:: [Required] The first path element after each UNNEST must reference some preceding path.

alias (optionally, `AS` alias)::
[Required] To assign a name for the unnested item.
For details, see <<section_ax5_2nx_1db,AS Keyword>>.

Return Values:: If the right-hand source object is `NULL`, `MISSING`, empty, or a non-array value, then the result object's right-side value is `MISSING` (omitted).

== Examples

[#UNNEST-Example-1]
.UNNEST an array to select an item
====
In the `travel-sample` keyspace, flatten the schedule array to get a list of the flights on Monday (`1`).

[source,N1QL]
----
SELECT sched
FROM `travel-sample`
UNNEST schedule sched
WHERE  sched.day = 1
LIMIT 3;
----

.Results
[source,JSON]
----
[
  {
    "sched": {
      "day": 1,
      "flight": "AF356",
      "utc": "12:40:00"
    }
  },
  {
    "sched": {
      "day": 1,
      "flight": "AF480",
      "utc": "08:58:00"
    }
  },
  {
    "sched": {
      "day": 1,
      "flight": "AF250",
      "utc": "12:59:00"
    }
  }
]
----

Another way to get similar results is by using a Collection Operator to find array items that meet our criteria:

[source,N1QL]
----
SELECT ARRAY item FOR item IN schedule WHEN item.day = 1 END AS Monday_flights
FROM `travel-sample`
WHERE type = "route"
AND ANY item IN schedule SATISFIES item.day = 1 END
LIMIT 3;
----

However, without the `UNNEST` clause, the unflattened list results in 3 sets of flights instead of only 3 individual flights:

[source,JSON]
----
[
  {
    "Monday_flights": [
      {
        "day": 1,
        "flight": "AF356",
        "utc": "12:40:00"
      },
      {
        "day": 1,
        "flight": "AF480",
        "utc": "08:58:00"
      },
      {
        "day": 1,
        "flight": "AF250",
        "utc": "12:59:00"
      },
      {
        "day": 1,
        "flight": "AF130",
        "utc": "04:45:00"
      }
    ]
  },
  {
    "Monday_flights": [
      {
        "day": 1,
        "flight": "AF517",
        "utc": "13:36:00"
      },
      {
        "day": 1,
        "flight": "AF279",
        "utc": "21:35:00"
      },
      {
        "day": 1,
        "flight": "AF753",
        "utc": "00:54:00"
      },
      {
        "day": 1,
        "flight": "AF079",
        "utc": "15:29:00"
      },
      {
        "day": 1,
        "flight": "AF756",
        "utc": "06:16:00"
      }
    ]
  },
  {
    "Monday_flights": [
      {
        "day": 1,
        "flight": "AF975",
        "utc": "11:23:00"
      },
      {
        "day": 1,
        "flight": "AF225",
        "utc": "16:05:00"
      }
    ]
  }
]
----
====

[#UNNEST-Example-2]
.Use `UNNEST` to collect items from one array to use in another query
====
In this example, the `UNNEST` clause iterates over the `reviews` array and collects the `author` names of the reviewers who rated the rooms less than a 2 to be contacted for ways to improve.
`r` is an element of the array generated by the UNNEST operation.

[source,N1QL]
----
SELECT RAW r.author
FROM `travel-sample`
UNNEST reviews AS r
WHERE `travel-sample`.type = "hotel"
AND r.ratings.Rooms < 2
LIMIT 4;
----

.Results
[source,JSON]
----
[
  "Kayli Cronin",
  "Shanelle Streich",
  "Catharine Funk",
  "Tyson Beatty"
]
----
====
