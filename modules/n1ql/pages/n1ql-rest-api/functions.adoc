= Functions REST API

include::ROOT:partial$developer-preview.adoc[tag=admonition]

[[_overview]]
== Overview

// TODO: This document will be completed as part of https://issues.couchbase.com/browse/DOC-5584[DOC-5884].

The Functions REST API is a secondary API provided by the Query service.
This API enables you to manage the JavaScript libraries and objects that are used to create N1QL user-defined functions.

The API schemes and host URLs are as follows:{blank}

* `+http://node:8093/+`

where [.var]`node` is the host name or IP address of a computer running the N1QL query engine.

[NOTE]
--
For all REST API calls:

* If the `name` attribute appears in the body, it must match the name specified in the path.
* If the `name` is not specified in the body, it defaults to the name specified in the path.
--

=== Version information
[%hardbreaks]
__Version__ : 6.5


=== Consumes

* `application/json`


=== Produces

* `application/json`

[[create-update-a-function]]
== Create or Update a Function

.Path
....
POST /functions/v1/libraries/{library_name}/functions/{function_name}
....

Note that if the function already exists in the library, it is overwritten.
Otherwise, the function is added to the library.
If a library does not exist, one will be created.

Only JavaScript functions whose name matches the name of the Couchbase function object are exported.

The example below creates a function called `sub` in library `math`.
The function `sub` is publicly exported, while the function `helper` is not.

[source,console]
----
$ curl -X POST \
  http://localhost:8093/functions/v1/libraries/math/functions/sub \
  -u Administrator:password \
  -H 'content-type: application/json' \
  -d '{
    "name": "sub",
    "code": "function sub(a,b) { return helper(a,b); }\n function helper(a,b) { return a - b; }"
}'
----

[[create-update-a-library]]
== Create or Update a Library

.Path
....
POST /functions/v1/libraries/{library_name}
....

Note that if the library exists, the function specified will be added to the existing library.
If a specified function already exists in the old library, it will be overwritten.

The example below creates a library called `math`.

[source,console]
----
$ curl -X POST \
  http://localhost:8093/functions/v1/libraries/math \
  -u Administrator:password \
  -H 'content-type: application/json' \
  -d '{
    "name": "math",
    "functions": [
        {"name": "add","code": "function add(a, b) { let data = a + b; return data; } "},
        {"name": "sub","code": "function sub(a, b) { let data = a - b; return data; } "},
        {"name": "mul","code": "function mul(a, b) { let data = a * b; return data; } "}
    ]
}'
----

[[create-update-a-collection-of-libraries]]
== Create or Update a Collection of Libraries

.Path
....
POST /functions/v1/libraries
....

Note that if any specified library exists, the functions specified in the body for that library will be appended to the existing library.
If the function in the library exists in the library on the server, the function will be overwritten.

The example below adds or updates two libraries, `math` and `science`.

[source,console]
----
$ curl -X POST \
  http://localhost:8093/functions/v1/libraries \
  -u Administrator:password \
  -H 'content-type: application/json' \
  -d '[
  {
    "name": "math",
    "functions":
    [
      {
        "name": "adder",
        "code": "function adder(a, b) { return a + b; } function helper() { return; }"
      },
      {
        "name": "multiplier",
        "code": "function multiplier(a, b) { return a * b; } function helper() { return; }"
      }
    ]
  },
  {
    "name": "science",
    "functions":
    [
      {
        "name": "f2c",
        "code": "function f2c(f) { return (5/9)*(f-32); }"
      }
    ]
  }
]'
----

[[read-a-function]]
== Read a Function

.Path
....
GET /functions/v1/libraries/{library_name}/functions/{function_name}
....

Returns the specified function from the specified library.

The example below gets the function `sub` from the library `math`.

[source,console]
----
$ curl -X GET \
  http://localhost:8093/functions/v1/libraries/math/functions/sub \
  -u Administrator:password
----

[[read-a-library]]
== Read a Library

.Path
....
GET /functions/v1/libraries/{library_name}
....

Returns a library with all its functions.

The example below gets all functions in the library `math`.

[source,console]
----
$ curl -X GET \
  http://localhost:8093/functions/v1/libraries/math \
  -u Administrator:password
----

[[read-all-libraries]]
== Read All Libraries

.Path
....
GET /functions/v1/libraries
....

Returns all libraries and functions.

The example below fetches all defined libraries.

[source,console]
----
$ curl -X GET \
  http://localhost:8093/functions/v1/libraries \
  -u Administrator:password
----

[[delete-a-function-in-a-library]]
== Delete a Function in a Library

.Path
....
DELETE /functions/v1/libraries/{library_name}/functions/{function_name}
....

Deletes the specified function in a library.

The example below deletes the function `sub` in the `math` library.

[source,console]
----
$ curl -X DELETE \
  http://localhost:8093/functions/v1/libraries/math/functions/sub \
  -u Administrator:password \
  -H 'content-type: application/json'
----

[[delete-an-entire-library]]
== Delete an Entire Library

.Path
....
DELETE /functions/v1/libraries/{library_name}
....

Deletes the specified library entirely.

The example below deletes the `math` library entirely.

[source,console]
----
$ curl -X DELETE \
  http://localhost:8093/functions/v1/libraries/math \
  -u Administrator:password
----

[[delete-all-libraries]]
== Delete All Libraries

.Path
....
DELETE /functions/v1/libraries
....

Deletes all libraries entirely.

The example below deletes all libraries defined in the system.

[source,console]
----
$ curl -X DELETE \
  http://localhost:8093/functions/v1/libraries \
  -u Administrator:password
----

[[replace-a-function]]
== Replace a Function

.Path
....
PUT /functions/v1/libraries/{library_name}/functions/{function_name}
....

This has same effect as <<create-update-a-function,creating or updating a function>>, and is included for completeness.

[[replace-a-library]]
== Replace a Library

.Path
....
PUT /functions/v1/libraries/{library_name}
....

This has exactly the same effect as <<delete-an-entire-library,deleting an entire library>> followed by <<create-update-a-library,creating a library>>.

That is, if the library exists, it is deleted entirely and replaced with the contents of the library specified in the body of this call, resulting in the library having only functions specified by this call exclusively.

The example below replaces the `math` library with a new copy, dropping any old `math` library.

[source,console]
----
$ curl -X PUT \
  http://localhost:8093/functions/v1/libraries/math \
  -u Administrator:password \
  -H 'content-type: application/json' \
  -d '{
    "name": "math",
    "functions": [
        {"name": "add","code": "function add(a, b) { let data = a + b; return data; } "},
        {"name": "sub","code": "function sub(a, b) { let data = a - b; return data; } "},
        {"name": "mul","code": "function mul(a, b) { let data = a * b; return data; } "}
    ]
}'
----

[[replace-all-libraries]]
== Replace All Libraries

.Path
....
PUT /functions/v1/libraries
....

This has exactly the same effect as <<delete-all-libraries,deleting all libraries>> followed by <<create-update-a-collection-of-libraries,creating a collection of libraries>>.

That is, all existing libraries in the system are deleted, and the libraries specified in the body of this call are created, resulting in the system having exclusively the libraries specified by this call.

The example below removes all libraries in the system and creates a new `math` library.

[source,console]
----
$ curl -X PUT \
  http://localhost:8093/functions/v1/libraries \
  -u Administrator:password \
  -H 'content-type: application/json' \
  -d '[
    {
        "name": "math",
        "functions": [
            {"name": "add","code": "function add(a, b) { let data = a + b; return data; } "},
            {"name": "sub","code": "function sub(a, b) { let data = a - b; return data; } "},
            {"name": "mul","code": "function mul(a, b) { let data = a * b; return data; } "}
        ]
    }
]'
----
