= Release Notes for Couchbase Server 4.1

Couchbase Server release 4.1 extends Couchbase lead as the most performant and scalable NoSQL database for mission critical enterprise applications.

== Release Notes for 4.1.2

Released in August 2016, Couchbase Server 4.1.2 is the second maintenance release in the 4.1.x series.
This maintenance release has several bug fixes related to DCP, indexing, querying, XDCR, and security.

*Fixed issues in 4.1.2*

Here are the notable fixes in the 4.1.2 release:

[cols="20,81"]
|===
| Issue | Description

| http://www.couchbase.com/issues/browse/MB-20312[MB-20312^]
| Key value engine task will run at HIGH or LOW, but not guaranteed at the requested priority.

| http://www.couchbase.com/issues/browse/MB-20236[MB-20236^]
| Indexer process uses large amounts of CPU and RAM when no indexes are configured.

| http://www.couchbase.com/issues/browse/MB-20182[MB-20182^]
| When upgrading from 2.5.x to 4.x.x, TAP followed by DCP can result in a failure.

| http://www.couchbase.com/issues/browse/MB-20153[MB-20153^]
| When running multiple N1QL clients with request cancellation or low scan timeout values, a race condition in connection shutdown causes the indexer to crash.

| http://www.couchbase.com/issues/browse/MB-20105[MB-20105^]
| `Purge Seqno` would be reset in case there was a compaction call that was not purging any items, causing tombstone items not to be purged.

| http://www.couchbase.com/issues/browse/MB-20102[MB-20102^]
| `Purge Seqno` is incorrectly passed to the compactor for development design documents preventing Couchbase Server from reclaiming the disk space.

| http://www.couchbase.com/issues/browse/MB-20047[MB-20047^]
| When using `cbdocloader` and loading files from disk, the documents are loaded except for the design documents, which are silently skipped.

| http://www.couchbase.com/issues/browse/MB-20008[MB-20008^]
| Security upgrade for `curl` to version `curl 7.49.1`.

| http://www.couchbase.com/issues/browse/MB-19843[MB-19843^]
| The View engine fails with DCP start sequence number that is greater than end sequence number error and fails to roll back.
This behavior can cause view engine indexing issues.

| http://www.couchbase.com/issues/browse/MB-19837[MB-19837^]
| By default, increase the number of non-IO threads to stay on top of all ready tasks.

| http://www.couchbase.com/issues/browse/MB-19832[MB-19832^]
| XDCR would temporarily get stuck in a loop when a node, which was previously removed from a cluster, rejoins the cluster in the situation where there are multiple Couchbase Server versions in the cluster and no mutations had previously been replicated.

| http://www.couchbase.com/issues/browse/MB-19802[MB-19802^]
| When XDCR `getMeta` receives an error that is not a network timeout type, it repairs network connection and continues in a loop to read from the client until a timeout occurs after 2 minutes.
In this window, XDCR replication appears stuck.

| http://www.couchbase.com/issues/browse/MB-19757[MB-19757^]

http://www.couchbase.com/issues/browse/MB-19608[MB-19608^]
| TLS configuration on the port 11207 is lost on server restart.

TLS configuration on the port 11208 is lost on server restart.

| http://www.couchbase.com/issues/browse/MB-19714[MB-19714^]
| After lots of document UPSERT operations, high CPU utilization remains for nodes with GSI indexes for an indefinite time even if there are no more UPSERT operations.

| http://www.couchbase.com/issues/browse/MB-19697[MB-19697^]
| More than one XDCR replication instance might start after replication is resumed, resulting in incorrect functional behavior and performance impact.

| http://www.couchbase.com/issues/browse/MB-19659[MB-19659^]
| `select count(*)` does not work correctly when used in a prepared statement.

| http://www.couchbase.com/issues/browse/MB-19635[MB-19635^]
| An offline upgrade from Couchbase Server version 2.5 to any version of a Couchbase Server release 3.x could result in a potential data loss.

| http://www.couchbase.com/issues/browse/MB-19599[MB-19599^]
| The Couchbase Web Console and REST API over HTTPS do not work for center web clients such as Chrome 50 or higher that are sending elliptic curve X25519 requests for TLS.

| http://www.couchbase.com/issues/browse/MB-19503[MB-19503^]
| Under a low mutation rate, long pauses can occur when updating View indexes.

| http://www.couchbase.com/issues/browse/MB-19473[MB-19473^]
| Fixed incorrect an error message for Go-XDCR when upgrading with swap-rebalance from Couchbase Server version 3.x.

| http://www.couchbase.com/issues/browse/MB-19371[MB-19371^]
| When switching from full eviction to value eviction, if the total metadata is bigger than the memory quota of the bucket keys will not be loaded even when warmup is complete and the bucket is online.

| http://www.couchbase.com/issues/browse/MB-19364[MB-19364^]
| Memcached bucket will cause the query `select * from system:keyspaces` to fail.

| http://www.couchbase.com/issues/browse/MB-18975[MB-18975^]
| In a multi-node cluster, two `cbq` shell sessions connected to distinct nodes have a window where index metadata is not fully synchronized.

| http://www.couchbase.com/issues/browse/MB-18949[MB-18949^]
| GOXDCR needs to handle `NOT_MY_VBUCKET` errors more gracefully, without restarting.

| http://www.couchbase.com/issues/browse/MB-18453[MB-18453^]
| When a high-priority task is busy, tasks of lower priorities never have a chance to run and have been observed waiting for many hours.
This behavior can, for example, result in a node failover caused by the lack of response to statistics calls.

| http://www.couchbase.com/issues/browse/MB-18452[MB-18452^]
| If a DCP consumer is hit with more data than it can consume, it will run the Processor task for as long as this situation continues resulting in NON-IO threads being held and preventing other NON-IO tasks from running.

| http://www.couchbase.com/issues/browse/MB-16766[MB-16766^]
| The Cluster manager continuously crashes on an undersized system
|===

See the following link for a https://issues.couchbase.com/browse/MB-19532[full list of issues.^]

*Known issues in 4.1.2*

The following are the known issues:

[cols="20,81"]
|===
| Issue | Description

| http://www.couchbase.com/issues/browse/MB-16831[MB-16831^]
| *Summary:* When creating a Global Secondary Index (GSI), the interactive query shell `cbq` can time out if the result is not returned within 2 minutes.
Although the index is successfully created, the error message is unclear.

**Workaround:**Create the index with `defer_build:true` and then build the index separately.

| http://www.couchbase.com/issues/browse/MB-16618[MB-16618^]
| *Summary:* When the View queries with the options `reduce` and `group` set to `true` are parameterized by a list of keys that are not listed in ascending order, the produced results might not be properly reduced.

*Workaround:* Ensure that the list of keys passed to the query is in ascending order.
|===

== Release Notes for 4.1.1

Couchbase Server 4.1.1, which is released in April 2016, is the first maintenance release in the 4.1.x series for Couchbase Server.

*Fixed issues in 4.1.1*

The following issues are now fixed:

[cols="1,4"]
|===
| Issue | Description

| http://www.couchbase.com/issues/browse/MB-19018[MB-19018^]
| `goxdcr` terminated during the longevity test with an error: [.out]`unexpected empty bucketName`.

| http://www.couchbase.com/issues/browse/MB-18912[MB-18912^]
| `MutationQueue` was waiting for Node Alloc (hung indexer).

| http://www.couchbase.com/issues/browse/MB-18887[MB-18887^]
| During the longevity test, when failover and rebalance were performed the XDCR stream stopped with errors in logs.

| http://www.couchbase.com/issues/browse/MB-18798[MB-18798^]
| Hanging process was observed in `n1ql_lat_Q2_20M_18Kops_450Qops_gsi_false.test`.

| http://www.couchbase.com/issues/browse/MB-18651[MB-18651^]
| The Indexer would pick up a wrong file if restarted during compaction.

| http://www.couchbase.com/issues/browse/MB-18476[MB-18476^]
| Handle write failures in the mutation log more gracefully.

| http://www.couchbase.com/issues/browse/MB-18251[MB-18251^]
| The cbq-engine consumed all 11210 connections on Windows.

| http://www.couchbase.com/issues/browse/MB-18072[MB-18072^]
| mcd aborted during rebalance.

| http://www.couchbase.com/issues/browse/MB-17758[MB-17758^]
| XDCR needs to add a timeout to call out to the remote cluster.

| http://www.couchbase.com/issues/browse/MB-17517[MB-17517^]
| A corrupted  `max_cas` value in the vbucket breaks the HLC semantics.

| http://www.couchbase.com/issues/browse/MB-17506[MB-17506^]
| NMVB should not contain a cluster_config body if the client has already received the same cluster_config version

| http://www.couchbase.com/issues/browse/MB-17481[MB-17481^]
| High intra-cluster XDCR bandwidth usage was reported.
[4.1]

| http://www.couchbase.com/issues/browse/MB-17341[MB-17341^]
| When applying a new configuration, the janitor agent sets up new replication streams against vbuckets while they are still dead (before they have been activated).

| http://www.couchbase.com/issues/browse/MB-17006[MB-17006^]
| The DCP Producer could miss streaming items from certain streams.

| http://www.couchbase.com/issues/browse/MB-17174[MB-17174^]
| [.cmd]`cbcollect_info` has a long duration and takes space due to [.cmd]`couch_dbinfo`.

| http://www.couchbase.com/issues/browse/MB-17030[MB-17030^]
| Rebalance exited with this reason: `{badmatch, {error, {failed_nodes.`

| http://www.couchbase.com/issues/browse/MB-17004[MB-17004^]
| Long pauses have been observed during the N1QL performance regression tests.

| http://www.couchbase.com/issues/browse/MB-16913[MB-16913^]
| A crash was observed during the secondary (not N1QL) `stale=false` throughput tests.

| http://www.couchbase.com/issues/browse/MB-16826[MB-16826^]
| Couchbase Server occasionally fails to restart.

| http://www.couchbase.com/issues/browse/MB-16732[MB-16732^]
| [.cmd]`DELETE` with the `WHERE` clause is not consistent when used right after [.cmd]`INSERT`.

| http://www.couchbase.com/issues/browse/MB-[MB-16616^]
| Prepared Statement failing for `SELECT COUNT(*) AS test1_count FROM default`

| http://www.couchbase.com/issues/browse/MB-[MB-16614^]
| The calendar gets hours of day fetching -1.

| http://www.couchbase.com/issues/browse/MB-[MB-15706^]
| GoXDCR: DCP was stuck for more than 13 minutes.
|===

*Known issues in 4.1.1*

The following are the known issues:

[cols="20,81"]
|===
| Issue | Description

| http://www.couchbase.com/issues/browse/MB-18734[MB-18734^]
| Indexer data loss at the restart was observed.

| http://www.couchbase.com/issues/browse/MB-18476[MB-18476^]
| Handle write failures in mutation log more gracefully.

| http://www.couchbase.com/issues/browse/MB-18564[MB-18564^]
| [.cmd]`cbbackupwrapper` needs a path to [.cmd]`cbbackup.exe` with no spaces.

| http://www.couchbase.com/issues/browse/MB-18453[MB-18453^]
| Task scheduling: when a high priority task is busy, tasks of lower priorities never get a chance to run and wait for many hours.

| http://www.couchbase.com/issues/browse/MB-18452[MB-18452^]
| If a DCP consumer is hit with more data than it can consume, it runs the Processor task for as long as this continues and the NONIO threads are held preventing other NONIO tasks from running.

| http://www.couchbase.com/issues/browse/MB-17848[MB-17848^]
| Memory based accounting for the Indexer Mutation Queue.

| http://www.couchbase.com/issues/browse/MB-17808[MB-17808^]
| IA user should not disable the firewall during Windows installation.

| http://www.couchbase.com/issues/browse/MB-16999[MB-16999^]
| GSI indexes might survive the bucket deletion in some cases.

| http://www.couchbase.com/issues/browse/MB-16766[MB-16766^]
| Couchbase Server version 4.0.0 was crashing regularly on the Ubuntu AWS Instance.

| http://www.couchbase.com/issues/browse/MB-16309[MB-16309^]
| [Windows] Results from Q1 - Q3 tests were below KPI's (compared to the KPI's for Linux).
|===

== Release Notes for 4.1

Couchbase Server 4.1 was released in December 2015.

*Known Issues*

The following table lists the known issues in the 4.1 release:

[cols="20,91"]
|===
| *Issue*
| *Description*

| http://www.couchbase.com/issues/browse/MB-17004[MB-17004^]
| *Summary*: When using queries backed by GSI to perform singleton lookups and range scans, occasional processing of index compaction can incur long pauses affecting concurrent query throughput.

| http://www.couchbase.com/issues/browse/MB-16939[MB-16939^]
| *Summary*: Prepared encoded plan for N1QL statements with system catalog queries in WHERE clause may not be recognized.

*Workaround*: To avoid this issue, do not execute certain queries with prepared statements (known as `.adhoc(false)` or similar in SDK APIs).
Instead, use regular queries with system catalog queries.

| http://www.couchbase.com/issues/browse/MB-16935[MB-16935^]
| *Summary*: Kernel futex wait call can cause ForestDB to hang during initial index build.

*Workaround*: If you are running RHEL 6x or CentOS 6.x, we highly recommend upgrading to the latest kernel (2.6.32-504.16.2 or higher).
With Centos 7.1, you should upgrade to Linux kernel 3.18 at least.

| http://www.couchbase.com/issues/browse/MB-16902[MB-16902^]
| *Summary*: Latency on queries using the [.param]`request_plus` option on scan consistency may be abnormally high during index compaction, leading to application timeouts of queries.
The response times may occasionally be in the 10s of seconds or the query may return an error due to timeout.
The default timeout interval is 75 seconds.

*Workaround*:

| http://www.couchbase.com/issues/browse/MB-16831[MB-16831^]
| *Summary*: When creating a global secondary index (GSI), the interactive query shell [.api]`cbq`, can timeout if the result is not returned within 2 minutes.
Although the index is successfully created, the error message is unclear.

*Workaround*:Create the index with [.param]`defer_build:true`, and then build the index separately.

| http://www.couchbase.com/issues/browse/MB-16618[MB-16618^]
| *Summary*: View queries with reduce and group set to true, and parameterized by a list of keys that are not in ascending order, can produce results that are not properly reduced.

*Workaround*: Ensure that the list of keys passed to the query is in ascending order.

| http://www.couchbase.com/issues/browse/MB-16115[MB-16115^]
| *Summary*: When the indexer settings are changed, the connections from the query shell [.cmd]`cbq` can sometimes become stale causing an EOF errors.

*Workaround*: Restart the query engine before executing the query again.

| http://www.couchbase.com/issues/browse/MB-15968[MB-15968^]
| *Summary*: Replication over SSL encryption from a source 4.0 cluster to a destination 2.5.x cluster may result in slow performance (rate of data transfer).

*Workaround*: We recommend upgrading the destination cluster to 3.x version.
|===

*Fixed issues*

Here are some of the notable fixes in the 4.1 release:

[cols="20,91"]
|===
| *Issue*
| *Description*

| http://www.couchbase.com/issues/browse/MB-16689[MB-16689^]
| Memcached process crashed if it ran out of file descriptors during log rotation.

| http://www.couchbase.com/issues/browse/MB-16528[MB-16528^]
| If delta-node recovery was started after updating the bucket configuration, but before the bucket was loaded into memcached, a rebalance operation sometimes ejected the node from the cluster and the cluster vBucket map still contained the node

| http://www.couchbase.com/issues/browse/MB-16435[MB-16435^]
| Couchbase Server failed to start on OS X 10.11 (El Capitan).

| http://www.couchbase.com/issues/browse/MB-16421[MB-16421^]
| If a getMeta was issued at the destination cluster during XDCR followed by a GET request by the client, the background fetch operation for the item did not complete and caused a large number of disk reads and client side timeouts.

| http://www.couchbase.com/issues/browse/MB-16389[MB-16389^]
| When deletion of a large bucket happened in the background, rebalance was disabled, and the status of the ongoing background task was shown in the UI.

| http://www.couchbase.com/issues/browse/MB-16385[MB-16385^]
| Querying a view with a reduce function based on a subset of partitions resulted in a massive memory usage.

| http://www.couchbase.com/issues/browse/MB-16357[MB-16357^]
| If a vBucket state changed from active to replica while performing compaction, the race condition between the compaction thread and memcached thread sometimes caused an assertion and triggered a crash.

| http://www.couchbase.com/issues/browse/MB-16244[MB-16244^]
| Running the Elasticsearch connector sometimes resulted in high CPU usage.

| http://www.couchbase.com/issues/browse/MB-16159[MB-16159^]
| DCP consumer would consistently take 6 seconds to acknowledge a 20Mb mutation.

| http://www.couchbase.com/issues/browse/MB-16125[MB-16125^]
| Memcached would sometimes hang during shutdown.

| http://www.couchbase.com/issues/browse/MB-16067[MB-16067^]
| On a Windows system, the XDCR remote cluster reference was not updated after a node was removed from the cluster.

| http://www.couchbase.com/issues/browse/MB-16013[MB-16013^]
| XDCR based on DCP consumed a large amount of RAM with large mutations.

| http://www.couchbase.com/issues/browse/MB-15876[MB-15876^]
| When using XDCR with SSL, replication to an older cluster failed after an online upgrade to 4.0 and an error message that the pipeline failed to start was received.

| http://www.couchbase.com/issues/browse/MB-13948[MB-13948^]
| The mapping phase of the view MapReduce operation took a lot of memory if lots of key-value pairs were emitted per document.
|===

For the complete list of issues fixed in 4.1 release, see the following https://issues.couchbase.com/browse/MB-16887?jql=project%20%3D%20MB%20AND%20issuetype%20%3D%20Bug%20AND%20resolution%20%3D%20Fixed%20AND%20fixVersion%20%3D%204.1.0[JIRA query^].
