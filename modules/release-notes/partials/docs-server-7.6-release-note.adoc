[#new-features]
== New Features and Enhancements

include::introduction:partial$new-features-76.adoc[]

=== Cluster Manager


[#table-new-features-760-cluster-manager, cols="10,40"]
|===
|Feature | Description

| https://issues.couchbase.com/browse/MB-57470[MB-5740]
| New bucket capability for replica reads using sub-document API.

| https://issues.couchbase.com/browse/MB-59068[MB-59068]
| New `pruneAge` audit setting to set the minimum duration to retain audit files.

|===

=== Query Service

[#table-new-features-760-query-service, cols="10,40"]
|===
|Feature | Description

| https://issues.couchbase.com/browse/MB-57500[MB-57500]
| `num_replica` configured for each index can now be found through {sqlpp} statement: `system:indexes`

|===

=== Query Service

[#table-new-features-760-query-service, cols="10,40"]
|===
|Feature | Description

| https://issues.couchbase.com/browse/MB-30383[MB-30383]
| The {sqlpp} language adds an OFFSET clause to the DELETE statement.

| https://issues.couchbase.com/browse/MB-49506[MB-49506]
| The {sqlpp} language adds a GROUP AS clause to the GROUP BY clause.

| https://issues.couchbase.com/browse/MB-26683[MB-26683]
| The {sqlpp} language adds a FORMALIZE() function.

| https://issues.couchbase.com/browse/MB-57486[MB-57486]
| The {sqlpp} language adds a NODE_UUID() function.

| https://issues.couchbase.com/browse/MB-57961[MB-57961]
| The {sqlpp} language adds multi-byte aware string functions.

| https://issues.couchbase.com/browse/MB-22424[MB-22424]
| The {sqlpp} language adds support for sequences.

| https://issues.couchbase.com/browse/MB-54197[MB-54197]
| The {sqlpp} language adds a LATERAL keyword to ANSI joins, ANSI nests, and comma-separated joins.

| https://issues.couchbase.com/browse/MB-56524[MB-56524]
| The {sqlpp} language adds an EXPLAIN FUNCTION statement.

| https://issues.couchbase.com/browse/MB-11512[MB-11512]
| The WITH clause adds support for recursive CTEs.

| https://issues.couchbase.com/browse/MB-38696[MB-38696]
| The CREATE COLLECTION statement adds support for maxTTL.

| https://issues.couchbase.com/browse/MB-53472[MB-53472]
| The cbq shell adds a `-query_context` command line option.

| https://issues.couchbase.com/browse/MB-56912[MB-56912]
| The cbq shell adds an `-advise` command line option.

| https://issues.couchbase.com/browse/MB-56743[MB-56743]
| The Query Admin REST API adds an `/admin/gc` endpoint to run the garbage collector.

| https://issues.couchbase.com/browse/MB-57931[MB-57931]
| The `/clusterInit` endpoint in the Nodes and Clusters REST API adds support for Query memory quotas.

| https://issues.couchbase.com/browse/MB-56372[MB-56372]
| When a query executes a user-defined function, profiling information is now available for any queries within the UDF.

| https://issues.couchbase.com/browse/MB-52634[MB-52634]
| Named parameters can now be prefixed by `$` or `@` in a query.

| https://issues.couchbase.com/browse/MB-51250[MB-51250]
| Users can now create a JavaScript function and the corresponding {sqlpp} function in a single statement.

| https://issues.couchbase.com/browse/MB-55036[MB-55036]
| The Query service adds new cluster-level, node-level, and request-level parameters to support reading from replica vBuckets.

| https://issues.couchbase.com/browse/MB-56068[MB-56068]
| The Query service adds cluster-level and node-level parameters to limit the number of CPUs.

| https://issues.couchbase.com/browse/MB-57964[MB-57964]
| The Query service adds cluster-level and node-level parameters to limit the size of explain plans in the completed requests catalog.

| https://issues.couchbase.com/browse/MB-56367[MB-56367]
| The Query service adds cluster-level and node-level parameters to support node quotas.

| https://issues.couchbase.com/browse/MB-57537[MB-57537]
| The Query service adds new command line and UI parameters to support node quotas.

| https://issues.couchbase.com/browse/MB-52184[MB-52184]
| The Query service adds support for sequential scans, which enables querying without an index.

| https://issues.couchbase.com/browse/MB-52359[MB-52359]
| The node-level and request-level N1QL Feature Control parameters now accept hexadecimal strings or decimal integers.

| https://issues.couchbase.com/browse/MB-57717[MB-57717]
| Optimizer statistics for the Query service are now stored in the `&lowbar;system.&lowbar;query` collection for each bucket.

| https://issues.couchbase.com/browse/MB-58465[MB-58465]
| If an uncovered query only references specific fields, the fetch operation retrieves just the necessary fields from the Data service, instead of the entire document.

| https://issues.couchbase.com/browse/MB-57496[MB-57496]
| The SORT BY and GROUP BY operations overspill to disk if they exceed the Query service memory quota.

| https://issues.couchbase.com/browse/MB-53384[MB-53384]
| Correlated subqueries can use primary index or sequential scan.

| https://issues.couchbase.com/browse/MB-29708[MB-29708]
| INSERT, DELETE, UPDATE, and UPSERT operations can perform mutations as bulk operations.

|===

[#deprecated-features-and-platforms-760]
== Deprecated and Removed Features and Platforms


* Removed support for TLS 1.0 and 1.1.
Both the standards bodies and Couchbase have already deprecated these versions due to their lack of security. (https://issues.couchbase.com/browse/MB-58045[MB-58045])

[#fixed-issues-760]
== Fixed Issues

This release contains the following fixes.


=== Cluster Manager

[#table-fixed-issues-76-cluster-manager,cols="10,40,40]
|===

|Issue | Description | Resolution

| https://issues.couchbase.com/browse/MB-60568[MB-60568]
| CPU utilization rate may be incorrect in a VM. +
When running a VM on a XEN hypervisor,
stats were computed using the number of processors configured for the entire system.
a| Stats now use the number of logical processors online on the system. This correction affects the following stats:

* `sys_cpu_host_cores_available`
* `sys_cpu_utilization_rate`
* `sys_cpu_host_utilization_rate`

|===

=== Storage
[#table-fixed-issues-76-storage, cols="10,40,40"]
|===
|Issue | Description | Resolution

| https://issues.couchbase.com/browse/MB-58088[MB-58088]
| KV returns `temporary failure` for invalid unlock request.
| Introduced the `NOT_LOCKED` `(0x0e)` MCBP status code. +
When issuing a second Unlock with the same CAS, the server should return `NOT_LOCKED`, not `TEMPFAIL`.
Clients with `XERROR` support will receive the new status code, and will
use the JSON error map to interpret it.

| https://issues.couchbase.com/browse/MB-59060[MB-59060]
| KV returns "temp fail" in full eviction instead of an `unlock` request for a non-cached document.
The server should return `KEYENOENT` (key/doc does not exist), not `ETMPFAIL`.
| The server now correctly returns `KEYENOENT`. Moreover, when the server issues `unlock` requests for existing documents, such that some of them have been evicted, then the server will return `NOT_LOCKED` for all the requests.

|===


=== XDCR
[#table-fixed-issues-76-xdcr, cols="10,40,40"]
|===
|Issue | Description | Resolution

| https://issues.couchbase.com/browse/MB-58671[MB-58671]
| Erroneous network conditions could lead to checkpoint manager slow at stopping.
| Ensure the checkpoint manager stops, even if it has trouble starting due to network issues.

| https://issues.couchbase.com/browse/MB-59233[MB-59233]
| In low-priority replications, it is possible for a Data Service stream to end temporarily and for XDCR to not handle it correctly. This will lead to a hung replication.
| Now, XDCR restarts the pipeline if a data service stream ends. +
  This ensures replication continues.

| https://issues.couchbase.com/browse/MB-59320[MB-59320]
|  Race condition in starting and stopping XDCR source nozzle could lead to a memory leak
| Fixed the race condition

| https://issues.couchbase.com/browse/MB-59416[MB-59416]
|  If the Bandwidth throttler is used, race condition may occur during pipeline shutdown where the `Out` nozzle is unable to exit
| Fix race condition during shutdown to ensure out nozzle closes properly.

| https://issues.couchbase.com/browse/MB-59499[MB-59499]
| In a slow running backfill replication, XDCR could be too aggressive in restarting pipelines.
| Ensure XDCR does not restart backfill pipelines if some progress is observed periodically.

| https://issues.couchbase.com/browse/MB-59669[MB-59669]
|  If a replication is idle without mutations, XDCR is unable to detect that a target bucket failover occurred.
| Ensure target-side failover detection takes place, even if the source has no incoming mutations

| https://issues.couchbase.com/browse/MB-59745[MB-59745]
| When a target document is locked, and a non-optimistic LWW replication is taking place, XDCR will retrieve a "locked CAS" of maxUint. This will cause the source mutation to lose, and lead to scenarios where the mutation is not replicated, even if it should have won conflict resolution.
| XDCR will retry conflict resolution for the duration that the document is locked in pessimistic replication. This will ensure that a valid CAS is used for source-side conflict resolution.

|===


=== Query Service

[#table-fixed-issues-76-query-service, cols="10,40,40"]
|===
|Issue | Description | Resolution

| https://issues.couchbase.com/browse/MB-39484[MB-39484]
| Remove {sqlpp} support for password-less buckets.
| Password-less bucket support removed.

| https://issues.couchbase.com/browse/MB-58648[MB-58648]
| Observed a memory leak with multiple executions of the same UDF function.
| Fix the condition whereby UDF functions are being re-loaded into cache from storage every time the function is executed.

| https://issues.couchbase.com/browse/MB-60942[MB-60942]
| ANSI MERGE errors on multiple DELETE operations.
| Fixed the behavior where a target document (to be deleted) matches  multiple source documents.
  Instead of silently ignoring the second deletion, the system will now trigger an error if the target document matches multiple source documents.

|===


=== Index Service

[#table-fixed-issues-76-index-service, cols="10,40,40"]
|===
|Issue | Description | Resolution

| https://issues.couchbase.com/browse/MB-59138[MB-59138]
| Index has 0 entries when `NESTED ARRAY FLATTEN_KEYS()`, and one of them has missing entries.
| Null or missing entries are now correctly expanded for nested arrays.

|===

=== Search Service
[#table-fixed-issues-76-search-service, cols="10,40,40"]
|===
|Issue | Description | Resolution

| https://issues.couchbase.com/browse/MB-59858[MB-59858]
| When a Search index name is too long, the index silently fails to ingest documents.
|The UI will now flag instances where the chosen index name is too long.

| https://issues.couchbase.com/browse/MB-60718[MB-60718]
| Index alias queries not returning cumulative (duplicate) results from its targets.
| [TBA]

|===

=== Tools

[#table-fixed-issues-76-tools, cols="10,40,40"]
|===
|Issue | Description | Resolution

| https://issues.couchbase.com/browse/MB-57988[MB-57988]
| `cli` should allow modifying existing collection's maxTTL
| [TBA]
|===

[#known-issues-760]
== Known Issues

This release contains the following known issues.

=== Query Service

[#table-known-issues-760-query-service, cols="1,2,2"]
|===
|Issue | Description | Workaround

| https://issues.couchbase.com/browse/MB-60958[MB-60958]
| `cbq` and the `query workbench`  will allow a user to edit documents in the system collections,
even if they lack the necessary `RBAC` privileges.
|

|===

