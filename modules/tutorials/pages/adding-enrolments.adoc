= Adding course enrolments

:description: pass:q[In this section, you're going to add enrolment details to the student records using the Couchbase SDK]

[abstract]
{description}

== Introduction

A quick recap: here's the structure of our document store:

include::partial$student-database-diagrams.adoc[tags="student-document-database-design"]

At this point, you should have a student records for Hilary Smith and Ashley Jones, along with records for three courses. You're now going to write a short program that will add enrolment details to the student records.

You're going to create another program in the same working directory that will bring together all the concepts you've learned so far:

[source, java]
----
import com.couchbase.client.core.error.CouchbaseException;
import com.couchbase.client.java.Bucket;
import com.couchbase.client.java.Cluster;
import com.couchbase.client.java.Collection;
import com.couchbase.client.java.Scope;
import com.couchbase.client.java.json.JsonArray;
import com.couchbase.client.java.json.JsonObject;
import com.couchbase.client.java.query.QueryOptions;
import com.couchbase.client.java.query.QueryResult;

import java.time.Duration;
import java.time.LocalDate;
import java.time.format.DateTimeFormatter;

public class AddEnrolments {

    public static void main(String[] args) {

        Cluster cluster = Cluster.connect("localhost",
                "Administrator", "password");    // <1>

        Bucket bucket = cluster.bucket("student-bucket");    <2>
        bucket.waitUntilReady(Duration.ofSeconds(10));    <3>

        Scope scope = bucket.scope("art-school-scope");
        Collection student_records = scope.collection("student-record-collection");    <4>

        // Retrieve the records
        JsonObject hilary = retrieveStudent(cluster,"Hilary Smith");    <5>
        JsonObject graphic_design = retrieveCourse(cluster, "graphic design");    <5>
        JsonObject art_history = retrieveCourse(cluster, "art history");    <5>

        String currentDate = LocalDate.now().format(DateTimeFormatter.ISO_DATE);     <6>

        // Create Hilary's enrolments

        JsonArray enrolments = JsonArray.create();     <7>

        enrolments.add(JsonObject.create().put("course-id", graphic_design.getString("id"))
                .put("date-enrolled", currentDate));    <8>

        enrolments.add(JsonObject.create().put("course-id", art_history.getString("id"))
                .put("date-enrolled", currentDate));    <8>

        hilary.put("enrolments", enrolments);     <9>

        student_records.upsert(hilary.getString("id"), hilary);    <10>

        cluster.disconnect();

    }

    private static JsonObject retrieveStudent(Cluster cluster, String name) throws CouchbaseException {

        final QueryResult result = cluster.query("select META().id, src.* " +
                        "from `student-bucket`.`art-school-scope`.`student-record-collection` src " +
                        "where src.`name` = $name",
                QueryOptions.queryOptions()
                        .parameters(JsonObject.create().put("name", name)));

        return result.rowsAsObject().get(0);

    }

    private static JsonObject retrieveCourse(Cluster cluster, String course) throws CouchbaseException {

        final QueryResult result = cluster.query("select META().id, crc.* " +
                "from `student-bucket`.`art-school-scope`.`course-record-collection` crc " +
                "where crc.`course-name` = $courseName",
                QueryOptions.queryOptions()
                        .parameters(JsonObject.create().put("courseName", course)));

        return result.rowsAsObject().get(0);

    }

}

----

<1> As you'll remember from our earlier example

<2> Marker



