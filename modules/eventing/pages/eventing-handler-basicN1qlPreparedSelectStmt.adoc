= Function: Basic N1QL Prepared Select Statment
:page-edition: Enterprise Edition
:tabs:

*Goal*: Iterate through a basic N1QL select where Eventing interacts with the Data service via a prepared N1QL statement.

* This function *basicN1qlPreparedSelectStmt* demonstrates how use a prepared N1QL select statement with a passed parameter. 
* Typically, this is done for greater performance, the cluster will typically not prepare a statement is it is already prepared.
* We have just on positional parameter $1 for "doc.iata", if we had a second parameter we would use the placeholder $2 and so on.
* Requires that the "travel-sample" sample data loaded.
* Requires a metadata bucket, a source bucket of "travel-sample".
* Deploy the Function with a Feed Boundary "From now" (Note you will log 187 lines if you use "Everything").
* Assuming you deployed "From now" mutate any document in "travel-sample" to generate a log line.
* For more detail refer to xref:eventing-language-constructs.adoc#added-lang-features[N1QL Statements].

[{tabs}] 
====
basicN1qlPreparedSelectStmt::
+
--
[source,javascript]
----
// Deploy from now then mutate a document in `travel-sample`
function OnUpdate(doc, meta) {
    // ignore information we don't care about
    if (doc.type !== 'airline') return;
    
    var route_cnt = 0;       // we want to get the total routs per iata
    var results = N1QL("SELECT COUNT(*) AS cnt " +
        "FROM `travel-sample` " +
        "WHERE type = \"route\" AND airline = $1",
        [doc.iata], { isPrepared: true }
      );      
        
    for (var item of results) {   // Stream results using 'for' iterator.
        route_cnt = item.cnt;
    }
    results.close();              // End the query and free resources held
    
    // Just log the KEY, AIRLINE and ROUTE_CNT it to the Application log
    log("key: " + meta.id + ", airline: "+doc.iata+", route_cnt: "+route_cnt);
}
----
--

Input Data/Mutation (via the following N1QL statement)::
+
--
[source,N1QL]
----
UPDATE `travel-sample` USE KEYS "airline_24" SET id = 24;
----
--

Output Data/Logged::
+ 
-- 
[source,json]
----
2020-08-25T14:19:13.589-07:00 [INFO] "key: airline_24, airline: AA, route_cnt: 2354"
----
--
====
