= Function: convertAdvXMLtoJSON
:description: pass:q[Recursively and generically convert advanced XML strings into JSON.]
:page-edition: Enterprise Edition
:tabs:

*Goal*: {description}

* This function *convertAdvXMLtoJSON* shows how to convert advanced XML strings into JSON.
* This function will handle items and constructs that *xref:eventing-handler-convertXMLtoJSON.adoc[convertXMLtoJSON]* will fail on 1) empty-element tags and 2) attributes.
+
--
[source,javascript]
----
<ADVELEM1 adv_attrA="adv_valA" />

<ADVELEM2 adv_attrA="adv_valA" adv_attrB="adv_valB">
    <SUB>
        SUBDATA
    </SUB>
</ADVELEM2>
----
--
* Requires Eventing Storage (or metadata collection) and a "source" collection.
* Will operate on any mutation where the KEY or meta.id starts with "xml:".
* Will enrich the source document with a new JSON object representing the XML data.
* Maintains a checksum to prevent the overhead of conversion if the property `in_xml` is unchanged.

[{tabs}] 
====
convertAdvXMLtoJSON::
+
--
[source,javascript]
----
				}
			}
		}
		const key = res[1] || res[3];
		var value = res[2] && parseAdvXmlToJson(res[2], true);
		if (res[2] === "" && Object.keys(attrs).length > 0) {
			value = {};
		}
		if (attrs[key]) {
			for (const p in attrs[key]) {
				if (attrs[key][p]) {
					value[p] = attrs[key][p];
				}
			}
		}
		attrs = {};
		var tmp = ((value && Object.keys(value).length) ? value : res[2]) || null;
		if (Array.isArray(json[key]) == false) {
			if (json[key]) {
				// we have seen this key before change from object to an array of objects
                var old = json[key];
                json[key] = [];
                json[key].push(old);
                json[key].push(tmp);
			} else {
			    // link to a custom function
			    tmp = customParseFixups(key,tmp);			
				json[key] = tmp;
			}
		} else {
			json[key].push(tmp);
		}
	}
	return json;
}
*/
----
--

Input Data/Mutation::
+
--
[source,json]
----
INPUT: KEY advxml::1

{
  "type": "advxml",
  "id": 1,
  "in_xml": "<CD><ADVELEM1 adv_attrA=\"adv_valA\"/><ADVELEM2 adv_attrA=\"adv_valA\" adv_attrB=\"adv_valB\"><SUB>SUBDATA</SUB><TITLE>EmpireBurlesque</TITLE><ARTIST>BobDylan</ARTIST><COUNTRY>USA</COUNTRY><COMPANY>Columbia</COMPANY><PRICE>10.90</PRICE><YEAR>1985</YEAR></CD>"
}
----
--

Output Data/Mutation::
+ 
-- 
[source,json]
----
UPDATED/OUTPUT: KEY advxml::1

{
  "type": "advxml",
  "id": 1,
  "in_xml": "<CD><ADVELEM1 adv_attrA=\"adv_valA\"/><ADVELEM2 adv_attrA=\"adv_valA\" adv_attrB=\"adv_valB\"><SUB>SUBDATA</SUB></ADVELEM2><TITLE>EmpireBurlesque</TITLE><ARTIST>BobDylan</ARTIST><COUNTRY>USA</COUNTRY><COMPANY>Columbia</COMPANY><PRICE>10.90</PRICE><YEAR>1985</YEAR></CD>",
  "out_json": {
    "CD": {
      "ADVELEM1": {
        "adv_attrA": "adv_valA"
      },
      "ADVELEM2": {
        "SUB": "SUBDATA",
        "adv_attrA": "adv_valA",
        "adv_attrB": "adv_valB"
      },
      "TITLE": "EmpireBurlesque",
      "ARTIST": "BobDylan",
      "COUNTRY": "USA",
      "COMPANY": "Columbia",
      "PRICE": "10.90",
      "YEAR": "1985"
    }
  },
  "xmlchksum": "99b252d9af646320"
}
----
--
====
