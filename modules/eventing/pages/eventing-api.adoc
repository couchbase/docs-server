[#eventing_api]
= Functions API

[abstract]
Methods made available by Functions.

== Create a Function

[source,bourne]
----
POST /api/v1/functions/<name>
----

The function _name_ in the body must match that on the URL.
Function definition includes current settings.

Multiple functions cannot have the same name.
An error is reported in such cases.

== Create Multiple Functions

[source,bourne]
----
POST /api/v1/functions/
----

Multiple functions cannot have the same name.
An error is reported in such cases.

== Get a Function

[source,bourne]
----
GET /api/v1/functions/<name>
----

Function definition includes its settings.

== Get All Functions

[source,bourne]
----
GET /api/v1/functions
----

== Delete a Function

[source,bourne]
----
DELETE /api/v1/functions/<name>
----

== Delete All Functions

[source,bourne]
----
DELETE /api/v1/functions
----

== Manipulate a Function's Settings

[source,bourne]
----
GET /api/v1/functions/<name>/settings
----

== Modify a Function's Settings

[source,bourne]
----
POST /api/v1/functions/<name>/settings
----

Settings provided are merged, and so unspecified elements retain their prior values.

== Get the Eventing Global Configuration

[source,bourne]
----
GET /api/v1/config
----

== Manipulate the Eventing Global Configuration

[source,bourne]
----
POST /api/v1/config
----

Configuration provided is merged, and so unspecified elements retain their prior values.

The response indicates whether the Eventing service must be restarted for the submitted changes to take effect.

All available settings, with the default and a description for each, are provided in the table below.

.Settings
[#eventing_settings,cols="3,6,2"]
|===
| Setting Name | Description | Default

| app_log_max_files
| Number of rotated application log files to keep
| 10

| app_log_max_size
| Size after which application log file is archived (in bytes)
| 10485760

| breakpad_on
| If true, generates minidumps on worker crash
| true

| checkpoint_interval
| Interval for updating event processing status in metadata bucket (in milliseconds)
| 10000

| cleanup_timers
| Flag to signify if artifacts (timers) need to be cleared up
| false

| cpp_worker_thread_count
| Number of threads that each worker should spawn
| 2

| curl_timeout
| Timeout for curl calls (in milliseconds)
| 500

| dcp_stream_boundary
| Specifies from where the mutations should be processed (possible values : everything, from_now)
| everything

| deadline_timeout
| Timeout for socket operations from eventing-producer to eventing-consumer.
eventing-consumer will be respawned if it doesnâ€™t respond within this timeout.
This must be greater than execution_timeout (in seconds)
| 3

| deployment_status
| Controls deploy/undeploy of function
| false

| description
| Description of function
| 

| enable_recursive_mutation
| Flag to either allow/disallow recursive mutation when handler does bucket operation
| false

| execution_timeout
| Time for which the handler code will run, for each mutation (in seconds)
| 1

| fuzz_offset
| For cron timer creation, the worker will add a random number between [0, fuzz_offset] to the time at which it was set to kick off the cron timer callback.
| 0

| lcb_inst_capacity
| Specifies whether function should process mutation or not, while it is deployed
| false

| log_level
| Applies for system logs.
Possible fields are - INFO, ERROR, WARNING, DEBUG, TRACE
| TRACE

| processing_status
| Specifies whether function should process mutation or not, while it is deployed
| false

| skip_timer_threshold
| Interval specified to skip firing of timer events if their execution is delayed (in seconds)
| 86400

| sock_batch_size
| Batch size of events that eventing-producer sends to eventing-consumer in one socket write
| 100

| tick_duration
| Interval after which some of internal stats are written in [.path]_eventing.log_ (in milliseconds)
| 60000

| timer_processing_tick_interval
| Tick interval for timer processing routines to catch up with backlog of pending timer execution (in milliseconds)
| 500

| vb_ownership_giveup_routine_count
| Number of vBuckets given up simultaneously by each eventing worker during rebalance
| 3

| vb_ownership_takeover_routine_count
| Number of vBuckets whose ownership is taken up simultaneously by each eventing worker during rebalance
| 3

| worker_count
| Number of workers to spawn for a function
| 3

| worker_queue_cap
| Number of pending events to keep in queue on eventing-consumer before starting to backoff receiving any more events
| 100000

| xattr_doc_timer_entry_prune_threshold
| Number of stale timer records per KV doc-id before, they are garbage collected
| 100
|===

== Deploy and Undeploy a Function

[source,bourne]
----
POST /api/v1/functions/<app_name>/settings
----

An example deploy and undeploy functions are provided in the table below:

.Settings
[#table_mwx_ytc_ndb,cols="25,181"]
|===
| Function | Example API

| Deploy
| curl -XPOST -d '{"deployment_status":true,"processing_status":true}' http://<AdministratorName>@<IP_Address>/api/v1/functions/<sample_name>/settings

| Deploy a function with code
| `curl -X POST -H "Content-Type: application/json" -d@doc_timer_op.json http://<AdministratorName>@<IP_Address>/api/v1/functions/doc_timer_op`

| Undeploy
| `curl -XPOST -d '{"deployment_status":false,"processing_status":false}' http://<AdministratorName>@<IP_Address>/api/v1/functions/<sample_name>/settings`
|===
