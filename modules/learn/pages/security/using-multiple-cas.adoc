= Using Multiple Root Certificates
:description: Couchbase Server supports use of multiple CA (or 'root') certificates, for a single cluster.

[abstract]
{description}

== Benefits

Prior to Couchbase Server Version 7.1, a Couchbase-Server cluster could maintain at most _one_ root certificate: all nodes and all clients were obliged to rely on this certificate's authority.
From version 7.1, Couchbase Server permits multiple root certificates to maintained in a _trust store_ for the cluster.
This:

* Allows an individual node either to use a CA that is also used by one or more other nodes; or to use a CA that is used by no other node.
This may be used to increase security: ensuring that a node can be successfully authenticated by some applications, but not by others.

* In cases where certificate-based client authentication is activated, allows a client to authenticate with reference to a CA that is not used in the signing of any node-certificate, but is nevertheless maintained in the cluster's trust store.
This may be used to offer administrators and developers greater flexibility, in terms of certificate-deployment; while maintaining optimal security.

All certificates in the trust store are accessible to all nodes, and multiple CAs may therefore be used in facilitating encrypted node-to-node communication.

== Illustration

A cluster-configuration that uses multiple CAs is illustrated as follows:

image::security/clusterWithCerts.png[,720,align=left]

The diagram assumes that certificate-based client authentication has been activated.

The annotations are as follows:

. A Couchbase-Server cluster is configured with four nodes, access to each of which is certificate-protected.

. The trust store for the cluster contains ten CAs, which are _CA a_ to _CA j_.
Of these, three root CAs have been used in the signing of individual node-certificates: these are _CA a, _CA e_, and _CA g_.

. The node-certificate for Node 1 is signed by an intermediate certificate, which has itself been signed by the root certificate _CA a_.

. The node-certificate for Node 2 is signed by an intermediate certificate, which, like the intermediate certificate used by Node 1, has itself been signed by the root certificate _CA a_.

. The node-certificate for Node 3 has been directly signed by the root certificate _CA e_.

. The node-certificate for Node 4 has been signed by a chain of two intermediate certificates, the highest in the chain having itself been signed by the root CA _CA g_.

. The certificate for Client 1 has been signed by an intermediate certificate, which has been directly signed by the root certificate _CA a_: this is the CA providing authority to Node 1 and Node 2.
This allows mutual authentication to proceed between Node 1 and Client 1, since the certificate of each takes its authority from _CA a_.
(Note that this is the only form of certificate-based authentication that was supported by Couchbase Server, prior to version 7.1.)

. The certificate for Client 2 has been directly signed by the root certificate _CA h_.
Client 2 also maintains the root certificate _CA a_ in its trust store.
This allows mutual authentication to proceed between Node 2 and Client 2; since Client 2 recognizes the authority of _CA a_, and Node 1 recognizes the authority of _CA h_.
In each case, the recognized root CA exists in the entity's trust store, but has not played a role in the signing of the entity's own certificate.

. The certificate for Client 3 has been signed by an intermediate certificate, which has itself been signed by the root certificate _CA k_.
Client 3 also maintains _CA e_ in its trust store.
This prevents mutual authentication from occurring between Client 3 and Node 3: although the certificate for Node 3 acquires its authority from _CA e_, which is in the client's trust store, and is thus recognized by the client; the client's certificate is signed by _CA k_, which is not in the cluster's trust store, and is therefore not recognized by the cluster.

. The certificate for Client 4 is directly signed by _CA c_.
The client's trust store also contains _CA e_ and _CA g_.
This allows mutual authentication to succeed between Client 4 and Node 3, since the authority of each is derived from a root certificate in its opposite's trust store.
This also allows mutual authentication to succeed between Client 4 and Node 4, for the same reason.

== Clusters Running Multiple Couchbase-Server Versions

Multiple CAs are supported by Couchbase Server Version 7.1 and later.
Typically, when a cluster is upgraded, it temporarily includes nodes of two versions; one being the version _to_ which the cluster is being upgraded, the other the version _from_ which it is being upgraded.

Once the cluster's nodes are all upgraded to version 7.1 or later, multiple CAs are fully supported.
During the upgrade period, only _some_ of the supportive APIs can be used: for information, see xref:rest-api:rest-certificate-management.adoc[Certificate Management API].

== Adding Nodes

When a new node is added to a Couchbase-Server cluster that is version 7.1 or later, the new node may be added with its existing root certificate and corresponding certificate chain, provided that the root certificate is already included in the cluster's trust store: if the node's certificate has not been added to the trust store, an error is flagged.
