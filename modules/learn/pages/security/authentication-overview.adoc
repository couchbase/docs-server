= Authentication
:page-aliases: security:security-authentication,security:security-ldap-new

[abstract]
To access Couchbase Server, administrators and applications must be authenticated.
_Authentication_ is a process for identifying a user who is attempting to access a system.

[#passing-credentials]
== Passing Credentials

Couchbase-Server authentication relies on _credentials_, which must be passed into the system by the user who is attempting access.
Credentials can be entered manually, or passed into the system by an application.
The credentials passed must match ones already stored and accessible by the system: if a match is achieved, the user is thereby recognized, and so _may_ be granted access.
If no match is achieved, the user is denied access.

To access Couchbase Server, administrators and users authenticate by means of a username and password.
These credentials can be validated by Couchbase Server itself: alternatively if the Enterprise Edition of Couchbase Server is used, validation can be performed either on a network-accessible directory-server, by means of the _Lightweight Directory Access Protocol_ (LDAP); or by means of the _Pluggable Authentication Modules_ (PAM) authentication-framework.

Client applications or systems can also pass credentials to Couchbase Server by means of x.509 _certificates_.

[#introduction-to-password-based-authentication]
== Password-Based Authentication

To access Couchbase Server, administrators and applications _must_ authenticate.
Authentication is password-based.
For additional security, applications can be designed to use passwords in hash-based challenge-response routines.

Administrator usernames and passwords, both required for authentication, are initially established during initialization of Couchbase Server: see xref:manage:manage-nodes/create-cluster.adoc[Create a Cluster] for details.
Subsequently, passwords can be changed by means of the password-reset tool, xref:cli:cbcli/couchbase-cli-reset-admin-password.adoc[reset-admin-password].

For best practices for password-definition, and restrictions on username-design, see xref:learn:security/usernames-and-passwords.adoc[Usernames and Passwords].

When the Couchbase Web Console is running on the default port, `+http://localhost:8091+`, the administrator's username and password are
passed in the clear, from the administrator's browser to the console.
Optionally, Couchbase Web Console can be configured for _secure access_, at `+https://localhost:18091+`; so that the username and password are passed in encrypted form.
For information, see xref:manage:manage-security/manage-console-access.adoc[Manage Console Access].

[#authentication-for-applications]
=== Authentication for Applications

Couchbase-Server features — including data, settings, and statistics — can be accessed only by users who have been assigned the appropriate privilege.
Privileges include _read_ and _read-write_.
Privileges are assigned by Full Administrators, in the form of _roles_.
When a user successfully authenticates, their assigned roles are examined, and access is granted or denied by Couchbase Server.
See
xref:manage:manage-security/manage-users-and-roles.adoc[Manage Users and Roles], for details on creating users and user-credentials, and on assigning roles.

To pass credentials, applications must use one of four mechanisms provided by the _Simple Authentication and Security Layer_ (SASL) framework.
These are PLAIN, and three members of the _Salted Challenge Response Authentication Mechanism_ family of hash functions; which are SCRAM-SHA1, SCRAM-SHA256, and SCRAM-SHA512.
The SCRAM mechanisms allow applications to authenticate securely, by transmitting the password only in _protected form_.
Drivers may need to be updated, to support SHA-based hash functions.

[#password-authentication-mechanisms]
=== Password Authentication-Mechanisms

In ascending order of strength, the Couchbase password-authentication mechanisms are as follows:

* _PLAIN_: The client sends the password in unencrypted form.
All clients support this authentication-method.
It is insecure, providing no defence against passwords being stolen in transmission.

* _SCRAM-SHA1_: Uses a 160-bit key.

* _SCRAM-SHA256_: One of a group of hash functions referred to as _SHA2_, SCRAM-SHA256 uses a 256-bit key.

* _SCRAM-SHA512_: Another hash function from the _SHA2_ group, SCRAM-SHA512 uses a 512-bit key; and is the strongest supported authentication protocol.

During initial client-server negotiation, the strongest authentication protocol supported by both Couchbase Server and the application's client OS is selected for use.
For example, if the client supports only the PLAIN protocol, the PLAIN protocol is used; but if the client also supports the SCRAM-SHA1 protocol, then SCRAM-SHA1 is used.

A challenge-response method can be transmitted through both encrypted and unencrypted channels.

Note that the SCRAM challenge-response protocols authenticate only the process of password-validation.
To secure the subsequent session, TLS should be used.

[#introduction-to-certificate-based-authentication]
== Certificate-Based Authentication

Couchbase Server supports the use of x.509 certificates, to authenticate clients.
This ensures that only approved users, machines, or endpoints are authenticated.

Certificate-based authentication relies on a _Certificate Authority_ (CA) to validate identities and issue certificates.
The certificate includes information such as the name of the entity it identifies, an expiration date, the name of the CA that issued the certificate, and the digital signature of the issuing CA.

For a complete overview of Couchbase Server's certificate-handling mechanisms, see xref:learn:security/certificates.adoc[Certificates].
For practical steps required to set up client and server certificates, see xref:manage:manage-security/manage-certificates.adoc[Manage Certificates]

[#introduction-to-externally-based-authentication]
== Externally Based Authentication

Couchbase Server assigns users to different _authentication domains_:

* _Local_: Contains users defined locally.
This includes:

 ** The _Full Administrator_ for Couchbase Server.

** _Locally Defined Users_, which are explicitly created by a Couchbase Server  administrator; and each feature a username and password unique within the Local domain.

 ** _Internal Components_ within Couchbase Server that support core  functionality (for example, indexing, searching, and replicating), and run  with full administrative privileges.

 ** _Generated Users_, which are created by Couchbase Server as part of the  upgrade process from pre-5.0 to 5.0 and post-5.0 versions; each in  correspondence with a legacy bucket.
Each Generated User is assigned a _username_ that is identical to the bucket-name; and either a _password_ that is identical to the bucket's pre-5.0 password, or _no password_, if the bucket did not feature a password.
Generated Users are created to ensure that legacy applications can continue to access legacy buckets after upgrade to 5.0 or post-5.0, with the same username-password combination being used for authentication.

* _External_: Contains users of either or both of the following kinds:

** Users that are explicitly defined on Couchbase Server as _external_; as supported either by _LDAP_ or _PAM_.
Usernames are stored on Couchbase Server.
Passwords are defined and stored remotely.
Note that External usernames do not clash with Local usernames.

** Users that are not defined on Couchbase Server, but are defined on LDAP; and are are members of one or more _LDAP Groups_.
+
If _Native LDAP_ is being used, and _LDAP Group Support_ has been enabled, and one or more of the user's LDAP Groups has been _mapped_ to a corresponding Couchbase-Server user-group, the user can be authenticated on the LDAP server, and then be granted the roles assigned to each of the user-groups to which a mapping has been made.

When a user attempts to authenticate, Couchbase Server always looks up their credentials in the same order: which is _Local_ first, and _External_ second.


[#introduction-to-ldap-based-authentication]
=== LDAP-Based Authentication

Couchbase users can be set up to authenticate by means of LDAP.
Two different ways of setting up LDAP are provided:

* _Native LDAP Support_.
For Couchbase Server Enterprise Edition 6.5+, this is the recommended way of setting up LDAP for external authentication.
It provides support for encrypted communication, and for LDAP groups.

* _LDAP Support Based on saslauthd_.
This is maintained for support of legacy LDAP authentication (as established on pre-6.5 versions of Couchbase Server), and for support of PAM-based authentication.
Migration to _Native LDAP_ is recommended; so that encrypted communication and _LDAP groups_ become available.

Note that _either_ Native LDAP Support _or_ `saslauthd` must be selected for the cluster.
The two cannot be used simultaneously.

[#native-ldap-support]
==== Native LDAP Support

Native LDAP support is available only for the Enterprise Edition of Couchbase Server.
Mixed-version clusters do not support LDAP authentication: therefore, to use LDAP authentication with a given cluster, upgrade all cluster-nodes to the latest version of Enterprise Edition Couchbase Server.

Couchbase Server is designed to interoperate with _OpenLDAP_ software, which can be downloaded from the http://www.openldap.org/[openldap.org^] website.
Couchbase Server also supports _Active Directory_.

[#ldap-benefits]
===== Native LDAP Benefits

Authenticating with Native LDAP provides the benefits of:

* Centralized identity and security-policy management, on the LDAP server.

* LDAP groups, which are recognized by Couchbase Server.
These provide simplified user-administration, allowing Couchbase Server-privileges to be assigned by group,
rather than just by user.
See xref:learn:security/authentication-overview.adoc#introduction-to-ldap-groups[LDAP Groups], below.

* Cross-platform support.
Native LDAP authentication can be used for clusters running on any Couchbase-Server supported operating system. (This contrasts with `saslauthd`, which runs only on Linux.)

When the administrator enters a username and password at the login prompt provided by Couchbase Web Console, this is checked against a local _admin password file_.
The credentials are then checked against an LDAP directory service: if the credentials are validated, authentication succeeds.

Couchbase Server allows Native LDAP to be configured by means of the xref:cli:cbcli/couchbase-cli-setting-ldap.adoc[setting-ldap] CLI command.

[#introduction-to-ldap-groups]
===== LDAP Groups

LDAP allows users to be members of _LDAP Groups_.
When a user authenticates with LDAP, a list of the user's LDAP groups is returned to Couchbase Server.
If an LDAP group has previously been _mapped_ to a Couchbase-Server group, the user inherits the roles assigned to the Couchbase-Server group.
Note that when LDAP Groups are used to support Couchbase-Server authorization in this way, the user does _not_ need to have been registered on Couchbase Server &#8212; even as an _external_ user.

[#native-ldap-auth-sequence]
==== Native LDAP Authentication and Authorization Sequence

Each user added to a Couchbase-Server cluster is, for authentication purposes, specified as either _local_ or _external_.
Initially, when a user attempts to access the cluster by specifying their username and password, the username is checked against the list of local usernames maintained on Couchbase Server.
If there is a match, password-verification is attempted: if this succeeds, the user is granted the roles they have been assigned either directly or by their membership of one or more Couchbase-Server _user-groups_.
If the granted roles support the user's intended action, the action is permitted; otherwise, it is prohibited.

In cases where the specified username does _not_ match against the list of locally defined users, provided that Native LDAP support has been configured, Couchbase Server attempts to authenticate and authorize the user by means of LDAP.
First, the _authentication_ sequence is performed:

. If _LDAP User Authentication_ has been enabled, Couchbase Server calculates an LDAP _Distinguished Name_ (DN) for the user, whereby the user can be authenticated on the LDAP server.
This makes use of the user-specified password and a _template_ or _query_, which has already been configured: for examples of how to configure templates and queries, see xref:manage:manage-security/configure-ldap.adoc#enable-ldap-user-authentication[Enable LDAP User Authentication].

. Couchbase Server contacts the LDAP server, and attempts to authenticate the user, using the calculated DN and the user-specified password.

. Couchbase Server receives confirmation from the LDAP server either that authentication has succeeded (meaning that the user exists, and has submitted the correct password), or that it has failed.
If authentication has failed, the authentication-process is thereby concluded, the user is _not_ granted access to Couchbase Server, and no further action is taken.

If authentication has succeeded, the authentication-process is thereby concluded; and Couchbase Server next proceeds to determine whether and in what ways the user is _authorized_ on Couchbase Server.

. Couchbase Server checks whether an _external_ user, with the specified username, has previously been added to Couchbase Server.
If such an external user is located, Couchbase Server determines which roles have been assigned to the user: first, it checks for roles that have been _directly_ assigned to the user; and secondly, it checks for roles assigned to the user by means of _group membership_.
(For information on granting roles to users directly and by means of groups, see xref:manage:manage-security/manage-users-and-roles.adoc[Manage Users, Groups, and Roles].) The user is duly granted the privileges that correspond to all assigned roles.

. If _LDAP Group Support_ has been enabled, Couchbase Server again contacts the LDAP server: this time, in order to retrieve a list of the LDAP groups of which the user is a member.
Note that this step is performed irrespective of whether or not the user has proved to be an _external_ user on Couchbase Server.
See xref:manage:manage-security/configure-ldap##enable-ldap-user-authentication[Enable LDAP User Authentication], for detailed information on configuring LDAP Group Support.

. Couchbase Server determines whether one or more of the user's LDAP groups have been _mapped_ to existing Couchbase-Server user-groups.
Wherever a mapping exists, the user is granted (in addition to whatever privileges they may have already been granted as an _external_ user) the privileges that correspond to all roles assigned to the Couchbase-Server user-group.
(For information on mapping LDAP groups to Couchbase-Server groups, see xref:manage:manage-security/configure-ldap.adoc[Configure LDAP]).
If any of the granted privileges supports the user's intended action, the action is permitted; otherwise, the action is prohibited.

For detailed, step-by-step accounts of how to configure these procedures, see xref:manage:manage-security/configure-ldap.adoc[Configure LDAP].

[#using-saslauthd]
==== Using `saslauthd`

LDAP authentication based on `saslauthd` is only available for the Enterprise Edition of Couchbase Server, and only on the Linux platform.
It provides the benefits of centralized identity and security-policy management, and of simplified compliance; as described above.
It does not support LDAP groups.

For LDAP authentication, _Native LDAP_ , rather than `saslauthd`, is recommended for Couchbase Server Enterprise Edition 6.5+.

The `saslauthd` library also can be configured in order to support PAM.
For details on configuring `saslauthd` to support external authentication by LDAP or PAM, see xref:manage:manage-security/configure-saslauthd.adoc[Configure `saslauthd`].

[#introduction-to-pam-based-authentication]
=== PAM-Based Authentication

_Pluggable Authentication Modules_ (PAM) provide an authentication framework that allows multiple, low-level authentication schemes to be used by a single API.
The _Enterprise Edition_ of Couchbase Server, running on Linux, supports administrator-authentication through PAM's _Linux password-module_.

[#pam-benefits]
==== PAM Benefits

Used with the _Enterprise Edition_ of Couchbase Server, the PAM _Linux password-module_ provides:

* _External authentication_: Administrator-accounts defined on Linux systems, in the `/etc/shadow` directory, can be accessed for authentication-purposes by Couchbase Server.

* _Password policy-management_: Linux password-management can be used across different Couchbase Server-nodes; to synchronize, maintain, and expire administrator-passwords.

==== PAM-Related Version Requirements

Use of the PAM Linux password-module requires all cluster-nodes to be Linux-based, running the Enterprise Edition of Couchbase Server, version 4.6 or above.
Additionally, the `saslauthd` library version must be 2.1.x or above.
