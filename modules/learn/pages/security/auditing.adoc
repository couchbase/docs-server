= Auditing
:page-aliases: security:security-auditing

[abstract]
Couchbase Server provides event-auditing, sending corresponding output to target files.

[#introduction-to-auditing]
== Introduction to Auditing

The Couchbase Server _auditing_ facility recognizes specific _events_, which can be selectively logged.
The output is written to target files, each of which is periodically rotated.

Couchbase events allow administrators to track the following:

* Administrative and configuration changes to the cluster.
These are logged as _admin_ events.
See xref:learn:security/auditing.adoc#administrative-events[Administrative Events], below.

* Attempts to access and change data. These are logged as _data_ events.
See xref:learn:security/auditing.adoc#data-events[Data Events], below.

Note that event-auditing occurs on a _per node_ basis: each node captures its own events only.
If a cluster-wide record is needed, the individual per node records must be manually consolidated by the administrator.

This page also explains frequently used audit fields, and gives examples of the record-structures used within target files.

For information on managing auditing, see xref:manage:manage-security/manage-auditing.adoc[Manage Auditing].


== Audit Fields

The table below contains some frequently used audit fields with corresponding descriptions.
Note that different event-types generate different field-subsets.

[cols="2,3,5"]
|===
| Field | Type | Description

| `type`
| string
| The audit-type.
For example, Login, Startup, Shutdown, Password, AuditStart, AuditStop, AuditTruncate.

| `timestamp`
| document
| Contains the date and UTC time of the event in ISO 8601 format.
For example, http://www.w3.org/TR/NOTE-datetime[^].

| `id`
| integer
| A unique identifier for the event-type.

| `local`
a|
document

[source,json]
----
{ip: <String>,
port: <int>},
----
| A JSON document that contains the local IP-address and the port-number of the running instance.

| `remote`
a|
document

[source,json]
----
{ip: <String>,
port: <int>},
----
| A JSON document that contains the remote IP-address, the port-number, and additional information on the service used on the incoming connection associated with the event.

Possible services include `cbmcd`, `cbhttp`, `cbmgmt`, `cbxdcr`, `cbn1ql`, and `cbsyncgw`.

| `user`
| string
| A string that identifies the user.

| `params`
| document
| Information dependent on the event-type.
For example, for a bucket-operation, the bucket name is captured.

| `result`
| integer or string
| An error-code or other message, related to the attempted operation.
|===

== Audit Target-Files

When auditing is enabled, logged events are written to a default file, named `audit.log`.
After an administrator-specified period — which must be a minimum of 15 minutes and a maximum of 7 days — this file is closed, and is saved under a modified name that features a timestamp corresponding to the time of saving.
A new, empty `audit.log` file is created and saved when a new audit event is generated.
Note that this _rotation_ may happen earlier if the file reaches its maximum size of 20MB.
For instructions on configuring the file's _rotation time_, see xref:manage:manage-security/manage-auditing.adoc[Manage Auditing].

=== Login

An audit-record for a successful login might appear as follows:

[source,json]
----
{
  "timestamp":"2015-02-20T08:48:49.408-08:00",
  "id":8192,
  "name":"login success",
  "description":"Successful login to couchbase cluster",
  "role":"admin",
  "real_userid": {
    "source":"ns_server",
    "user":"bjones"
  },
 "sessionid":"0fd0b5305d1561ca2b10f9d795819b2e",
 "remote":{
  "ip":"172.23.107.165", "port":59383
  }
}
----

In this example, a user named `bjones` has successfully logged into a Couchbase cluster using the domain IP address `172.23.107.165.`

==== Login Failure

The following audit-record indicates that a login attempt failed:

[source,json]
----
{
  "real_userid": {
    "source": "rejected",
    "user": "auditBucketUser"
  },
  "remote": {
    "ip": "127.0.0.1",
    "port": 64416
  },
  "timestamp": "2017-03-16T15:45:27.420Z",
    "id": 8193,
    "name": "login failure",
    "description": "Unsuccessful attempt to login to couchbase cluster"
}
----

This record indicates that a user named `auditBucketUser` incurred an `Unsuccessful attempt to login to couchbase cluster` on `2017-03-16` at `15:45:27`.

=== Bucket Creation

The audit-record below corresponds to the creation of a bucket.

[source,json]
----
{
  "props":{
    "compression_mode":"off",
    "max_ttl":12000,
    "storage_mode":"couchstore",
    "conflict_resolution_type":"seqno",
    "eviction_policy":"value_only",
    "num_threads":3,
    "flush_enabled":false,
    "purge_interval":"undefined",
    "ram_quota":163577856,
    "replica_index":false,
    "num_replicas":1
  },
  "type":"membase",
  "bucket_name":"ProductionBucket",
  "real_userid":{
    "source":"ns_server",
    "user":"Administrator"
  },
  "sessionid":"5dd53fe63703c7fdc45ff75596e39a35",
  "remote":{
    "ip":"127.0.0.1",
    "port":61908
  },
  "timestamp":"2018-02-07T15:22:54.960Z",
  "id":8201,
  "name":"create bucket",
  "description":"Bucket was created"
}
----

This record indicates that a `Bucket was created` on `2018-02-07` at `15:22:54`; that the bucket was named `ProductionBucket`; and that its eviction-policy was defined as `value_only`.
The bucket was created by the system's `Full Administrator`.

=== Bucket TTL Modification

The audit-record below corresponds to the modification of Bucket TTL, for the bucket created immediately above.

[source,json]
----
{
  "props":{
    "max_ttl":15000,
    "storage_mode":"couchstore",
    "eviction_policy":"value_only",
    "num_threads":3,
    "flush_enabled":false,
    "purge_interval":"undefined",
    "ram_quota":163577856,
    "num_replicas":1
  },
  "type":"membase",
  "bucket_name":"ProductionBucket",
  "real_userid":{
    "source":"ns_server",
    "user":"Administrator"
  },
  "sessionid":"12774a2e146c650eeed8c6d9486857ad",
  "remote":{
      "ip":"127.0.0.1","port":61966
  },
  "timestamp":"2018-02-07T15:23:51.350Z",
  "id":8202,
  "name":"modify bucket",
  "description":"Bucket was modified"
}
----

=== User Creation

The audit-record below corresponds to the creation of a user.

[source,json]
----
{
  "roles": [
    "ro_admin"
  ],
  "identity": {
    "source": "builtin",
    "user": "auditBucketUser2"
  },
  "real_userid": {
    "source": "ns_server",
    "user": "Administrator"
  },
  "sessionid": "dca284b5efe1937a1a4085ef88c2fbcb",
  "remote": {
    "ip": "127.0.0.1",
    "port": 64416
  },
  "timestamp": "2017-03-16T15:44:32.254Z",
  "id": 8232,
  "name": "set user",
  "description": "User was added or updated"
}
----

This record indicates that a user named `auditBucketUser2` was created by the `Full Administator` on `2017-03-16` at `15:44:32`; and that the user was given the role of `ro_admin`.

=== Index Creation

The following audit-record indicates that an index was created or updated:

[source,json]
----
{
  "timestamp": "2017-03-16T16:12:36.198Z",
  "real_userid": {
    "source": "ns_server",
    "user": "Administrator"
  },
  "index_name": "def-airportname",
  "id": 24577,
  "name": "Create/Update index",
  "description": "FTS index was created/Updated"
}
----

This record indicates that an `FTS` index named `def-airportname` was created or updated on `201703-16` at `16:12:36`.

[#adit_event_types]
== Audit Event-Types

Couchbase events allow administrators to track the following:

* Administrative and configuration changes to the cluster. These are logged as _admin_ events.

* Attempts to access and change data. These are logged as _data_ events.

The tables in the following sections list events according to the technology or service.

Note that events related to Data Service, Query and Index Service, Eventing Service, and Analytics are _filterable_.
For information, see xref:manage:manage-security/manage-auditing.adoc[Manage Auditing].

[#filterable-and-non-filterable-events]
== Filterable and Non-Filterable Events

Eventing for each cluster-node is _disabled_ by default; and can be explicitly _enabled_.
When enablement has occurred, a subset of Couchbase Server-events is audited, with records concatenated to the end of the `audit.log` file.

The events in the default subset are _non-filterable_. This means that while auditing is enabled for the node, the events are _always_ recorded, and cannot be selectively disabled.

An additional event-subset, of _filterable_ events, is provided. These events relate to the same modules as the non-filterable events. Filterable events can be referenced and individually disabled or enabled by _id_. Optionally, all filterable events can be ignored, for specified users

== Event Tables

The events listed in the following tables support the auditing of administrative and data changes, made on the cluster.

In each table, the first column (at the left) features the event-group heading (thereby repeating the table’s title, so as to ensure readability throughout the longer tables).
The second column provides the event name.
The third column provides the id for the event.
The fourth column provides a description of the event; the fifth describes whether it is _filterable_ (see xref:security:security-auditing.adoc#filterable-events[Filterable Events]); and the sixth indicates whether the event is classified as Data or Admin.

The tables — which are for the xref:learn:security/auditing.adoc#rest-api-event-list-table[REST API], the xref:learn:security/auditing.adoc#data-service-event-list-table[Data Service], the xref:learn:security/auditing.adoc#query-service-event-list-table[Query Service], the xref:learn:security/auditing.adoc#search-service-event-list-table[Search Service], the xref:learn:security/auditing.adoc#eventing-service-event-list-table[Eventing Service], and the xref:learn:security/auditing.adoc#audit-event-list-table[Audit] facility itself — are as follows.

[#rest-api-event-list-table]
=== REST API Events

The following events are generated by Couchbase Server in response to calls made with the REST API.

[cols="4,5,3,7,4,4"]
|===
| *Event Group* | *Event Name* | *ID* | *Description* | *Filter?* | *Event Type*
| REST API | login success | 8192 | Successful login to cluster | N | Admin
| REST API | login failure | 8193 | Unsuccessful attempt to login to cluster | N | Admin
| REST API | delete user | 8194 | User was deleted | N | Admin
| REST API | user credentials change | 8195 | User credentials were changed | N | Admin
| REST API | add node | 8196 | Node was added to the cluster | N | Admin
| REST API | remove node | 8197 | Node was removed from the cluster | N | Admin
| REST API | failover nodes | 8198 | Nodes that were failed over | N | Admin
| REST API | enter node recovery | 8199 | Entered node recovery | N | Admin
| REST API | rebalance initiated | 8200 | Rebalance was initiated | N | Admin
| REST API | create bucket |  8201 |Bucket was created | N | Admin
| REST API | modify bucket | 8202 | Bucket was modified | N | Admin
| REST API | delete bucket | 8203 | Bucket was deleted | N | Admin
| REST API | flush bucket | 8204 | Bucket was flushed | N | Admin
| REST API | start loading sample | 8205 | Started loading sample | N | Admin
| REST API | disk storage conf | 8206 | Disk storage configuration was set | N | Admin
| REST API | rename node | 8207 | The node was renamed | N | Admin
| REST API | setup node services | 8208 | The services were set for the node | N | Admin
| REST API | change cluster settings | 8209 | Cluster settings were changed | N | Admin
| REST API | add group | 8210 | Server group was added | N | Admin
| REST API | delete group | 8211 | Server group was deleted | N | Admin
| REST API | update group| 8212 | Server group was updated | N | Admin
| REST API | xdcr create cluster ref | 8213 | Remote cluster reference was created | N | Admin
| REST API | xdcr update cluster ref | 8214 | Remote cluster reference was updated | N | Admin
| REST API | xdcr delete cluster ref | 8215 | Remote cluster reference was deleted | N | Admin
| REST API | xdcr create replication | 8216 | XDCR replication was created | N | Admin
| REST API | xdcr update replication | 8217 | XDCR replication was updated | N | Admin
| REST API | xdcr cancel replication | 8218 | XDCR replication was canceled | N | Admin
| REST API | xdcr update global settings | 8219 | Global XDCR settings were updated | N | Admin
| REST API | enable auto failover | 8220 | Auto Failover was enabled | N | Admin
| REST API | disable auto failover | 8221 | Auto Failover was disabled | N | Admin
| REST API | reset auto failover count | 8222 | Count for Auto Failover was reset | N | Admin
| REST API | enable cluster alerts | 8223 | Cluster alerts were enabled | N | Admin
| REST API | disable cluster alerts | 8224 | Cluster alerts were disabled | N | Admin
| REST API | modify compaction settings | 8225 | Compaction settings were modified | N | Admin
| REST API | regenerate certificate | 8226 | Self-signed SSL certificate was regenerated | N | Admin
| REST API | setup ldap | 8227 | LDAP Auth settings were modified | N | Admin
| REST API | internal settings | 8228 | Internal Settings | N | Admin
| REST API | upload cluster ca | 8229 | Upload cluster CA | N | Admin
| REST API | reload node certificate | 8230 | Reload node certificate chain and pkey from inbox | N | Admin
| REST API | modify index storage mode | 8231 | Modify Index Storage Mode | N | Admin
| REST API | set user | 8232 | User was added or updated | N | Admin
| REST API | master password change | 8233 | Master password change was requested | N | Admin
| REST API | encryption key rotation | 8234 | Encryption key rotation was requested | N | Admin
| REST API | password policy | 8235 | Password policy was changed | N | Admin
| REST API | client cert auth | 8236 | Client certificate authentication settings changed | N | Admin
| REST API | security settings | 8237 | Security Settings | N | Admin
| REST API | start log collection | 8238 | Log collection run was started | N | Admin
| REST API | modify log redaction settings | 8239 | Log redaction settings were modified | N | Admin
| REST API | configured audit daemon | 8240 | loaded configuration file for audit daemon | N | Admin
| REST API | modify index settings | 8241 | Index service settings were modified | N | Admin
| REST API | modify query settings | 8242 | Query service settings were modified | N | Admin
|===

[#data-service-event-list-table]
=== Data Service Events

The following events are generated by the Data Service, in response to attempts to access and modify data.

[cols="8,10,7,13,8,8"]
|===
| *Event Group* | *Event Name* | *ID* | *Description* | *Filter?* | *Event Type*
| Data Service | opened DCP connection | 20480 | opened DCP connection | N | Admin
| Data Service | authentication failed | 20481 | authentication failed | N | Admin
| Data Service | external memcached bucket flush | 20482 | External user flushed the content of a memcached bucket | N | Admin
| Data Service | invalid packet | 20483 | Rejected an invalid packet | N | Admin
| Data Service | command access failure | 20484 | Rejected access to a command | N | Admin
| Data Service | authentication succeeded | 20485 | Authentication to the cluster succeeded | N | Admin
| Data Service | privilege debug configured | 20486 | The state of the privilege debug mode changed | N | Admin
| Data Service | privilege debug | 20487 | Access to a resource was granted due to privilege debug | N | Admin
| Data Service | document read | 20488 | Document was read | Y | Data
| Data Service | document locked | 20489 | Document was locked | Y | Data
| Data Service | document modify | 20490 | Document was modified | Y | Data
| Data Service | document delete | 20491 | Document was deleted | Y | Data
|===

[#query-service-event-list-table]
=== Query Service Events

The following events are generated by the Query Service, in response to statement-executions and API access-attempts.

[cols="8,10,7,13,8,8"]
|===
| *Event Group* | *Event Name* | *ID* | *Description* | *Filter?* | *Event Type*
| Query Service | SELECT statement | 28672 | A N1QL SELECT statement was executed | Y | Data
| Query Service | EXPLAIN statement | 28673 | A N1QL EXPLAIN statement was executed | Y | Data
| Query Service | PREPARE statement | 28674 | A N1QL PREPARE statement was executed | Y | Data
| Query Service | INFER statement | 28675 | A N1QL INFER statement was executed | Y | Data
| Query Service | INSERT statement | 28676 | A N1QL INSERT statement was executed | Y | Data
| Query Service | UPSERT statement | 28677 | A N1QL UPSERT statement was executed | Y | Data
| Query Service | DELETE statement | 28678 | A N1QL DELETE statement was executed | Y | Data
| Query Service | UPDATE statement | 28679 | A N1QL UPDATE statement was executed | Y | Data
| Query Service | MERGE statement | 28680 | A N1QL MERGE statement was executed | Y | Data
| Query Service | CREATE INDEX statement | 28681 | A N1QL CREATE INDEX statement was executed | Y | Data
| Query Service | DROP INDEX statement | 28682 | A N1QL DROP INDEX statement was executed | Y | Data
| Query Service | ALTER INDEX statement | 28683 | A N1QL ALTER INDEX statement was executed | Y | Data
| Query Service | BUILD INDEX statement | 28684 | A N1QL BUILD INDEX statement was executed | Y | Data
| Query Service | GRANT ROLE statement | 28685 | A N1QL GRANT ROLE statement was executed | Y | Admin
| Query Service | REVOKE ROLE statement | 28686 | A N1QL REVOKE ROLE statement was executed | Y | Admin
| Query Service | UNRECOGNIZED statement | 28687 | An unrecognized statement was received by the N1QL query engine | Y | Admin
| Query Service | CREATE PRIMARY INDEX statement | 28688 | A N1QL CREATE PRIMARY INDEX statement was executed | Y | Data
| Query Service | /admin/stats API request | 28689 | An HTTP request was made to the API at /admin/stats | Y | Admin
| Query Service | /admin/vitals API request | 28690 | An HTTP request was made to the API at /admin/vitals | Y | Admin
| Query Service | /admin/prepareds API request | 28691 | An HTTP request was made to the API at /admin/prepareds | Y | Admin
| Query Service | /admin/active_requests API request | 28692 | An HTTP request was made to the API at /admin/active_requests | Y | Admin
| Query Service | /admin/indexes/prepareds API request | 28693 |An HTTP request was made to the API at /admin/indexes/prepareds | Y | Admin
| Query Service | /admin/indexes/active_requests API request | 28694 | An HTTP request was made to the API at /admin/indexes/active_requests | Y | Admin
| Query Service | /admin/indexes/completed_requests API request | 28695 | An HTTP request was made to the API at /admin/indexes/completed_requests | Y | Admin
| Query Service | /admin/ping API request | 28697 | An HTTP request was made to the API at /admin/ping | Y | Admin
| Query Service | /admin/config API request | 28698 | An HTTP request was made to the API at /admin/config | Y | Admin
| Query Service | /admin/ssl_cert API request | 28699 | An HTTP request was made to the API at /admin/ssl_cert | Y | Admin
| Query Service | /admin/settings API request | 28700 | An HTTP request was made to the API at /admin/settings | Y | Admin
| Query Service | /admin/clusters API request | 28701 | An HTTP request was made to the API at /admin/clusters | Y | Admin
| Query Service | /admin/completed_requests API request | 28702 | An HTTP request was made to the API at /admin/completed_requests | Y | Admin
| Query Service | N1QL configuration | 28703 | States that N1QL is using audit configuration with specified uuid | N | Admin
|===

[#search-service-event-list-table]
=== Search Service Events

The following events are generated by the Search Service, in response to index and configuration changes, garbage collection, and resource profiling.

[cols="8,10,7,13,8,8"]
|===
| *Event Group* | *Event Name* | *ID* | *Description* | *Filter?* | *Event Type*
| Search Service | Delete index | 24576 | FTS index was deleted | N | Data
| Search Service | Create/Update index | 24577 | FTS index was created/Updated | N | Data
| Search Service | Control index | 24579 | FTS index control command was issued | N | Data
| Search Service | Config refresh | 24580 | FTS config was refreshed | N | Admin
| Search Service | Config replan | 24581 | FTS config was replanned | N | Admin
| Search Service | GC run | 24582 | GC run was triggered | N | Admin
| Search Service | CPU profile | 24583 | CPU profiling was started | N | Admin
| Search Service | Memory profile | 24584 | Memory profiling was started | N | Admin
|===

[#eventing-service-event-list-table]
=== Eventing Service Events

The following events are generated by the Eventing Service, in response to the definition, deployment, and execution of functions; debugging activities; configuration changes; and the importing and exporting of functions.

[cols="8,10,7,13,8,8"]
|===
| *Event Group* | *Event Name* | *ID* | *Description* | *Filter?* | *Event Type*
| Eventing Service | Create Function | 32768 | Eventing function definition was created or updated | Y | Admin
| Eventing Service | Delete Function | 32769 | Eventing function definition was deleted | Y | Admin
| Eventing Service | Fetch Functions | 32770 | Eventing function definition was read | Y | Admin
| Eventing Service | List Deployed | 32771 | Eventing deployed functions list was read | Y | Admin
| Eventing Service | Fetch Drafts | 32772 | Eventing function draft definitions were read | Y | Admin
| Eventing Service | Delete Drafts | 32773 | Eventing function draft definitions were deleted | Y | Admin
| Eventing Service | Save Draft | 32774 | Save a draft definition to the store | Y | Admin
| Eventing Service | Start Debug | 32775 | Start eventing function debugger | Y | Admin
| Eventing Service | Stop Debug | 32776 |Stop eventing function debugger | Y | Admin
| Eventing Service | Start Tracing | 32777 | Start tracing eventing function execution | Y | Admin
| Eventing Service | Stop Tracing | 32778 | Stop tracing eventing function execution | Y | Admin
| Eventing Service | Set Settings | 32779 | Save settings for a given app | Y | Admin
| Eventing Service | Fetch Config | 32780 | Get config for eventing | Y | Admin
| Eventing Service | Save Config | 32781 | Save config for eventing | Y | Admin
| Eventing Service | Cleanup Eventing | 32782 | Clears up app definitions and settings from metakv | Y | Admin
| Eventing Service | Get Settings | 32783 | Get settings for a given app | Y | Admin
| Eventing Service | Import Functions | 32784 | Import a list of functions | Y | Admin
| Eventing Service | Export Functions | 32785 | Export the list of functions | Y | Admin
| Eventing Service | List Running | 32786 | Eventing running function list was read | Y | Admin
|===

=== Audit Events

The following events are generated by the audit daemon itself.

[cols="8,10,7,13,8,8"]
|===
| *Event Group* | *Event Name* | *ID* | *Description* | *Filter?* | *Event Type*
| Audit | configured audit daemon | 4096 | Loaded configuration file for audit daemon | N | Admin
| Audit | shutting down audit daemon | 4097 | The audit daemon is being shut down | N | Admin
|===
