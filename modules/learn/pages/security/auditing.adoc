= Auditing
:page-aliases: security:security-auditing

[abstract]
Couchbase Server provides event-auditing, sending corresponding output to target files.

[#introduction-to-auditing]
== Introduction to Auditing

The Couchbase Server _auditing_ facility recognizes specific _events_, which can be selectively logged.
The output is written to target files, each of which is periodically rotated.

Couchbase events allow administrators to track the following:

* Administrative and configuration changes to the cluster.
These are logged as _admin_ events.
See xref:learn:security/auditing.adoc#administrative-events[Administrative Events], below.

* Attempts to access and change data.
These are logged as _data_ events.
See xref:learn:security/auditing.adoc#data-events[Data Events], below.

This page also explains frequently used audit fields, and gives examples of the record-structures used within target files.

Note that event-auditing occurs on a _per node_ basis: each node captures its own events only.
If a cluster-wide record is needed, the individual per node records must be manually consolidated by the administrator.

For information on managing auditing, see xref:manage:manage-security/manage-auditing.adoc[Manage Auditing].

== Audit Fields

The table below contains some frequently used audit fields with corresponding descriptions.
Note that different event-types generate different field-subsets.

[cols="2,3,5"]
|===
| Field | Type | Description

| `type`
| string
| The audit-type.
For example, Login, Startup, Shutdown, Password, AuditStart, AuditStop, AuditTruncate.

| `timestamp`
| document
| Contains the date and UTC time of the event in ISO 8601 format.
For example, http://www.w3.org/TR/NOTE-datetime[^].

| `id`
| integer
| A unique identifier for the event-type.

| `local`
a|
document

[source,json]
----
{ip: <String>,
port: <int>},
----
| A JSON document that contains the local IP-address and the port-number of the running instance.

| `remote`
a|
document

[source,json]
----
{ip: <String>,
port: <int>},
----
| A JSON document that contains the remote IP-address, the port-number, and additional information on the service used on the incoming connection associated with the event.

Possible services include `cbmcd`, `cbhttp`, `cbmgmt`, `cbxdcr`, `cbn1ql`, and `cbsyncgw`.

| `user`
| string
| A string that identifies the user.

| `params`
| document
| Information dependent on the event-type.
For example, for a bucket-operation, the bucket name is captured.

| `result`
| integer or string
| An error-code or other message, related to the attempted operation.
|===

== Audit Target-Files

When auditing is enabled, logged events are written to a default file, named `audit.log`.
After an administrator-specified period — which must be a minimum of 15 minutes and a maximum of 7 days — this file is closed, and is saved under a modified name that features a timestamp corresponding to the time of saving.
A new, empty `audit.log` file is created and saved when a new audit event is generated.
Note that this _rotation_ may happen earlier if the file reaches its maximum size of 20MB.
For instructions on configuring the file's _rotation time_, see xref:manage:manage-security/manage-auditing.adoc[Manage Auditing].

=== Login

An audit-record for a successful login might appear as follows:

[source,json]
----
{
  "timestamp":"2015-02-20T08:48:49.408-08:00",
  "id":8192,
  "name":"login success",
  "description":"Successful login to couchbase cluster",
  "role":"admin",
  "real_userid": {
    "source":"ns_server",
    "user":"bjones"
  },
 "sessionid":"0fd0b5305d1561ca2b10f9d795819b2e",
 "remote":{
  "ip":"172.23.107.165", "port":59383
  }
}
----

In this example, a user named `bjones` has successfully logged into a Couchbase cluster using the domain IP address `172.23.107.165.`

==== Login Failure

The following audit-record indicates that a login attempt failed:

[source,json]
----
{
  "real_userid": {
    "source": "rejected",
    "user": "auditBucketUser"
  },
  "remote": {
    "ip": "127.0.0.1",
    "port": 64416
  },
  "timestamp": "2017-03-16T15:45:27.420Z",
    "id": 8193,
    "name": "login failure",
    "description": "Unsuccessful attempt to login to couchbase cluster"
}
----

This record indicates that a user named `auditBucketUser` incurred an `Unsuccessful attempt to login to couchbase cluster` on `2017-03-16` at `15:45:27`.

=== Bucket Creation

The audit-record below corresponds to the creation of a bucket.

[source,json]
----
{
  "props":{
    "compression_mode":"off",
    "max_ttl":12000,
    "storage_mode":"couchstore",
    "conflict_resolution_type":"seqno",
    "eviction_policy":"value_only",
    "num_threads":3,
    "flush_enabled":false,
    "purge_interval":"undefined",
    "ram_quota":163577856,
    "replica_index":false,
    "num_replicas":1
  },
  "type":"membase",
  "bucket_name":"ProductionBucket",
  "real_userid":{
    "source":"ns_server",
    "user":"Administrator"
  },
  "sessionid":"5dd53fe63703c7fdc45ff75596e39a35",
  "remote":{
    "ip":"127.0.0.1",
    "port":61908
  },
  "timestamp":"2018-02-07T15:22:54.960Z",
  "id":8201,
  "name":"create bucket",
  "description":"Bucket was created"
}
----

This record indicates that a `Bucket was created` on `2018-02-07` at `15:22:54`; that the bucket was named `ProductionBucket`; and that its eviction-policy was defined as `value_only`.
The bucket was created by the system's `Full Administrator`.

=== Bucket TTL Modification

The audit-record below corresponds to the modification of Bucket TTL, for the bucket created immediately above.

[source,json]
----
{
  "props":{
    "max_ttl":15000,
    "storage_mode":"couchstore",
    "eviction_policy":"value_only",
    "num_threads":3,
    "flush_enabled":false,
    "purge_interval":"undefined",
    "ram_quota":163577856,
    "num_replicas":1
  },
  "type":"membase",
  "bucket_name":"ProductionBucket",
  "real_userid":{
    "source":"ns_server",
    "user":"Administrator"
  },
  "sessionid":"12774a2e146c650eeed8c6d9486857ad",
  "remote":{
      "ip":"127.0.0.1","port":61966
  },
  "timestamp":"2018-02-07T15:23:51.350Z",
  "id":8202,
  "name":"modify bucket",
  "description":"Bucket was modified"
}
----

=== User Creation

The audit-record below corresponds to the creation of a user.

[source,json]
----
{
  "roles": [
    "ro_admin"
  ],
  "identity": {
    "source": "builtin",
    "user": "auditBucketUser2"
  },
  "real_userid": {
    "source": "ns_server",
    "user": "Administrator"
  },
  "sessionid": "dca284b5efe1937a1a4085ef88c2fbcb",
  "remote": {
    "ip": "127.0.0.1",
    "port": 64416
  },
  "timestamp": "2017-03-16T15:44:32.254Z",
  "id": 8232,
  "name": "set user",
  "description": "User was added or updated"
}
----

This record indicates that a user named `auditBucketUser2` was created by the `Full Administator` on `2017-03-16` at `15:44:32`; and that the user was given the role of `ro_admin`.

=== Index Creation

The following audit-record indicates that an index was created or updated:

[source,json]
----
{
  "timestamp": "2017-03-16T16:12:36.198Z",
  "real_userid": {
    "source": "ns_server",
    "user": "Administrator"
  },
  "index_name": "def-airportname",
  "id": 24577,
  "name": "Create/Update index",
  "description": "FTS index was created/Updated"
}
----

This record indicates that an `FTS` index named `def-airportname` was created or updated on `201703-16` at `16:12:36`.

[#administrative-events]
== Event-List Tables

The events listed in the following tables support the auditing of administrative and configuration changes made to the cluster.
Each table corresponds to one of the event-groups whereby events are listed in Couchbase Web Console; in the *Events* panel, accessed under the *Auditing* tab of the Couchbase Web Console *Security* screen.
See xref:manage:manage-security/manage-auditing.adoc[Manage Auditing], for details.

In each table, the first column (at the left) features the event-name; the second the event-description; the third the event-group heading (thereby repeating the table's title, so as to ensure readability throughout the longer tables); and the fourth, the event _type_ &#8212; whether the event describes a change to _administrative status_ or to _data_.

The tables &#8212; which are for the xref:learn:security/auditing.adoc#rest-api-event-list-table[REST API], the xref:learn:security/auditing.adoc#data-service-event-list-table[Data Service], the xref:learn:security/auditing.adoc#query-service-event-list-table[Query Service], the xref:learn:security/auditing.adoc#eventing-service-event-list-table[Eventing Service], he xref:learn:security/auditing.adoc#analytics-service-event-list-table[Analytics Service], xref:learn:security/auditing.adoc#views-event-list-table[Views], and xref:learn:security/auditing.adoc#audit-event-list-table[Audit] &#8212; are as follows.

[#rest-api-event-list-table]
=== REST API Events

[cols="4,6,9,3"]
|===
| *Group* | *Name* | *Description* | *Type*
| REST API | mutate document | Document was mutated via the REST API | Admin
| REST API | read document | Document was read via the REST API |  Admin
| REST API | alert email sent | An alert email was successfully sent | Admin
| REST API | login success | Successful login to cluster | Admin
| REST API | login failure | Unsuccessful attempt to login to cluster | Admin
| REST API | delete user | User was deleted | Admin
| REST API | user credentials change | User credentials were changed | Admin
| REST API | add node | Node was added to the cluster | Admin
| REST API | remove node | Node was removed from the cluster | Admin
| REST API | enter node recovery | Entered node recovery | Admin
| REST API | rebalance initiated | Rebalance was initiated | Admin
| REST API | create bucket | Bucket was created | Admin
| REST API | modify bucket | Bucket was modified | Admin
| REST API | delete bucket | Bucket was deleted | Admin
| REST API | flush bucket | Bucket was flushed | Admin
| REST API | start loading sample | Started loading sample | Admin
| REST API | disk storage conf | Disk storage configuration was set | Admin
| REST API | rename node | The node was renamed | Admin
| REST API | setup node services | The services were set for the node | Admin
| REST API | change cluster settings | Cluster settings were changed | Admin
| REST API | add group |Server group was added | Admin
| REST API | delete group | Server group was deleted | Admin
| REST API | update group| Server group was updated | Admin
| REST API | xdcr create cluster ref | Remote cluster reference was created | Admin
| REST API | xdcr update cluster ref | Remote cluster reference was updated | Admin
| REST API | xdcr delete cluster ref | Remote cluster reference was deleted | Admin
| REST API | xdcr create replication | XDCR replication was created | Admin
| REST API | xdcr update replication | XDCR replication was updated | Admin
| REST API | xdcr cancel replication | XDCR replication was canceled | Admin
| REST API | xdcr update global settings | Global XDCR settings were updated | Admin
| REST API | enable auto failover |Auto Failover was enabled | Admin
| REST API | disable auto failover | Auto Failover was disabled | Admin
| REST API | reset auto failover count | Count for Auto Failover was reset | Admin
| REST API | enable cluster alerts | Cluster alerts were enabled | Admin
| REST API | disable cluster alerts | Cluster alerts were disabled | Admin
| REST API | modify compaction settings | Compaction settings were modified | Admin
| REST API | regenerate certificate | Self-signed SSL certificate was regenerated | Admin
| REST API | setup saslauthd | Saslauthd settings were modified | Admin
| REST API | internal settings | Internal Settings | Admin
| REST API | upload cluster ca | Upload cluster CA | Admin
| REST API | reload node certificate | Reload node certificate chain and pkey from inbox | Admin
| REST API | modify index storage mode | Modify Index Storage Mode | Admin
| REST API | set user | User was added or updated | Admin
| REST API | master password change | Master password change was requested | Admin
| REST API | encryption key rotation | Encryption key rotation was requested | Admin
| REST API | password policy | Password policy was changed | Admin
| REST API | client cert auth | Client certificate authentication settings changed | Admin
| REST API | security settings | Security Settings | Admin
| REST API | start log collection | Log collection run was started | Admin
| REST API | modify log redaction settings | Log redaction settings were modified | Admin
| REST API | configured audit daemon | loaded configuration file for audit daemon | Admin
| REST API | modify index settings | Index service settings were modified | Admin
| REST API | modify query settings | Query service settings were modified | Admin
| REST API | set user group | User group was added or updated | Admin
| REST API | delete user group | User group was deleted | Admin
| REST API | modify ldap settings | Ldap settings were modified | Admin
| REST API | developer preview settings | Developer preview settings | Admin
| REST API | license settings | License Settings | Admin
| REST API | set user profile | UI profile was added or updated | Admin
| REST API | delete user profile| UI profile was deleted | Admin
| REST API | modify retry rebalance | Retry rebalance settings were modified | Admin
| REST API | enable auto reprovision | Auto reprovision was enabled | Admin
| REST API | disable auto reprovision | Auto reprovision was disabled | Admin
| REST API | failover settings | Failover settings | Admin
| REST API | logout success | Successful logout of couchbase cluster | Admin
|===

[#data-service-event-list-table]
=== Data Service Events

[cols="2,3,1,1"]
|===
| *Name* | *Description* | *Group* | *Type*
| opened DCP connection | opened DCP connection | Data Service | Admin
| external memcached bucket flush | External user flushed the content of a memcached bucket | Data Service | Admin
| invalid packet | Rejected an invalid packet | Data Service | Admin
| authentication succeeded | Authentication to the cluster succeeded | Data Service | Admin
| document read | Document was read | Data Service | Data
| document locked | Document was locked | Data Service | Data
| document modify | Document was modified | Data Service | Data
| document delete | Document was deleted | Data Service | Data
| select bucket | The specified bucket was selected | Data Service | Admin
| authentication failed | Authentication to the cluster failed | Data Service | Admin
| command access failure | Access to command is not allowed | Data Service | Admin
| privilege debug configured | The state of the privilege debug mode changed | Data Service | Admin
| privilege debug | Access to a resource was granted due to privilege debug | Data Service | Admin
|===

[#query-service-event-list-table]
=== Query Service Events

[cols="2,3,1,1"]
|===
| *Name* | *Description* | *Group* | *Type*
| SELECT statement | A N1QL SELECT statement was executed | Query Service | Data
| EXPLAIN statement | A N1QL EXPLAIN statement was executed | Query Service | Data
| PREPARE statement | A N1QL PREPARE statement was executed | Query Service | Data
| INFER statement | A N1QL INFER statement was executed | Query Service | Data
| INSERT statement | A N1QL INSERT statement was executed | Query Service | Data
| UPSERT statement | A N1QL UPSERT statement was executed | Query Service | Data
| DELETE statement | A N1QL DELETE statement was executed | Query Service | Data
| UPDATE statement | A N1QL UPDATE statement was executed | Query Service | Data
| MERGE statement | A N1QL MERGE statement was executed | Query Service | Data
| CREATE INDEX statement | A N1QL CREATE INDEX statement was executed | Query Service | Data
| DROP INDEX statement | A N1QL DROP INDEX statement was executed | Query Service | Data
| ALTER INDEX statement | A N1QL ALTER INDEX statement was executed | Query Service | Data
| BUILD INDEX statement | A N1QL BUILD INDEX statement was executed | Query Service | Data
| GRANT ROLE statement | A N1QL GRANT ROLE statement was executed | Query Service | Admin
| REVOKE ROLE statement | A N1QL REVOKE ROLE statement was executed | Query Service | Admin
| UNRECOGNIZED statement | An unrecognized statement was received by the N1QL query engine | Query Service | Admin
| CREATE PRIMARY INDEX statement | A N1QL CREATE PRIMARY INDEX statement was executed | Query Service | Data
| /admin/stats API request | An HTTP request was made to the API at /admin/stats | Query Service | Admin
| /admin/vitals API request | An HTTP request was made to the API at /admin/vitals | Query Service | Admin
| /admin/prepareds API request | An HTTP request was made to the API at /admin/prepareds | Query Service | Admin
| /admin/active_requests API request | An HTTP request was made to the API at /admin/active_requests | Query Service | Admin
| /admin/indexes/prepareds API request | An HTTP request was made to the API at /admin/indexes/prepareds | Query Service | Admin
| /admin/indexes/active_requests API request | An HTTP request was made to the API at /admin/indexes/active_requests | Query Service | Admin
| /admin/indexes/completed_requests API request | An HTTP request was made to the API at /admin/indexes/completed_requests | Query Service | Admin
| /admin/ping API request | An HTTP request was made to the API at /admin/ping | Query Service | Admin
| /admin/config API request | An HTTP request was made to the API at /admin/config | Query Service | Admin
| /admin/ssl_cert API request | An HTTP request was made to the API at /admin/ssl_cert | Query Service | Admin
| /admin/settings API request | An HTTP request was made to the API at /admin/settings | Query Service | Admin
| /admin/clusters API request | An HTTP request was made to the API at /admin/clusters | Query Service | Admin
| /admin/completed_requests API request | An HTTP request was made to the API at /admin/completed_requests | Query Service | Admin
| /admin/functions API request | An HTTP request was made to the API at /admin/functions | Query Service | Admin
| /admin/indexes/functions API request | An HTTP request was made to the API at /admin/indexes/functions | Query Service | Admin
| N1QL configuration | States that N1QL is using audit configuration with specified uuid | Query Service | Admin
|===

[#eventing-service-event-list-table]
=== Eventing Service Events

[cols="7,10,4,3"]
|===
| *Name* | *Description* | *Group* | *Type*
| Create Function | Eventing function definition was created or updated | Eventing Service | Admin
| Delete Function | Eventing function definition was deleted | Eventing Service | Admin
| Fetch Functions | Eventing function definition was read | Eventing Service | Admin
| List Deployed | Eventing deployed functions list was read | Eventing Service | Admin
| Fetch Drafts | Eventing function draft definitions were read | Eventing Service | Admin
| Delete Drafts | Eventing function draft definitions were deleted | Eventing Service | Admin
| Save Draft | Save a draft definition to the store | Eventing Service | Admin
| Start Debug | Start eventing function debugger | Eventing Service | Admin
| Stop Debug | Stop eventing function debugger | Eventing Service | Admin
| Start Tracing | Start tracing eventing function execution | Eventing Service | Admin
| Stop Tracing | Stop tracing eventing function execution | Eventing Service | Admin
| Set Settings | Save settings for a given app | Eventing Service | Admin
| Fetch Config | Get config for eventing | Eventing Service | Admin
| Save Config | Save config for eventing | Eventing Service | Admin
| Cleanup Eventing | Clears up app definitions and settings from metakv | Eventing Service | Admin
| Get Settings | Get settings for a given app | Eventing Service | Admin
| Import Functions | Import a list of functions | Eventing Service | Admin
| Export Functions | Export the list of functions | Eventing Service | Admin
| List Running | Eventing running function list was read | Eventing Service | Admin
|===

[#analytics-service-event-list-table]
=== Analytics Service Events

[cols="7,10,4,3"]
|===
| *Name* | *Description* | *Group* | *Type*
| Service configuration change | A successful service configuration change was made | Analytics Service | Admin
| Node configuration change | A successful node configuration change was made | Analytics Service | Admin
|===

[#views-event-list-table]
=== Views Events

[cols="7,10,3,3"]
|===
| *Name* | *Description* | *Group* | *Type*
| Create Design Doc | Design Doc is Created | Views | Data
| Delete Design Doc | Design Doc is Deleted | Views | Data
| Query DDoc Meta Data |Design Doc Meta Data Query Request | Views | Data
| View Query | View Query Request | Views | Data
| Update Design Doc | Design Doc is Updated | Views | Data
| Audit Configuration Change | Change in Audit Configuration | Views | Data
|===

[#audit-event-list-table]
=== Audit Events
[cols="7,10,3,3"]
|===
| *Name* | *Description* | *Group* | *Type*
| configured audit daemon | Loaded configuration file for audit daemon | Audit | Admin
| shutting down audit daemon | The audit daemon is being shut down | Audit | Admin
|===
