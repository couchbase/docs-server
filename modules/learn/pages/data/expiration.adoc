= Expiration
:page-edition: Enterprise Edition
:description: pass:q[The expiration setting for a document determines if and when it expires. When a document expires, Couchbase Server removes it. You can set a _Maximum Time To Live_ (maxTTL) value on buckets and collections that sets the maximum expiration value for documents they contain.]

:page-aliases: understanding-couchbase:buckets-memory-and-storage/expiration, learn:buckets-memory-and-storage/expiration

[abstract]
{description}

[#bucket-data-expiration-overview]
== Overview

You may want Couchbase Server to automatically remove some documents after a period of time. 
For example, you often want documents that contain user session data to expire sometime after the user's last interaction. 
Or you may use documents to store cached data. 

Couchbase Server Enterprise Edition lets you have documents expire after a period of time. This feature only works in Couchbase and Ephermeral buckets. It does not 

You can have these documents automatically expire so your application knows to refresh the data from its source. 

You can set an expiration value on an individual document either when you create it or when you mutate it. 
Set the expiration to the number of seconds the document should exist before Couchbase Server automatically removes it. 
You can change this value later in case you want extend the life of the document. 

You can also configure buckets and collections to automatically apply a default expiration 
on the documents they contain. 
The `maxTTL` parameter on collections and buckets sets the number of seconds a mutated document should last before expiring. 
By default, `maxTTL` is 0 for both buckets and collections, meaning that their documents do not automatically expire.
The `maxTTL` setting also imposes an upper limit on the expiration time you can explicitly set on an individual document in the bucket or collection. 
If you try to set a document's expiration to a period longer than the non-zero `maxTTL` setting, Couchbase Server sets the expiration to `maxTTL`.  

The `maxTTL` setting is not available for scopes. 

== Expiration Setting Priorities

In general, non-zero expiration set at a lower level take precedence over settings at a higher level--non-zero expiration times set at a document level override a collection's non-zero `maxTTL` settings, which in turn override `maxTTL`settings at the bucket level. 
The three exceptions to this rule are:

* As mentioned earlier, you cannot set a document's expiration to be longer than a non-zero `maxTTL` setting of the document's collection or bucket.
If you try to set the document's expiration to be longer than its collection or bucket's `maxTTL` setting, Couchbase Server uses the `maxTTL` setting instead. 

* Setting a collection's `maxTTL` to zero does not override the bucket's `maxTTL` setting. Instead, setting the collection's `maxTTL` to zero has it inherit the `maxTTL` setting from the bucket. 

* Setting a document's expiration to 0 does not prevent it from expiring if its collection or bucket has a `maxTTL` setting that's greater than zero. 
This behavior means you cannot prevent a document from expiring if its collection or bucket has a `maxTTL` setting that's greater than zero. 

The following table summarizes the interaction between a document's expiration setting and the `maxTTL` settings of the collection and bucket that contain it.

[cols="1,1,1,1"]
|===
| Document Expiration Setting | Collection `maxTTL` | Bucket `maxTTL` | Effect

| Null, unset, or 0
| Null, unset, or 0
| Null, unset, or 0
| Document does not expire.

| Null, unset, or 0
| Null, unset, or 0
| `maxTTL = z` (where `z` > 0)
| Document expires in `z` seconds.

| Null, unset, or 0
| `maxTTL = y` (where `y` > 0) 
| `maxTTL` = any value
| Document expires in `y` seconds

| `expiration = x` (where `x` > 0)
| `maxTTL` = null, unset, 0, or any value > `x`
| `maxTTL` = null, unset, 0, or any value > `x`
| Document expires in `x` seconds

| `expiration = x` (where `x` > 0)
| `maxTTL = y` (where 0 < `y` < `x`) 
| `maxTTL` = any value
| Document expires in `y` seconds

| `expiration = x` (where `x` > 0)
| Null, unset, or 0 
| `maxTTL = z` (where 0 < `z` < `x`) 
| Document expires in `z` seconds 

|===

== When maxTTL Changes Take Effect

When you change the `maxTTL` setting of either a bucket or collection, the change does not have an immediate effect on the documents they contain. 
The `maxTTL` setting of a bucket or collection only has an effect when you create or mutate a document. 
Any existing expiration set on a document do not change, even if their duration is longer than the `maxTTL` setting.
Also, documents that are not set to expire do not automatically start expiring after you have set a non-zero `maxTTL` setting on their collection or bucket.
To have the existing documents start expiring, you must you must mutate them.
When you mutate a document, Couchbase Server applies any `maxTTL` settings to the document.  


For more details about expiration and the `maxTTL` setting, see xref:manage:manage-expiration.adoc[].


[#post-expiration-purging]
== Post-Expiration Purging

When a document's expiration time elapses, Couchbase Server deletes it when one the following occurs:

* A query attempts to access it.
* The xref:learn:buckets-memory-and-storage/memory.adoc#expiry-pager[expiry pager] process runs.
* The xref:manage:manage-settings/configure-compact-settings.adoc[auto-compaction] process runs.
For information on performing compaction with the Couchbase CLI, see xref:cli:cbcli/couchbase-cli-bucket-compact.adoc[bucket-compact]; with Couchbase REST APIs, see xref:rest-api:compaction-rest-api.adoc[Compaction API]; with the Couchbase Web Console (as _auto-compaction_), see
xref:manage:manage-settings/configure-compact-settings.adoc[Auto-Compaction].

As described in xref:buckets-memory-and-storage/storage.adoc[Storage], Couchbase Server maintains a _tombstone_ for a period of time afterwards for each collection or item that it deletes. 
The tombstone acts as a marker to indicate the item no longer exists. 
To make sure that no trace of deleted items remain, Couchbase Server removes tombstones during a _Metadata Purge_.
This purge is an automatic, non-disruptive background-process. 
You can change the schedule of metadata purges using Couchbase Server Web Console.
See xref:manage:manage-settings/configure-compact-settings.adoc[Auto-Compaction].
The console lets you set the intervals between purges to be short so that COuchbase Server removes tombstones promptly.

[#bucket-expiration-and-xdcr]
== Expiration and XDCR

Cross data center replication does not replicate the bucket or collection `maxTTL` setting from the source to the target.
However, individual document's expirations (including expirations set by containing bucket or collection's `maxTTL` setting) are replicated to the target. 
Buckets and collections on the target cluster can have their own `maxTTL` settings, which can differ from those of the buckets and collections in the source.
If the target collection or bucket have a non-zero `maxTTL` setting, it affects the expiration of the replicated document the same way the source's `maxTTL` setting effects the source document:

* If the replciated document's expiration is not set or set to 0, Couchbase Server sets the document's expiration to the `maxTTL` of the collection or bucket. 
* If the document's expiration is greater than the target collection or bucket's non-zero `maxTTL` setting, Couchbase Server sets the document's expiration to the target's `maxTTL`.
* If the document's expiration is less than the target collection or bucket's non-zero `maxTTL` setting, Couchbase Server keeps the replicated document's expiration.


Note that in cases where the TTL of the replicated item is above that of the bucket's or the collection's TTL or is 0, if bi-directional XDCR has been set up, the TTL of the item at the source is eventually also either reduced or reset to the value of the target's bucket or collection TTL.

Note also that when an item is replicated by XDCR, its expiration time is communicated to the target as absolute.
This requires that the system clocks of the respective clusters be fully synchronized; otherwise, inconsistent behavior may result (as, for example, in the case where an item arrives at the target-cluster with an absolute expiration time that is earlier than the current time acknowledged by the target-cluster).
See xref:install:synchronize-clocks-using-ntp.adoc[Clock Sync with NTP].

Note that optionally, TTL can be _omitted_ from a document replicated by means of XDCR.
For details, see xref:manage:manage-xdcr/filter-xdcr-replication.adoc#deletion-filters[Deletion Filters].

[#setting-bucket-data-expiration]
== Setting Expiration on Buckets and Collections

An expiration time can be set for a bucket by means of any of the following:

* The UI provided by Couchbase Web Console.
See xref:manage:manage-buckets/create-bucket.adoc[Create a Bucket].

* The Couchbase CLI.
See xref:cli:cbcli/couchbase-cli-bucket-create.adoc[bucket-create].

* The Couchbase REST API.
See xref:rest-api:rest-bucket-create.adoc[Creating and Editing Buckets].

An expiration time can be set for a collection by means of:

* The UI provided by Couchbase Web Console.
See xref:manage:manage-scopes-and-collections/manage-scopes-and-collections.adoc#manage-scopes-and-collections-with-the-ui[Manage Scopes and Collections with the UI].

* The Couchbase CLI.
See xref:cli:cbcli/couchbase-cli-collection-manage.adoc[collection-manage].

* The REST API.
See xref:rest-api:creating-a-collection.adoc[Creating a Collection].

For information on roles that allow modification of bucket and collection settings, see
xref:learn:security/roles.adoc[Roles].

[#auditing]
== Auditing

If _auditing_ is switched on, changes to each bucket's expiration time are recorded, and can be subsequently viewed.
See xref:learn:security/auditing.adoc[Auditing].
