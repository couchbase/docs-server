= Change History
:description: pass:q[When Magma storage is used for a bucket, the changes made to documents within the bucket's collections can be recorded, in a _change history_.]

[abstract]
{description}

[#understanding-change-history]
== Understanding Change History

When xref:learn:buckets-memory-and-storage/storage-engines.adoc#storage-engine-magma[Magma] storage is used for a bucket, the changes made to documents within the bucket's collections can be recorded, in a _change history_.
The change history resides on disk.
Its capacity is administrator-specified.
When the change history is full, old records are automatically removed (by means of compaction), to allow space for new records.

Change history can be either _on_ or _off_.
This is determined at bucket-level: if the change history is _on_, it is active for _all collections_ in the bucket.

For a bucket's change history to be switched _on_, the capacity of the change history must be established, as a positive integer corresponding either to _bytes_ or _seconds_.
If no capacity is specified, no change history is generated.
Optionally, positive integers can be specified for _both_ bytes and seconds: in such cases, record-removal occurs as soon as either capacity is reached.

Note that the change history is created _per bucket_, and is replicated in accordance with the number of intra-cluster replicas defined for the bucket.
Therefore, if two replicas are configured, and the specified maximum size is 1,000,000 bytes, the total size used for the change history across the cluster becomes 3,000,000 bytes.

If the change history for a bucket is switched _on_, the recording of changes can be performed in either of two ways, which are:

* _Deduplication off_.
No deduplication is performed by the Data Service; meaning that all writes to documents in the collection are recorded.

* _Deduplication on_.
Deduplication _may_ be performed by the Data Service; meaning that only a subset of writes to documents in the collection may be recorded.

Deduplication can be manually configured at collection-level; either when the collection is created; or subsequently, when the collection's existing setting is modified.
The default setting for all collections is controlled at bucket-level.

== Change-History Management

The following interfaces are provided for configuring change history.

[#change-history-enablement]
=== Change-History Enablement and Capacity Settings

The recording of change history is enabled at bucket level.
By default, it is _disabled_.
It can be enabled at bucket-creation, and can subsequently be disabled and enabled by changing the existing bucket's configuration.

Enablement occurs by defining a capacity for the on-disk change history.
This can be specified with a positive integer, corresponding either to _bytes_ or to _seconds_.
Optionally, positive integers can be specified for both bytes and seconds.
If, as the change history's size increases, either capacity is reached, records are removed from the change history (by means of compaction), to make room for new records.

If the default value of zero is retained in both cases, the recording of change history is disabled.

Change history can be enabled with either:

* The REST API, using `POST /pools/default/buckets` (to create a bucket) or `POST /pools/default/buckets/<bucketName>` (to edit); specifying one or both of the parameters `historyRetentionBytes` and `historyRetentionSeconds`.
See xref:rest-api:rest-bucket-create.adoc[Creating and Editing Buckets].

* The CLI, using `couchbase-cli bucket-create` (to create a bucket) or `couchbase-cli bucket-edit` (to edit a bucket); specifying one or both of the parameters `history-retention-bytes` and `history-retention-seconds`.
See xref:cli:cbcli/couchbase-cli-bucket-create.adoc[bucket-create] and xref:cli:cbcli/couchbase-cli-bucket-edit.adoc[bucket-edit].

[#deduplication-bucket-wide]
=== Deduplication Bucket-Wide Default Settings

A change history can be created with _deduplication_ either _off_ or _on_.
If deduplication is _off_, the change history is more complete.
If deduplication is _on_, the change history is more compact.

The setting for deduplication can be made at collection-level.
However, the default for all collections within a bucket can be established when a bucket is either created or edited.
By default, this setting has a value of `true`, which means that deduplication is _off_ for every collection; unless the setting is overridden in the creating or editing of the individual collection.

The bucket-wide default deduplication setting can be established with either:

* The REST API, using `POST /pools/default/buckets` (to create a bucket) or `POST /pools/default/buckets/<bucketName>` (to edit); specifying the parameter `historyRetentionCollectionDefault`.
See xref:rest-api:rest-bucket-create.adoc[Creating and Editing Buckets].

* The CLI, using `couchbase-cli bucket-create` (to create a bucket) or `couchbase-cli bucket-edit` (to edit a bucket); specifying the parameter `enable-history-retention-by-default`.
See xref:cli:cbcli/couchbase-cli-bucket-create.adoc[bucket-create] and xref:cli:cbcli/couchbase-cli-bucket-edit.adoc[bucket-edit].

=== Deduplication Collection-Specific Settings

A change history can be made with deduplication either _off_ or _on_.
A default setting that applies to all collections can be established at bucket level; as described in xref:learn:data/change-history.adoc##deduplication-bucket-wide[Deduplication Bucket-Wide Default Settings], above.

However, deduplication can also be switched off or on for each individual collection, overriding the established, bucket-wide default.
This setting can be made either when the collection is created, or subsequently, by editing the collection's configuration.

The setting can be established with either:

* The REST API, using `POST /pools/default/buckets/<bucket_name>/scopes/<scope_name>/collections` (to create a collection) or `PATCH /pools/default/buckets/<bucket_name>/scopes/<scope_name>/collections/<collection_name>` (to edit); specifying the parameter `history`.
See xref:rest-api:creating-a-collection.adoc[Creating and Editing a Collection].

* The CLI, using `couchbase-cli collection-manage` (to create or edit a collection); specifying the parameter `enable-history-retention`.
See xref:cli:cbcli/couchbase-cli-collection-manage.adoc[collection-manage].

=== Change-History Status and Content-Access

The deduplication status of each collection can be returned by means of the `cbstats` tool, with the arguments `collections` and `collection-details`.
Output indicates a status of `true` (deduplication is _off_) or `false` (deduplication is _on_).
See the xref:cli:cbstats/cbstats-collections.adoc[collections] and xref:cli:cbstats/cbstats-collections-details.adoc[collections-details] reference pages for xref:cli:cbstats/cbstats-intro.adoc[cbstats].

To access the change history and examine its contents, use the xref:4.1@kafka-connector::index.adoc[Kafka 4.1 Connector].

=== Change-History Statistics

Statistics are provided to allow change history to be monitored and managed.

==== Statistics Provided by cbstats

The `cbstats` tool, using the `all` argument, returns statistics that include the following:

* `ep_total_enqueued` and `ep_total_deduplicated`.
These respectively provide the total number of checkpointed items, and the number of items discarded due to deduplication.
The numbers correspond to items for the entire bucket, and include both active and replica vBuckets.
+
If deduplication is switched off, `ep_total_enqueued` represents all checkpointed items.
In such a case, if the bucket has one replica, and the value of `ep_total_enqueued` is _n_, the number of writes enqueued to the change history is  _n/2_.
+
If deduplication is switched _on_, the statistic `ep_total_deduplicated` represents the number of items recently removed from checkpoints for the whole bucket, through deduplication.
+
By inspecting system performance (in terms of CPU, memory, disk, and measured latency) when deduplication is respectively on and off, insight can be gained into how optimisations can be achieved.
Note that generally speaking, deduplication results in a greater use of CPU, memory, and disk; due to the key-handling requirement for deduplicated items.

* `ep_total_deduplicated_flusher`.
When items are to be _flushed_ (persisted), the contents of multiple checkpoints are batched, so that all can be flushed.
If deduplication is switched _on_, the checkpoints may already have had items removed through deduplication.
However, a further check is made across checkpoints, prior to writes being persisted, to find and remove duplicate items.
The total number of items recently removed from the flusher in this way is represented by `ep_total_deduplicated_flusher`.

* `history_start_seqno`.
The smallest document _seqno_ that is part of the history retention.
This seqno is the starting point of the history window.
Hence, all documents having seqno higher will be retained.
As more and more data is removed from the window, this seqno will be incremented, to correspond to a later document.

* `history_disk_size`.
On-disk compressed size (after Magma’s block compression and per document compression) of the fragmented and unfragmented data that lies within the history window, expressed _per vBucket_.

For more information, see the reference page for `cbstats` xref:cli:cbstats/cbstats-all.adoc[all].

Note that the use of a tool such as _Grafana_ with some of these statistics -- so as to describe a continuum of readings over time -- may produce more insight than the inspection of a individual figure.

==== Statistics Provided for REST and Prometheus

Metrics are provided for retrieval by either the REST API or Prometheus.
See xref:rest-api:rest-statistics.adoc[Statistics] for information on statistics-retrieval, and the xref:metrics-reference:metrics-reference.adoc[Metrics Reference] for a complete list of available statistics.

In the following descriptions, the _history window_ refers to the time or space specified by the administrator for the change history (by means of, say, the parameters `historyRetentionBytes` and `historyRetentionSeconds`, used with the REST API).

* `kv_total_enqueued`, `kv_total_deduplicated`, and `kv_total_deduplicated_flusher`.
These have the same significance their equivalents, provided by `cbstats`; described immediately above.

* `ep_magma_history_time_evicted`.
The total amount of data (in bytes) so far removed from the change history, due to the limit established with `historyRetentionSeconds` (REST API) or `history-retention-seconds` (CLI).

* `ep_magma_history_size_evicted`.
The total amount of data (in bytes) so far removed from the change history, due to the limit established with `historyRetentionBytes` (REST API) or `history-retention-bytes` (CLI).

* `ep_db_history_file_size`.
On-disk compressed size (after Magma’s block compression and per document compression) of the fragmented and unfragmented data that lies within the history window.

* `vb_max_history_disk_size`.
Maximum amount of history retained across all vBuckets.
The size here is _on-disk compressed_.

* `ep_magma_history_logical_disk_size`.
Size of fragmented and unfragmented data (after per document compression) that lies within the history window.
This, along with `ep_magma_history_logical_data_size`, can be used to compute fragmentation in history.

* `ep_magma_history_logical_data_size`.
Size of unfragmented data (after per document compression) that lies within the history window.
This, along with `ep_magma_history_logical_disk_size`, can be used to compute fragmentation in history.

== See Also

For information on establishing change-history default settings, at bucket-creation time, see xref:rest-api:rest-bucket-create.adoc[Creating and Editing Buckets].
For information on switching on or off _deduplication_ of the change-record for a specific collection, see xref:rest-api:creating-a-collection.adoc[Creating and Editing a Collection].
To examine the deduplication status for each collection in a bucket, see the xref:cli:cbstats/cbstats-collections.adoc[collections] option for `cbstats`.
